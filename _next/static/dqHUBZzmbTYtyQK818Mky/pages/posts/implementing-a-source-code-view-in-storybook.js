(window.webpackJsonp=window.webpackJsonp||[]).push([[40],{"9O3/":function(e,a,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/posts/implementing-a-source-code-view-in-storybook",function(){var e=t("mYAs");return{page:e.default||e}}])},mYAs:function(e,a,t){"use strict";t.r(a);var l=t("q1tI"),n=t.n(l),s=t("JRaF"),r=(t("YFqc"),{url:"implementing-a-source-code-view-in-storybook",id:"storybooksource",type:"post",title:"Implementing a source code view in Storybook",date:"2019-08-17",tags:["storybook","react","case study"],author:"david",excerpt:"Exploring how to add a source code viewer to a Storybook setup",folder:"/Users/davidwaller/gitreps/mine/blog2/sources/2019-08-17_storybook_source",hasStaticContent:!0,headlines:[{level:3,text:"Premise",id:"premise"},{level:3,text:"Gearing up",id:"gearing-up"},{level:3,text:"Reading the source code",id:"reading-the-source-code"},{level:3,text:"Providing the source",id:"providing-the-source"},{level:3,text:"Adding the source code tab",id:"adding-the-source-code-tab"},{level:3,text:"Showing the source code",id:"showing-the-source-code"},{level:3,text:"Switching source file on story change",id:"switching-source-file-on-story-change"},{level:3,text:"Making import links clickable",id:"making-import-links-clickable"},{level:3,text:"Including source code for test files",id:"including-source-code-for-test-files"},{level:3,text:"Showing both uncompiled and compiled source",id:"showing-both-uncompiled-and-compiled-source"},{level:3,text:"Wrapping up",id:"wrapping-up"}]});a.default=function(){return n.a.createElement(s.a,{kind:"post",data:r,title:"Implementing a source code view in Storybook",summary:"Exploring how to add a source code viewer to a Storybook setup",headlines:[{level:3,text:"Premise",id:"premise"},{level:3,text:"Gearing up",id:"gearing-up"},{level:3,text:"Reading the source code",id:"reading-the-source-code"},{level:3,text:"Providing the source",id:"providing-the-source"},{level:3,text:"Adding the source code tab",id:"adding-the-source-code-tab"},{level:3,text:"Showing the source code",id:"showing-the-source-code"},{level:3,text:"Switching source file on story change",id:"switching-source-file-on-story-change"},{level:3,text:"Making import links clickable",id:"making-import-links-clickable"},{level:3,text:"Including source code for test files",id:"including-source-code-for-test-files"},{level:3,text:"Showing both uncompiled and compiled source",id:"showing-both-uncompiled-and-compiled-source"},{level:3,text:"Wrapping up",id:"wrapping-up"}],tags:["storybook","react","case study"]},n.a.createElement("div",{className:"post","data-postid":"storybooksource"},n.a.createElement("h3",{id:"premise"},"Premise"),n.a.createElement("p",null,"It took me a while to realise, but - ",n.a.createElement("a",{href:"https://storybook.js.org/"},"Storybook")," is super awesome! At first I thought it's just a tool to display a library of UI components, which it also is, but that's not the real value. Storybook lets you test run components in isolation as you build them, and thereby also encourage you to develop them in a decoupled way."),n.a.createElement("p",null,"When teaching ",n.a.createElement("a",{href:"https://edument.se/en/education/courses/query?q=react&category=&location="},"Edument's React courses")," I have a collection of small demos to show off React's various features. They lived in a homebrewed platform that had some nice feautes, but now I thought - why not serve them in a Storybook?"),n.a.createElement("p",null,"So I did, and it was glorious. But, there was one feature from my old platform that Storybook didn't have; I couldn't show the source code next to the running demo. There is an ",n.a.createElement("a",{href:"https://github.com/storybookjs/storybook/tree/master/addons/storysource"},"addon to show the source of the story itself"),", but that's not nearly enough - I need to show the code for the component that they import!"),n.a.createElement("p",null,"Since the source view was a very appreciated feature, I went ahead and built it into my Storybook. This post walks through how this was done!"),n.a.createElement("p",null,n.a.createElement("img",{src:"/static/posts/implementing-a-source-code-view-in-storybook/sourceview.gif",alt:"The end result"})),n.a.createElement("p",null,"Our Storybook is deployed live at ",n.a.createElement("a",{href:"https://edument-react-examples.netlify.com/"},"https://edument-react-examples.netlify.com/"),", and the repo is at ",n.a.createElement("a",{href:"https://github.com/edumentab/react-examples-storybook"},"https://github.com/edumentab/react-examples-storybook"),"."),n.a.createElement("h3",{id:"gearing-up"},"Gearing up"),n.a.createElement("p",null,"Remember that ",n.a.createElement("a",{href:"https://xkcd.com/208/"},"classic XKCD strip")," about saving the day with regular expressions?"),n.a.createElement("p",null,n.a.createElement("img",{src:"/static/posts/implementing-a-source-code-view-in-storybook/xkcd.png",alt:"except not PERL"})),n.a.createElement("p",null,'As a curious nerd - and expecially one with an academic background - I frequently find myself deep down rabbit holes with a vague awareness that "ok, this is super neat, but I\'ll never get to use it".'),n.a.createElement("p",null,"One such rabbit hole was exploring how Webpack ",n.a.createElement("a",{href:"https://webpack.js.org/contribute/writing-a-loader/"},"loaders")," and ",n.a.createElement("a",{href:"https://webpack.js.org/contribute/writing-a-plugin/"},"plugins")," actually work. But, lo and behold, now I found use for them!"),n.a.createElement("h3",{id:"reading-the-source-code"},"Reading the source code"),n.a.createElement("p",null,"My idea was very simple - hack Storybook's webpack setup with a loader that simply ",n.a.createElement("strong",null,"saves the source code to somewhere")," as the files are read."),n.a.createElement("p",null,"However, we don't want to have ",n.a.createElement("em",null,"all files"),", for example everything in ",n.a.createElement("code",null,"node_modules")," should be excluded. So I simply pass in a ",n.a.createElement("code",null,"root")," source to the loader in the Storybook webpack config..."),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},"config.module.rules.push({",n.a.createElement("br",null),"  ",n.a.createElement("span",{className:"hljs-attr"},"test"),": ",n.a.createElement("span",{className:"hljs-regexp"},"/\\.jsx?$|\\.css$/"),",",n.a.createElement("br",null),"  ",n.a.createElement("span",{className:"hljs-attr"},"use"),": [",n.a.createElement("br",null),"    {",n.a.createElement("br",null),"      ",n.a.createElement("span",{className:"hljs-attr"},"loader"),": path.resolve(__dirname, ",n.a.createElement("span",{className:"hljs-string"},'"sourceCodeUtils/sourceLoader.js"'),"),",n.a.createElement("br",null),"      ",n.a.createElement("span",{className:"hljs-attr"},"options"),": { ",n.a.createElement("span",{className:"hljs-attr"},"root"),": path.resolve(__dirname, ",n.a.createElement("span",{className:"hljs-string"},'"../src"'),") }",n.a.createElement("br",null),"    }",n.a.createElement("br",null),"  ]",n.a.createElement("br",null),"});")),n.a.createElement("p",null,"...which the loader then uses to know what to remember:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function")," ",n.a.createElement("span",{className:"hljs-title"},"sourceLoader"),"(",n.a.createElement("span",{className:"hljs-params"},"source"),") "),"{",n.a.createElement("br",null),"  ",n.a.createElement("span",{className:"hljs-keyword"},"const")," opts = ",n.a.createElement("span",{className:"hljs-keyword"},"this"),".query || {};",n.a.createElement("br",null),"  ",n.a.createElement("span",{className:"hljs-keyword"},"const")," { root = ",n.a.createElement("span",{className:"hljs-string"},'""')," } = opts;",n.a.createElement("br",null),"  ",n.a.createElement("span",{className:"hljs-keyword"},"const")," path = ",n.a.createElement("span",{className:"hljs-keyword"},"this"),".resourcePath;",n.a.createElement("br",null),"  ",n.a.createElement("span",{className:"hljs-keyword"},"if")," (path.match(root)) {",n.a.createElement("br",null),"    cache.register(path.substr(root.length).replace(",n.a.createElement("span",{className:"hljs-regexp"},"/^\\//"),", ",n.a.createElement("span",{className:"hljs-string"},'""'),"), source);",n.a.createElement("br",null),"  }",n.a.createElement("br",null),"  ",n.a.createElement("span",{className:"hljs-keyword"},"return")," source;",n.a.createElement("br",null),"}")),n.a.createElement("p",null,"Now my cache (which is just a super-simple in-memory object) will contain the source of all files I'm interested in!"),n.a.createElement("h3",{id:"providing-the-source"},"Providing the source"),n.a.createElement("p",null,"Now we need to catch the sources saved by the loader! That is done in a ",n.a.createElement("strong",null,"webpack plugin"),":"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-class"},n.a.createElement("span",{className:"hljs-keyword"},"class")," ",n.a.createElement("span",{className:"hljs-title"},"SourcePlugin")," "),"{",n.a.createElement("br",null),"  apply(compiler) {",n.a.createElement("br",null),"    compiler.hooks.emit.tapAsync(",n.a.createElement("br",null),"      ",n.a.createElement("span",{className:"hljs-string"},'"Source Code Plugin"'),",",n.a.createElement("br",null),"      (compilation, callback) => {",n.a.createElement("br",null),"        ",n.a.createElement("span",{className:"hljs-keyword"},"const")," sources = ",n.a.createElement("span",{className:"hljs-built_in"},"JSON"),".stringify(cache.getSources());",n.a.createElement("br",null),"        compilation.assets[",n.a.createElement("span",{className:"hljs-string"},'"rawSources.json"'),"] = {",n.a.createElement("br",null),"          ",n.a.createElement("span",{className:"hljs-attr"},"source"),": ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-params"},"()")," =>")," sources,",n.a.createElement("br",null),"          ",n.a.createElement("span",{className:"hljs-attr"},"size"),": ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-params"},"()")," =>")," sources.length",n.a.createElement("br",null),"        };",n.a.createElement("br",null),"        callback();",n.a.createElement("br",null),"      }",n.a.createElement("br",null),"    );",n.a.createElement("br",null),"  }",n.a.createElement("br",null),"}")),n.a.createElement("p",null,"From my cache I'll get an object with filenames as keys and source codes as values. I simply take that object and inject it into the assets as ",n.a.createElement("code",null,"rawSources.json"),"."),n.a.createElement("h3",{id:"adding-the-source-code-tab"},"Adding the source code tab"),n.a.createElement("p",null,'Next up is adding a "tab" in Storybook to display the source! This is done through the Storybook addon API:'),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-comment"},"// Called from the `addons.js` setup file"),n.a.createElement("br",null),"addonAPI.register(",n.a.createElement("span",{className:"hljs-string"},'"edumentab/sourcecode"'),", storybookAPI => {",n.a.createElement("br",null),"  ",n.a.createElement("span",{className:"hljs-keyword"},"const")," channel = addonAPI.getChannel();",n.a.createElement("br",null),n.a.createElement("br",null),"  ",n.a.createElement("span",{className:"hljs-comment"},"// making the source code available"),n.a.createElement("br",null),"  fetch(",n.a.createElement("span",{className:"hljs-string"},'"./rawSources.json"'),")",n.a.createElement("br",null),"    .then(",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-params"},"response")," =>")," response.json())",n.a.createElement("br",null),"    .then(",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-params"},"data")," =>")," channel.emit(",n.a.createElement("span",{className:"hljs-string"},'"sourceCode/rawSources"'),", data));",n.a.createElement("br",null),n.a.createElement("br",null),"  ",n.a.createElement("span",{className:"hljs-comment"},"// adding the tab with the sourcecode"),n.a.createElement("br",null),"  addonAPI.add(",n.a.createElement("span",{className:"hljs-string"},'"edumentab/sourcecode/panel"'),", {",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-attr"},"type"),": types.TAB,",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-attr"},"title"),": ",n.a.createElement("span",{className:"hljs-string"},'"source"'),",",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-attr"},"route"),": ",n.a.createElement("span",{className:"hljs-function"},"(",n.a.createElement("span",{className:"hljs-params"},"{ storyId }"),") =>")," ",n.a.createElement("span",{className:"hljs-string"},"`/sourceCode/",n.a.createElement("span",{className:"hljs-subst"},"${storyId}"),"`"),",",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-attr"},"match"),": ",n.a.createElement("span",{className:"hljs-function"},"(",n.a.createElement("span",{className:"hljs-params"},"{ viewMode }"),") =>")," viewMode === ",n.a.createElement("span",{className:"hljs-string"},'"sourceCode"'),",",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-attr"},"render"),": ",n.a.createElement("span",{className:"hljs-function"},"(",n.a.createElement("span",{className:"hljs-params"},"{ active }"),") =>")," {",n.a.createElement("br",null),"      ",n.a.createElement("span",{className:"hljs-keyword"},"return")," React.createElement(SourcePanel, {",n.a.createElement("br",null),"        ",n.a.createElement("span",{className:"hljs-attr"},"channel"),": addonAPI.getChannel(),",n.a.createElement("br",null),"        storybookAPI,",n.a.createElement("br",null),"        active",n.a.createElement("br",null),"      });",n.a.createElement("br",null),"    }",n.a.createElement("br",null),"  });",n.a.createElement("br",null),"});")),n.a.createElement("p",null,"The ",n.a.createElement("code",null,"SourcePanel")," component receives the addons ",n.a.createElement("code",null,"channel"),", from which the sources will be emitted when ",n.a.createElement("code",null,"rawSources.json")," has been fetched."),n.a.createElement("h3",{id:"showing-the-source-code"},"Showing the source code"),n.a.createElement("p",null,"Inside the ",n.a.createElement("code",null,"SourcePanel")," React component we catch the emission from ",n.a.createElement("code",null,"channel"),", and let the user select which file to view with a dropdown!"),n.a.createElement("p",null,"That means we have two pieces of local state:"),n.a.createElement("ul",null,n.a.createElement("li",null,"The source files, updated through a subscription on ",n.a.createElement("code",null,"channel")," created in a ",n.a.createElement("code",null,"useEffect")," call"),n.a.createElement("li",null,"What file is currently selected")),n.a.createElement("p",null,"And we render just two things:"),n.a.createElement("ul",null,n.a.createElement("li",null,"A ",n.a.createElement("code",null,"<select>")," dropdown to select the file"),n.a.createElement("li",null,"A ",n.a.createElement("code",null,"<Highlighter>")," component to show the current file, using the excellent ",n.a.createElement("a",{href:"https://github.com/conorhastings/react-syntax-highlighter#readme"},"'react-syntax-highlighter'")," package.")),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-keyword"},"const")," SourceCodePanel = ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-params"},"props")," =>")," {",n.a.createElement("br",null),"  ",n.a.createElement("span",{className:"hljs-keyword"},"const")," { channel, storybookAPI } = props;",n.a.createElement("br",null),"  ",n.a.createElement("span",{className:"hljs-keyword"},"const")," [filePath, setFilePath] = useState(",n.a.createElement("span",{className:"hljs-literal"},"null"),");",n.a.createElement("br",null),"  ",n.a.createElement("span",{className:"hljs-keyword"},"const")," [rawSources, setRawSources] = useState(",n.a.createElement("span",{className:"hljs-literal"},"null"),");",n.a.createElement("br",null),"  ",n.a.createElement("span",{className:"hljs-keyword"},"const")," handleDropdownChange = ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-params"},"e")," =>")," setFilePath(e.target.value);",n.a.createElement("br",null),"  useEffect(",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-params"},"()")," =>")," {",n.a.createElement("br",null),"    channel.on(",n.a.createElement("span",{className:"hljs-string"},'"sourceCode/rawSources"'),", setRawSources);",n.a.createElement("br",null),"  });",n.a.createElement("br",null),"  ",n.a.createElement("span",{className:"hljs-keyword"},"if")," (!props.active) ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ",n.a.createElement("span",{className:"hljs-literal"},"null"),";",n.a.createElement("br",null),"  ",n.a.createElement("span",{className:"hljs-keyword"},"if")," (!rawSources) ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ",n.a.createElement("span",{className:"xml"},n.a.createElement("span",{className:"hljs-tag"},"<",n.a.createElement("span",{className:"hljs-name"},"span"),">"),"...loading...",n.a.createElement("span",{className:"hljs-tag"},"</",n.a.createElement("span",{className:"hljs-name"},"span"),">")),";",n.a.createElement("br",null),"  ",n.a.createElement("span",{className:"hljs-keyword"},"return")," (",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"xml"},n.a.createElement("span",{className:"hljs-tag"},"<",n.a.createElement("span",{className:"hljs-name"},"Fragment"),">"),n.a.createElement("br",null),"      ",n.a.createElement("span",{className:"hljs-tag"},"<",n.a.createElement("span",{className:"hljs-name"},"select")," ",n.a.createElement("span",{className:"hljs-attr"},"onChange"),"=",n.a.createElement("span",{className:"hljs-string"},"{handleDropdownChange}")," ",n.a.createElement("span",{className:"hljs-attr"},"value"),"=",n.a.createElement("span",{className:"hljs-string"},"{filePath}"),">"),n.a.createElement("br",null),"        ",n.a.createElement("span",{className:"hljs-tag"},"<",n.a.createElement("span",{className:"hljs-name"},"option"),">")," ---- Select a file ---",n.a.createElement("span",{className:"hljs-tag"},"</",n.a.createElement("span",{className:"hljs-name"},"option"),">"),n.a.createElement("br",null),"        {files.map(file => (",n.a.createElement("br",null),"          ",n.a.createElement("span",{className:"hljs-tag"},"<",n.a.createElement("span",{className:"hljs-name"},"option")," ",n.a.createElement("span",{className:"hljs-attr"},"value"),"=",n.a.createElement("span",{className:"hljs-string"},"{file}")," ",n.a.createElement("span",{className:"hljs-attr"},"key"),"=",n.a.createElement("span",{className:"hljs-string"},"{file}"),">"),n.a.createElement("br",null),"            {file}",n.a.createElement("br",null),"          ",n.a.createElement("span",{className:"hljs-tag"},"</",n.a.createElement("span",{className:"hljs-name"},"option"),">"),n.a.createElement("br",null),"        ))}",n.a.createElement("br",null),"      ",n.a.createElement("span",{className:"hljs-tag"},"</",n.a.createElement("span",{className:"hljs-name"},"select"),">"),n.a.createElement("br",null),"      ",n.a.createElement("span",{className:"hljs-tag"},"<",n.a.createElement("span",{className:"hljs-name"},"Highlighter"),n.a.createElement("br",null),"        ",n.a.createElement("span",{className:"hljs-attr"},"language"),"=",n.a.createElement("span",{className:"hljs-string"},"{filePath.match(/.css$/)"),' ? "',n.a.createElement("span",{className:"hljs-attr"},"css"),'" ',n.a.createElement("span",{className:"hljs-attr"},":"),' "',n.a.createElement("span",{className:"hljs-attr"},"javascript"),'"}',n.a.createElement("br",null),"        ",n.a.createElement("span",{className:"hljs-attr"},"code"),"=",n.a.createElement("span",{className:"hljs-string"},"{rawSources[filePath]}"),n.a.createElement("br",null),"        ",n.a.createElement("span",{className:"hljs-attr"},"onLinkClick"),"=",n.a.createElement("span",{className:"hljs-string"},"{handleLinkClick}"),n.a.createElement("br",null),"      />"),n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-tag"},"</",n.a.createElement("span",{className:"hljs-name"},"Fragment"),">"),n.a.createElement("br",null),"  );",n.a.createElement("br",null),"};"))),n.a.createElement("h3",{id:"switching-source-file-on-story-change"},"Switching source file on story change"),n.a.createElement("p",null,"This is already rather neat! But, as a user, I expect the source tab to reflect the story that I'm currently viewing. In other words, we need to change source file whenever a story is changed."),n.a.createElement("p",null,"There is of course a central event for story change available, but that turned out to be insufficient since it doesn't contain the name of the source file! Thus we don't know which file to switch to."),n.a.createElement("p",null,"My solution was to make a second storybook addon - a decorator that simply emits the story file info upon selection:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-keyword"},"import")," addons, { makeDecorator } ",n.a.createElement("span",{className:"hljs-keyword"},"from")," ",n.a.createElement("span",{className:"hljs-string"},'"@storybook/addons"'),";",n.a.createElement("br",null),n.a.createElement("br",null),n.a.createElement("span",{className:"hljs-keyword"},"export")," ",n.a.createElement("span",{className:"hljs-keyword"},"const")," emitSourcePathDecorator = makeDecorator({",n.a.createElement("br",null),"  ",n.a.createElement("span",{className:"hljs-attr"},"name"),": ",n.a.createElement("span",{className:"hljs-string"},'"withSourceInfo"'),",",n.a.createElement("br",null),"  ",n.a.createElement("span",{className:"hljs-attr"},"parameterName"),": ",n.a.createElement("span",{className:"hljs-string"},'"sourceCode"'),",",n.a.createElement("br",null),"  ",n.a.createElement("span",{className:"hljs-attr"},"wrapper"),": ",n.a.createElement("span",{className:"hljs-function"},"(",n.a.createElement("span",{className:"hljs-params"},"getStory, context, { parameters }"),") =>")," {",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-keyword"},"const")," channel = addons.getChannel();",n.a.createElement("br",null),"    channel.emit(",n.a.createElement("span",{className:"hljs-string"},'"sourceCode/selectedStory"'),", context.parameters.fileName);",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-keyword"},"return")," getStory(context);",n.a.createElement("br",null),"  }",n.a.createElement("br",null),"});")),n.a.createElement("p",null,"In our central Storybook ",n.a.createElement("code",null,"config.js")," we make sure this decorator is applied to every story:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-keyword"},"import")," { configure, addDecorator } ",n.a.createElement("span",{className:"hljs-keyword"},"from")," ",n.a.createElement("span",{className:"hljs-string"},'"@storybook/react"'),";",n.a.createElement("br",null),n.a.createElement("span",{className:"hljs-keyword"},"import")," { withKnobs } ",n.a.createElement("span",{className:"hljs-keyword"},"from")," ",n.a.createElement("span",{className:"hljs-string"},'"@storybook/addon-knobs"'),";",n.a.createElement("br",null),n.a.createElement("span",{className:"hljs-keyword"},"import")," emitSourcePathDecorator ",n.a.createElement("span",{className:"hljs-keyword"},"from")," ",n.a.createElement("span",{className:"hljs-string"},'"./sourceCodeUtils/emitSourcePathDecorator"'),";",n.a.createElement("br",null),n.a.createElement("br",null),n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function")," ",n.a.createElement("span",{className:"hljs-title"},"loadStories"),"(",n.a.createElement("span",{className:"hljs-params"}),") "),"{",n.a.createElement("br",null),"  ",n.a.createElement("span",{className:"hljs-keyword"},"const")," req = ",n.a.createElement("span",{className:"hljs-built_in"},"require"),".context(",n.a.createElement("span",{className:"hljs-string"},'"../src"'),", ",n.a.createElement("span",{className:"hljs-literal"},"true"),", /\\.stories\\.jsx$/);",n.a.createElement("br",null),"  addDecorator(withKnobs);",n.a.createElement("br",null),"  addDecorator(emitSourcePathDecorator); ",n.a.createElement("span",{className:"hljs-comment"},"// <-- our filePath addon"),n.a.createElement("br",null),"  req.keys().forEach(",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-params"},"filename")," =>")," req(filename));",n.a.createElement("br",null),"}",n.a.createElement("br",null),n.a.createElement("br",null),"configure(loadStories, ",n.a.createElement("span",{className:"hljs-built_in"},"module"),");")),n.a.createElement("p",null,"Finally, in our panel, we add another ",n.a.createElement("code",null,"useEffect")," that subscribes to the filepath event:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},"useEffect(",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-params"},"()")," =>")," {",n.a.createElement("br",null),"  channel.on(",n.a.createElement("span",{className:"hljs-string"},'"sourceCode/selectedStory"'),", path => {",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-keyword"},"if")," (rawSources) {",n.a.createElement("br",null),"      ",n.a.createElement("span",{className:"hljs-keyword"},"const")," file = matchPathToSource(path);",n.a.createElement("br",null),"      ",n.a.createElement("span",{className:"hljs-keyword"},"if")," (file) {",n.a.createElement("br",null),"        setFilePath(file);",n.a.createElement("br",null),"      }",n.a.createElement("br",null),"    }",n.a.createElement("br",null),"  });",n.a.createElement("br",null),"  ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-params"},"()")," =>")," channel.removeListener(",n.a.createElement("span",{className:"hljs-string"},'"sourceCode/selectedStory"'),");",n.a.createElement("br",null),"}, [rawSources]);")),n.a.createElement("p",null,"The ",n.a.createElement("code",null,"matchPathToSource")," function is a simple helper that finds the corresponding key in the ",n.a.createElement("code",null,"rawSources")," object, if any."),n.a.createElement("h3",{id:"making-import-links-clickable"},"Making import links clickable"),n.a.createElement("p",null,"A really neat feature that you might have noticed in the GIF up top is that we can also change selected source file by clicking an import statement!"),n.a.createElement("p",null,"This was rather easy to add thanks to the excellent hackability of the ",n.a.createElement("code",null,"react-syntax-highlighter")," package."),n.a.createElement("p",null,"I first made a ",n.a.createElement("code",null,"mapChild")," function that would receive all nodes in the source code output. The function will identify all import paths and expose their links as a ",n.a.createElement("code",null,"data-link")," attribute."),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-keyword"},"const")," matchRelPath = ",n.a.createElement("span",{className:"hljs-regexp"},"/^[\"']\\..*['\"]/"),";",n.a.createElement("br",null),n.a.createElement("br",null),n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function")," ",n.a.createElement("span",{className:"hljs-title"},"mapChild"),"(",n.a.createElement("span",{className:"hljs-params"},"node, i, row"),") "),"{",n.a.createElement("br",null),"  ",n.a.createElement("span",{className:"hljs-keyword"},"const")," extraProps = {};",n.a.createElement("br",null),"  ",n.a.createElement("span",{className:"hljs-keyword"},"if")," (i > ",n.a.createElement("span",{className:"hljs-number"},"3"),") {",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-keyword"},"const")," content = ((node.children || [])[",n.a.createElement("span",{className:"hljs-number"},"0"),"] || {}).value || ",n.a.createElement("span",{className:"hljs-string"},'""'),";",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-keyword"},"if")," (",n.a.createElement("br",null),"      ",n.a.createElement("span",{className:"hljs-comment"},"// text content looks like a relative path"),n.a.createElement("br",null),"      content.match(matchRelPath) &&",n.a.createElement("br",null),"      ",n.a.createElement("span",{className:"hljs-comment"},"// prior node is a space"),n.a.createElement("br",null),"      ((row[i - ",n.a.createElement("span",{className:"hljs-number"},"1"),"].children || [])[",n.a.createElement("span",{className:"hljs-number"},"0"),"] || {}).value === ",n.a.createElement("span",{className:"hljs-string"},'" "')," &&",n.a.createElement("br",null),"      ",n.a.createElement("span",{className:"hljs-comment"},"// node 2 steps down is a `from` keyword"),n.a.createElement("br",null),"      ((row[i - ",n.a.createElement("span",{className:"hljs-number"},"2"),"].children || [])[",n.a.createElement("span",{className:"hljs-number"},"0"),"] || {}).value === ",n.a.createElement("span",{className:"hljs-string"},'"from"'),n.a.createElement("br",null),"    ) {",n.a.createElement("br",null),"      ",n.a.createElement("span",{className:"hljs-keyword"},"return")," {",n.a.createElement("br",null),"        ...node,",n.a.createElement("br",null),"        ",n.a.createElement("span",{className:"hljs-attr"},"properties"),": {",n.a.createElement("br",null),"          ...node.properties,",n.a.createElement("br",null),"          ",n.a.createElement("span",{className:"hljs-comment"},"// expose the link path as an attribute so we can easily find it"),n.a.createElement("br",null),"          ",n.a.createElement("span",{className:"hljs-string"},'"data-link"'),": content.replace(",n.a.createElement("span",{className:"hljs-regexp"},"/^['\"]|['\"]$/g"),", ",n.a.createElement("span",{className:"hljs-string"},'""'),")",n.a.createElement("br",null),"        }",n.a.createElement("br",null),"      };",n.a.createElement("br",null),"    }",n.a.createElement("br",null),"  }",n.a.createElement("br",null),"  ",n.a.createElement("span",{className:"hljs-keyword"},"return")," node;",n.a.createElement("br",null),"}")),n.a.createElement("p",null,"We then use that function in a custom renderer that we pass to ",n.a.createElement("code",null,"SyntaxHighlighter"),":"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},"<div className=",n.a.createElement("span",{className:"hljs-string"},'"source-code"')," onClick={handleLinkClick}>",n.a.createElement("br",null),"  ",n.a.createElement("span",{className:"xml"},n.a.createElement("span",{className:"hljs-tag"},"<",n.a.createElement("span",{className:"hljs-name"},"SyntaxHighlighter"),n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-attr"},"style"),"=",n.a.createElement("span",{className:"hljs-string"},"{prism}"),n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-attr"},"language"),"=",n.a.createElement("span",{className:"hljs-string"},"{language}"),n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-attr"},"renderer"),"=",n.a.createElement("span",{className:"hljs-string"},"{({")," ",n.a.createElement("span",{className:"hljs-attr"},"rows"),", ",n.a.createElement("span",{className:"hljs-attr"},"stylesheet"),", ",n.a.createElement("span",{className:"hljs-attr"},"useInlineStyles")," }) =>")," {",n.a.createElement("br",null),"      return rows.map((row, i) => {",n.a.createElement("br",null),"        const children = row.children.map(mapChild);",n.a.createElement("br",null),"        const link = children.find(",n.a.createElement("br",null),'          child => (child.properties || {})["data-link"]',n.a.createElement("br",null),"        );",n.a.createElement("br",null),"        return createElement({",n.a.createElement("br",null),"          node: {",n.a.createElement("br",null),"            ...row,",n.a.createElement("br",null),"            properties: {",n.a.createElement("br",null),"              ...row.properties,",n.a.createElement("br",null),"              className: [],",n.a.createElement("br",null),"              ...(link && {",n.a.createElement("br",null),'                "data-link-row": link.properties["data-link"]',n.a.createElement("br",null),"              })",n.a.createElement("br",null),"            },",n.a.createElement("br",null),"            children: row.children.map(mapChild)",n.a.createElement("br",null),"          },",n.a.createElement("br",null),"          stylesheet,",n.a.createElement("br",null),"          useInlineStyles,",n.a.createElement("br",null),"          key: `code-segement${i}`",n.a.createElement("br",null),"        });",n.a.createElement("br",null),"      });",n.a.createElement("br",null),"    }}",n.a.createElement("br",null),"  >",n.a.createElement("br",null),"    {code}",n.a.createElement("br",null),"  ",n.a.createElement("span",{className:"hljs-tag"},"</",n.a.createElement("span",{className:"hljs-name"},"SyntaxHighlighter"),">")),n.a.createElement("br",null),n.a.createElement("span",{className:"xml"},n.a.createElement("span",{className:"hljs-tag"},"</",n.a.createElement("span",{className:"hljs-name"},"div"),">")))),n.a.createElement("p",null,"In the renderer we mark every import statement row with a ",n.a.createElement("code",null,"data-link-row")," attribute (since we want the entire row to be clickable, not just the string with the path)."),n.a.createElement("p",null,"Finally we use that attribute in the ",n.a.createElement("code",null,"handleLinkClick")," click handler that we wrapped the entire source code with:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-keyword"},"const")," handleLinkClick = useCallback(",n.a.createElement("br",null),"  ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-params"},"e")," =>")," {",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-keyword"},"const")," link =",n.a.createElement("br",null),"      e.target.getAttribute(",n.a.createElement("span",{className:"hljs-string"},'"data-link-row"'),") ||",n.a.createElement("br",null),"      e.target.parentNode.getAttribute(",n.a.createElement("span",{className:"hljs-string"},'"data-link-row"'),");",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-keyword"},"if")," (link) {",n.a.createElement("br",null),"      onLinkClick(link);",n.a.createElement("br",null),"    }",n.a.createElement("br",null),"  },",n.a.createElement("br",null),"  [onLinkClick]",n.a.createElement("br",null),");")),n.a.createElement("p",null,"The ",n.a.createElement("code",null,"onLinkCLick")," method here is simply the ",n.a.createElement("code",null,"setFilePath")," method from our Panel, that has been passed down as a prop."),n.a.createElement("h3",{id:"including-source-code-for-test-files"},"Including source code for test files"),n.a.createElement("p",null,"Since all of our React demos have associated unit tests, I wanted to expose those files as well in the source code viewer. But how could I do that? They are not imported by Storybook, which means they never pass through our custom webpack setup!"),n.a.createElement("p",null,"The solution turned out to be very simple! First we edit our central ",n.a.createElement("code",null,"config")," to target both story files and test files:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-keyword"},"const")," req = ",n.a.createElement("span",{className:"hljs-built_in"},"require"),".context(",n.a.createElement("span",{className:"hljs-string"},'"../src"'),", ",n.a.createElement("span",{className:"hljs-literal"},"true"),", /\\.stories\\.jsx$|\\.test\\.jsx?",n.a.createElement("span",{className:"hljs-regexp"},"/);"))),n.a.createElement("p",null,"Then, make sure the test code isn't executed (which would throw errors) by a simple tweak to the return statement in our custom webpack loader:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-keyword"},"return")," path.match(",n.a.createElement("span",{className:"hljs-string"},'".test."'),") ? ",n.a.createElement("span",{className:"hljs-string"},'""')," : source;")),n.a.createElement("p",null,"The test files will still be included in the bundle, but as empty strings that have no effect. And the test files are now available for viewing in our source code panel!"),n.a.createElement("p",null,n.a.createElement("img",{src:"/static/posts/implementing-a-source-code-view-in-storybook/filelist.png",alt:"test files too!"})),n.a.createElement("h3",{id:"showing-both-uncompiled-and-compiled-source"},"Showing both uncompiled and compiled source"),n.a.createElement("p",null,"Another cheap but cute feature we added was a toggle to show the code both before and after the babel compilation:"),n.a.createElement("p",null,n.a.createElement("img",{src:"/static/posts/implementing-a-source-code-view-in-storybook/compiled.gif",alt:""})),n.a.createElement("p",null,"We accomplished this simply by including our custom webpack loader two times, once before and once after the babel loader. The second time we pass a ",n.a.createElement("code",null,"compiled: true")," flag."),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},"config.module.rules.push({",n.a.createElement("br",null),"  ",n.a.createElement("span",{className:"hljs-comment"},"// will run before Babel"),n.a.createElement("br",null),"  test: ",n.a.createElement("span",{className:"hljs-regexp"},"/\\.jsx?$|\\.css$/"),",",n.a.createElement("br",null),"  ",n.a.createElement("span",{className:"hljs-attr"},"use"),": [",n.a.createElement("br",null),"    {",n.a.createElement("br",null),"      ",n.a.createElement("span",{className:"hljs-attr"},"loader"),": path.resolve(__dirname, ",n.a.createElement("span",{className:"hljs-string"},'"sourceCodeUtils/webpackLoader.js"'),"),",n.a.createElement("br",null),"      ",n.a.createElement("span",{className:"hljs-attr"},"options"),": { ",n.a.createElement("span",{className:"hljs-attr"},"root"),": path.resolve(__dirname, ",n.a.createElement("span",{className:"hljs-string"},'"../src"'),") }",n.a.createElement("br",null),"    }",n.a.createElement("br",null),"  ]",n.a.createElement("br",null),"});",n.a.createElement("br",null),"config.module.rules.unshift({",n.a.createElement("br",null),"  ",n.a.createElement("span",{className:"hljs-comment"},"// will run after babel"),n.a.createElement("br",null),"  test: ",n.a.createElement("span",{className:"hljs-regexp"},"/\\.jsx?$|\\.css$/"),",",n.a.createElement("br",null),"  ",n.a.createElement("span",{className:"hljs-attr"},"use"),": [",n.a.createElement("br",null),"    {",n.a.createElement("br",null),"      ",n.a.createElement("span",{className:"hljs-attr"},"loader"),": path.resolve(__dirname, ",n.a.createElement("span",{className:"hljs-string"},'"sourceCodeUtils/webpackLoader.js"'),"),",n.a.createElement("br",null),"      ",n.a.createElement("span",{className:"hljs-attr"},"options"),": {",n.a.createElement("br",null),"        ",n.a.createElement("span",{className:"hljs-attr"},"root"),": path.resolve(__dirname, ",n.a.createElement("span",{className:"hljs-string"},'"../src"'),"),",n.a.createElement("br",null),"        ",n.a.createElement("span",{className:"hljs-attr"},"compiled"),": ",n.a.createElement("span",{className:"hljs-literal"},"true"),n.a.createElement("br",null),"      }",n.a.createElement("br",null),"    }",n.a.createElement("br",null),"  ]",n.a.createElement("br",null),"});")),n.a.createElement("p",null,"The loader passes the ",n.a.createElement("code",null,"compiled")," flag on to the cache..."),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},"cache.register(path.substr(root.length).replace(",n.a.createElement("span",{className:"hljs-regexp"},"/^\\//"),", ",n.a.createElement("span",{className:"hljs-string"},'""'),"), source, compiled);")),n.a.createElement("p",null,"...which now maintains a ",n.a.createElement("code",null,"{ compiled: string, raw: string }")," object per file path."),n.a.createElement("p",null,"In the source code panel we now track a bool for whether we're watching compiled code or not..."),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-keyword"},"const")," [showCompiled, setShowCompiled] = useState(",n.a.createElement("span",{className:"hljs-literal"},"false"),");")),n.a.createElement("p",null,"...which we use to decide what code to pass to the ",n.a.createElement("code",null,"Highlighter"),":"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},"<Highlighter",n.a.createElement("br",null),"  code={(rawSources[filePath] || {})[showCompiled ? ",n.a.createElement("span",{className:"hljs-string"},'"compiled"')," : ",n.a.createElement("span",{className:"hljs-string"},'"raw"'),"] || ",n.a.createElement("span",{className:"hljs-string"},'""'),"}")),n.a.createElement("h3",{id:"wrapping-up"},"Wrapping up"),n.a.createElement("p",null,'We\'ve also implemented a history of viewed files so that you can go "back" to the previous file, hot reloading support, and some other minor features, and there are plans for more still.'),n.a.createElement("p",null,"But this post has now covered the meat of it, which I hope will prove useful in your own Storybook-hacking adventures!"),n.a.createElement("p",null,"Here are the links again:"),n.a.createElement("ul",null,n.a.createElement("li",null,"Live storybook: ",n.a.createElement("a",{href:"https://edument-react-examples.netlify.com/"},"https://edument-react-examples.netlify.com/")),n.a.createElement("li",null,"Git repo: ",n.a.createElement("a",{href:"https://github.com/edumentab/react-examples-storybook"},"https://github.com/edumentab/react-examples-storybook")))),n.a.createElement("hr",null))}}},[["9O3/",1,0]]]);