(window.webpackJsonp=window.webpackJsonp||[]).push([[128],{Ecou:function(e,a,l){"use strict";l.r(a);var t=l("q1tI"),n=l.n(t),s=l("JRaF"),r=l("YFqc"),c=l.n(r),m={url:"callbags-introduction",id:"callbagintro",type:"post",title:"Callbags introduction",date:"2018-02-20",tags:["callbags"],author:"david",excerpt:"Wrapping our brains around the Callbags specification for streams represented by functions",folder:"/Users/davidwaller/gitreps/mine/blog2/sources/2018-02-20_callbagintro",hasStaticContent:!0,headlines:[{level:3,text:"The premise",id:"the-premise"},{level:3,text:"Callbags",id:"callbags"},{level:3,text:"Pushing and pulling",id:"pushing-and-pulling"},{level:3,text:"Sources",id:"sources"},{level:3,text:"Sinks",id:"sinks"},{level:3,text:"Callbag operators",id:"callbag-operators"},{level:3,text:"Wrapping up",id:"wrapping-up"}]};a.default=function(){return n.a.createElement(s.a,{kind:"post",data:m,title:"Callbags introduction",summary:"Wrapping our brains around the Callbags specification for streams represented by functions",headlines:[{level:3,text:"The premise",id:"the-premise"},{level:3,text:"Callbags",id:"callbags"},{level:3,text:"Pushing and pulling",id:"pushing-and-pulling"},{level:3,text:"Sources",id:"sources"},{level:3,text:"Sinks",id:"sinks"},{level:3,text:"Callbag operators",id:"callbag-operators"},{level:3,text:"Wrapping up",id:"wrapping-up"}],tags:["callbags"]},n.a.createElement("div",{className:"post","data-postid":"callbagintro"},n.a.createElement("h3",{id:"the-premise"},"The premise"),n.a.createElement("p",null,"In this post we'll explore ",n.a.createElement("strong",null,"Callbags")," - a new spec by Andr\xe9 Staltz for streams. You're assumed to be familiar with streams in general. If you're not, check out Andr\xe9's excellent ",n.a.createElement("a",{href:"https://gist.github.com/staltz/868e7e9bc2a7b8c1f754"},"guide to reactive programming"),"."),n.a.createElement("p",null,"After familiarising ourselves with callbags in this post, we'll use our newfound knowledge to ",n.a.createElement(c.a,{href:"/posts/dissecting-a-callbag-todomvc-implementation",prefetch:!0},n.a.createElement("a",null,"explore a Callbags TodoMVC example"))," in the next post."),n.a.createElement("h3",{id:"callbags"},"Callbags"),n.a.createElement("p",null,"As mentioned above, ",n.a.createElement("strong",null,"Callbags")," are a spec for streams. It is brilliant in it's simplicity, and allows for streams to be represented by just a simple function!"),n.a.createElement("p",null,"A function is a callbag if it has the signature ",n.a.createElement("code",null,"(t: 0 | 1 | 2, d: any) => void")," and behaves thusly when called:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},"callbag(",n.a.createElement("span",{className:"hljs-number"},"0"),", talkback); ",n.a.createElement("span",{className:"hljs-comment"},"// If this is the initiating call: Hey, I am a listener"),n.a.createElement("br",null),"                      ",n.a.createElement("span",{className:"hljs-comment"},"// and I want data from you! Please call the talkback (which is"),n.a.createElement("br",null),"                      ",n.a.createElement("span",{className:"hljs-comment"},"// a callbag representing me) with an acknowledgement and any"),n.a.createElement("br",null),"                      ",n.a.createElement("span",{className:"hljs-comment"},"// subsequent communication."),n.a.createElement("br",null),n.a.createElement("br",null),"callbag(",n.a.createElement("span",{className:"hljs-number"},"0"),", talkback); ",n.a.createElement("span",{className:"hljs-comment"},"// If it this is a reply: Hello, I am a source, I have"),n.a.createElement("br",null),"                      ",n.a.createElement("span",{className:"hljs-comment"},"// registered your subscription! I will now start pushing data"),n.a.createElement("br",null),"                      ",n.a.createElement("span",{className:"hljs-comment"},"// to you if I am a listenable source, or I will await requests "),n.a.createElement("br",null),"                      ",n.a.createElement("span",{className:"hljs-comment"},"// from you if I am a pullable source. Talk to the talkback"),n.a.createElement("br",null),"                      ",n.a.createElement("span",{className:"hljs-comment"},"// if you want to terminate our relationship or request pullable"),n.a.createElement("br",null),"                      ",n.a.createElement("span",{className:"hljs-comment"},"// data."),n.a.createElement("br",null),n.a.createElement("br",null),"callbag(",n.a.createElement("span",{className:"hljs-number"},"1"),");           ",n.a.createElement("span",{className:"hljs-comment"},"// I assume you are a pullable source! Please send data!"),n.a.createElement("br",null),n.a.createElement("br",null),"callbag(",n.a.createElement("span",{className:"hljs-number"},"1"),", stuff);    ",n.a.createElement("span",{className:"hljs-comment"},"// Here you go listener, here is some data!"),n.a.createElement("br",null),n.a.createElement("br",null),"callbag(",n.a.createElement("span",{className:"hljs-number"},"2"),");           ",n.a.createElement("span",{className:"hljs-comment"},"// I don't want to be friends with you anymore! Please don't"),n.a.createElement("br",null),"                      ",n.a.createElement("span",{className:"hljs-comment"},"// talk to me again! Also I won't talk to you again ever!"),n.a.createElement("br",null),n.a.createElement("br",null),"callbag(",n.a.createElement("span",{className:"hljs-number"},"2"),", stuff);    ",n.a.createElement("span",{className:"hljs-comment"},"// I know you wanted data but something wen't wrong! I won't"),n.a.createElement("br",null),"                      ",n.a.createElement("span",{className:"hljs-comment"},"// send you more data ever!"))),n.a.createElement("p",null,"In other words, the first ",n.a.createElement("code",null,"t")," parameter has the following meanings:"),n.a.createElement("ul",null,n.a.createElement("li",null,n.a.createElement("code",null,"0"),": creating a relationship."),n.a.createElement("li",null,n.a.createElement("code",null,"1"),": requesting information (if ",n.a.createElement("code",null,"d")," is undefined) or sending information"),n.a.createElement("li",null,n.a.createElement("code",null,"2"),": terminating the relationship")),n.a.createElement("p",null,"The initial exchanging of ",n.a.createElement("code",null,"(0, talkback)")," messages is called a ",n.a.createElement("em",null,"handshake"),". We'll never send ",n.a.createElement("code",null,"1")," or ",n.a.createElement("code",null,"2")," before having performed a successful handshake."),n.a.createElement("p",null,"In other words, we'll send ",n.a.createElement("code",null,"0")," to a callbag, but ",n.a.createElement("code",null,"1")," and ",n.a.createElement("code",null,"2")," are only sent to a talkback that was provided via a handshake (but technically the talkback is a callbag too)."),n.a.createElement("p",null,"Another observation: a ",n.a.createElement("em",null,"source")," is simply a callbag who will shake your hand back if you call it with ",n.a.createElement("code",null,"(0, talkback)"),". A ",n.a.createElement("em",null,"sink")," is a callbag who takes the initiative to a handshake."),n.a.createElement("h3",{id:"pushing-and-pulling"},"Pushing and pulling"),n.a.createElement("p",null,"In the callbag world there are two different kinds of sources:"),n.a.createElement("ul",null,n.a.createElement("li",null,"A source is ",n.a.createElement("em",null,"listenable")," if it ",n.a.createElement("em",null,"pushes")," data to the source. The sink just needs to subscribe, and after that the data is sent down along the wire whenever the source deems appropriate."),n.a.createElement("li",null,"It is ",n.a.createElement("em",null,"pullable")," if the source has to ",n.a.createElement("em",null,"pull")," each piece of data from it. Data is only ever sent as a response to a date request.")),n.a.createElement("p",null,"Being able to represent both push and pull with the same spec is one of the main strengths of callbags. Most stream libraries can only do one or the other - for instance, ",n.a.createElement("a",{href:"https://github.com/reactivex/rxjs"},"RxJS"),' is all push ("reactive programming"), while the evil twin ',n.a.createElement("a",{href:"https://github.com/ReactiveX/IxJS"},"IxJS"),' is all pull ("iterative programming").'),n.a.createElement("p",null,"How did Andr\xe9 manage this? Through the realisation that ",n.a.createElement("strong",null,"a pull is simply two pushes"),":"),n.a.createElement("ol",null,n.a.createElement("li",null,"the sink pushes a request message to the pullable (",n.a.createElement("code",null,"pullableTalkback(1)"),")"),n.a.createElement("li",null,"the pullable pushes the response back (",n.a.createElement("code",null,"sinkTalkback(1, data)"),")")),n.a.createElement("p",null,"In other words, you'd never call a listenable source with ",n.a.createElement("code",null,"(1)")," - there's no need, it will send data to you whenever it sees fit."),n.a.createElement("h3",{id:"sources"},"Sources"),n.a.createElement("p",null,"As a first look at a callbag example, here's the source code for Staltz' ",n.a.createElement("a",{href:"https://github.com/staltz/callbag-interval"},"callbag-interval")," which creates a source that emits at an interval:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-keyword"},"const")," interval = ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-params"},"period")," =>")," ",n.a.createElement("span",{className:"hljs-function"},"(",n.a.createElement("span",{className:"hljs-params"},"start, sink"),") =>")," {",n.a.createElement("br",null),"  ",n.a.createElement("span",{className:"hljs-keyword"},"if")," (start !== ",n.a.createElement("span",{className:"hljs-number"},"0"),") ",n.a.createElement("span",{className:"hljs-keyword"},"return"),";",n.a.createElement("br",null),"  ",n.a.createElement("span",{className:"hljs-keyword"},"let")," i = ",n.a.createElement("span",{className:"hljs-number"},"0"),";",n.a.createElement("br",null),"  ",n.a.createElement("span",{className:"hljs-keyword"},"const")," id = setInterval(",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-params"},"()")," =>")," {",n.a.createElement("br",null),"    sink(",n.a.createElement("span",{className:"hljs-number"},"1"),", i++);",n.a.createElement("br",null),"  }, period);",n.a.createElement("br",null),"  sink(",n.a.createElement("span",{className:"hljs-number"},"0"),", t => { ",n.a.createElement("span",{className:"hljs-comment"},"// <--- here we send the talkback to the sink"),n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-keyword"},"if")," (t === ",n.a.createElement("span",{className:"hljs-number"},"2"),") clearInterval(id);",n.a.createElement("br",null),"  });",n.a.createElement("br",null),"};")),n.a.createElement("p",null,"That was an example of a listenable source, since it pushes messages to the listener without it having to request it."),n.a.createElement("p",null,"Why was the signature of the callbag ",n.a.createElement("code",null,"(start, sink)")," and not ",n.a.createElement("code",null,"(t, d)")," in the code? To signify that it only ever expects to be called with ",n.a.createElement("code",null,"0"),". Subsequent calls will be made to the returned talkback."),n.a.createElement("p",null,"Why is the signature of the talkback ",n.a.createElement("code",null,"(t)")," and not ",n.a.createElement("code",null,"(t,d)"),"? Because it only ever expects to be called with ",n.a.createElement("code",null,"(2)"),". Also this is a listenable source so there's no need to send ",n.a.createElement("code",null,"(1)")," data requests, so the parameter could really have been named ",n.a.createElement("code",null,"end")," instead of ",n.a.createElement("code",null,"t"),"."),n.a.createElement("p",null,"An example of the opposite, a pullable source, would be Staltz' ",n.a.createElement("a",{href:"https://github.com/staltz/callbag-from-iter"},"callbag-from-iter")," It creates a source from an array (or other iterable) and then emits the next item in the array whenever asked to. Here's an abbreviated version of the code:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-keyword"},"const")," fromIter = ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-params"},"iter")," =>")," ",n.a.createElement("span",{className:"hljs-function"},"(",n.a.createElement("span",{className:"hljs-params"},"start, sink"),") =>")," {",n.a.createElement("br",null),"  ",n.a.createElement("span",{className:"hljs-keyword"},"if")," (start !== ",n.a.createElement("span",{className:"hljs-number"},"0"),") ",n.a.createElement("span",{className:"hljs-keyword"},"return"),";",n.a.createElement("br",null),"  ",n.a.createElement("span",{className:"hljs-comment"},"/* prepare iterable here */"),n.a.createElement("br",null),"  sink(",n.a.createElement("span",{className:"hljs-number"},"0"),", t => {",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-keyword"},"if")," (t === ",n.a.createElement("span",{className:"hljs-number"},"1"),") {",n.a.createElement("br",null),"      ",n.a.createElement("span",{className:"hljs-comment"},"/* send next item in iterable (unless terminated or pending request) */"),n.a.createElement("br",null),"    }",n.a.createElement("br",null),"  });",n.a.createElement("br",null),"};")),n.a.createElement("p",null,"Note how it only sends data when the sink calls the talkback with ",n.a.createElement("code",null,"(1)"),"."),n.a.createElement("h3",{id:"sinks"},"Sinks"),n.a.createElement("p",null,"Let's also look at Staltz' ",n.a.createElement("a",{href:"https://github.com/staltz/callbag-for-each"},"callbag-for-each")," for an example of a basic ",n.a.createElement("em",null,"sink"),":"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-keyword"},"const")," forEach = ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-params"},"operation")," =>")," ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-params"},"source")," =>")," {",n.a.createElement("br",null),"  ",n.a.createElement("span",{className:"hljs-keyword"},"let")," talkback;",n.a.createElement("br",null),"  source(",n.a.createElement("span",{className:"hljs-number"},"0"),", (t, d) => {",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-keyword"},"if")," (t === ",n.a.createElement("span",{className:"hljs-number"},"0"),") talkback = d;",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-keyword"},"if")," (t === ",n.a.createElement("span",{className:"hljs-number"},"1"),") operation(d);",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-keyword"},"if")," (t === ",n.a.createElement("span",{className:"hljs-number"},"1")," || t === ",n.a.createElement("span",{className:"hljs-number"},"0"),") talkback(",n.a.createElement("span",{className:"hljs-number"},"1"),");",n.a.createElement("br",null),"  });",n.a.createElement("br",null),"};")),n.a.createElement("p",null,"The ",n.a.createElement("code",null,"forEach")," sink performs the given operation on every emission on the connected source. We could use it on the interval source like so:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},"forEach(",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-params"},"v")," =>")," ",n.a.createElement("span",{className:"hljs-built_in"},"console"),".log(v))(interval(",n.a.createElement("span",{className:"hljs-number"},"100"),")); ",n.a.createElement("span",{className:"hljs-comment"},"// 0"),n.a.createElement("br",null),"                                             ",n.a.createElement("span",{className:"hljs-comment"},"// 1"),n.a.createElement("br",null),"                                             ",n.a.createElement("span",{className:"hljs-comment"},"// 2"))),n.a.createElement("p",null,"To more clearly see the flow of stream juggling it is common to use Staltz' ",n.a.createElement("a",{href:"https://github.com/staltz/callbag-pipe"},"callbag-pipe")," utility function. Using that we can rephrase the above to this:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},"pipe(",n.a.createElement("br",null),"  interval(",n.a.createElement("span",{className:"hljs-number"},"100"),"),",n.a.createElement("br",null),"  forEach(",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-params"},"v")," =>")," ",n.a.createElement("span",{className:"hljs-built_in"},"console"),".log(v)) ",n.a.createElement("span",{className:"hljs-comment"},"// 0"),n.a.createElement("br",null),");                             ",n.a.createElement("span",{className:"hljs-comment"},"// 1"),n.a.createElement("br",null),"                               ",n.a.createElement("span",{className:"hljs-comment"},"// 2"))),n.a.createElement("p",null,"The ",n.a.createElement("code",null,"forEach")," sink is clever in that it works with both ",n.a.createElement("code",null,"listenable")," and ",n.a.createElement("code",null,"pullable")," sources. Notice this line in the sink talkback in the code:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs"},"if (",n.a.createElement("span",{className:"hljs-name"},"t")," === ",n.a.createElement("span",{className:"hljs-number"},"1")," || ",n.a.createElement("span",{className:"hljs-literal"},"t")," === ",n.a.createElement("span",{className:"hljs-number"},"0"),") talkback(",n.a.createElement("span",{className:"hljs-number"},"1"),")",n.a.createElement("span",{className:"hljs-comment"},";"))),n.a.createElement("p",null,"This calls the source talkback with a data request after initiation and after each received data. If the source is pullable, this means it will send the next data. If it isn't the request is simply ignored."),n.a.createElement("h3",{id:"callbag-operators"},"Callbag operators"),n.a.createElement("p",null,"An operator is simply a function that takes an argument (or more), returns a function that takes a callbag source which in turn returns a transformed source."),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-typescript"},"(...args: ",n.a.createElement("span",{className:"hljs-built_in"},"Array"),"<",n.a.createElement("span",{className:"hljs-built_in"},"any"),">) => ",n.a.createElement("span",{className:"hljs-function"},"(",n.a.createElement("span",{className:"hljs-params"},"source: Callbag"),") =>")," Callbag;")),n.a.createElement("p",null,"As an example, here's Staltz' ",n.a.createElement("a",{href:"https://github.com/staltz/callbag-map"},"callbag-map"),":"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-keyword"},"const")," map = ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-params"},"f")," =>")," ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-params"},"source")," =>")," ",n.a.createElement("span",{className:"hljs-function"},"(",n.a.createElement("span",{className:"hljs-params"},"start, sink"),") =>")," {",n.a.createElement("br",null),"  ",n.a.createElement("span",{className:"hljs-keyword"},"if")," (start !== ",n.a.createElement("span",{className:"hljs-number"},"0"),") ",n.a.createElement("span",{className:"hljs-keyword"},"return"),";",n.a.createElement("br",null),"  source(",n.a.createElement("span",{className:"hljs-number"},"0"),", (t, d) => {",n.a.createElement("br",null),"    sink(t, t === ",n.a.createElement("span",{className:"hljs-number"},"1")," ? f(d) : d)",n.a.createElement("br",null),"  });",n.a.createElement("br",null),"};")),n.a.createElement("p",null,"This returns a new source that passes each emitted data through the mapping function ",n.a.createElement("code",null,"f"),"."),n.a.createElement("p",null,"We could use that on the previously shown ",n.a.createElement("code",null,"callbag-interval")," like so:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},"pipe(",n.a.createElement("br",null),"  interval(",n.a.createElement("span",{className:"hljs-number"},"100"),"),",n.a.createElement("br",null),"  map(",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-params"},"v")," =>")," ",n.a.createElement("span",{className:"hljs-number"},"2"),"*v),",n.a.createElement("br",null),"  forEach(",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-params"},"v")," =>")," ",n.a.createElement("span",{className:"hljs-built_in"},"console"),".log(v)) ",n.a.createElement("span",{className:"hljs-comment"},"// 0"),n.a.createElement("br",null),");                             ",n.a.createElement("span",{className:"hljs-comment"},"// 2"),n.a.createElement("br",null),"                               ",n.a.createElement("span",{className:"hljs-comment"},"// 4"))),n.a.createElement("p",null,"In other words Callbag code (much like any stream code) is often a chain of sources passing through operators with a sink at the end:"),n.a.createElement("p",null,n.a.createElement("img",{src:"/static/posts/callbags-introduction/diagrams/callbag-chain.svg",alt:""})),n.a.createElement("h3",{id:"wrapping-up"},"Wrapping up"),n.a.createElement("p",null,"Here's the real kicker regarding callbags - there's ",n.a.createElement("em",null,"no core library"),". Working with callbags means working with a bunch of different functions that all follow the spec."),n.a.createElement("p",null,"In my mind the spec that Staltz has created is a remarkable feat. Much like Crockford likes to say he didn't ",n.a.createElement("em",null,"invent")," JSON as much as ",n.a.createElement("em",null,"discover")," it, I feel Staltz can say the exact same thing about callbags. "),n.a.createElement("p",null,"There is already a ",n.a.createElement("a",{href:"https://npms.io/search?q=keywords%3Acallbag"},"significant number of callbag packages")," out there. And if something you need isn't there, it is super easy to roll your own."),n.a.createElement("p",null,"For more in-depth detail about callbags check out the following links:"),n.a.createElement("ul",null,n.a.createElement("li",null,"Staltz' ",n.a.createElement("a",{href:"https://staltz.com/why-we-need-callbags.html"},"blog post introducing callbags")),n.a.createElement("li",null,"The ",n.a.createElement("a",{href:"https://github.com/callbag/callbag"},"callbag spec")),n.a.createElement("li",null,"The ",n.a.createElement("a",{href:"https://github.com/callbag/callbag/blob/master/getting-started.md"},"getting started guide")," hidden in the spec")),n.a.createElement("p",null,"Also, for a more practical exercise, check out the ",n.a.createElement(c.a,{href:"/posts/dissecting-a-callbag-todomvc-implementation",prefetch:!0},n.a.createElement("a",null,"next post"))," where we dissect a TodoMVC app implemented with callbags!")),n.a.createElement("hr",null))}},pUuP:function(e,a,l){(window.__NEXT_P=window.__NEXT_P||[]).push(["/posts/callbags-introduction",function(){var e=l("Ecou");return{page:e.default||e}}])}},[["pUuP",1,0]]]);