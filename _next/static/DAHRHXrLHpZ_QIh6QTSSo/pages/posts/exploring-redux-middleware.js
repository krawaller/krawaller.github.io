(window.webpackJsonp=window.webpackJsonp||[]).push([[138],{"9TpG":function(e,a,t){"use strict";t.r(a);var l=t("q1tI"),n=t.n(l),s=t("JRaF"),r=(t("YFqc"),{url:"exploring-redux-middleware",id:"undefined",type:"post",title:"Exploring Redux middleware",date:"2016-02-17",tags:["redux"],author:"david",excerpt:"Nine simple stand-alone experiments to understand Redux Middlewares",folder:"/Users/davidwaller/gitreps/mine/blog2/sources/2016-02-14-reduxmiddleware",hasStaticContent:!0,headlines:[{level:3,text:"0. The premise",id:"0-the-premise"},{level:3,text:"1. The simplest possible middleware",id:"1-the-simplest-possible-middleware"},{level:3,text:"2. A breadcrumb trail",id:"2-a-breadcrumb-trail"},{level:3,text:"3. Having some fun",id:"3-having-some-fun"},{level:3,text:"4. Snooping at final `next`",id:"4-snooping-at-final-next"},{level:3,text:"5. Snooping at following middleware",id:"5-snooping-at-following-middleware"},{level:3,text:"6. Dispatch return value",id:"6-dispatch-return-value"},{level:3,text:"7. Localstorage getsate",id:"7-localstorage-getsate"},{level:3,text:"8. The injected `dispatch`",id:"8-the-injected-dispatch"},{level:3,text:"9. Redux-thunk",id:"9-reduxthunk"},{level:3,text:"Wrapping up",id:"wrapping-up"}]});a.default=function(){return n.a.createElement(s.a,{kind:"post",data:r,title:"Exploring Redux middleware",summary:"Nine simple stand-alone experiments to understand Redux Middlewares",headlines:[{level:3,text:"0. The premise",id:"0-the-premise"},{level:3,text:"1. The simplest possible middleware",id:"1-the-simplest-possible-middleware"},{level:3,text:"2. A breadcrumb trail",id:"2-a-breadcrumb-trail"},{level:3,text:"3. Having some fun",id:"3-having-some-fun"},{level:3,text:"4. Snooping at final `next`",id:"4-snooping-at-final-next"},{level:3,text:"5. Snooping at following middleware",id:"5-snooping-at-following-middleware"},{level:3,text:"6. Dispatch return value",id:"6-dispatch-return-value"},{level:3,text:"7. Localstorage getsate",id:"7-localstorage-getsate"},{level:3,text:"8. The injected `dispatch`",id:"8-the-injected-dispatch"},{level:3,text:"9. Redux-thunk",id:"9-reduxthunk"},{level:3,text:"Wrapping up",id:"wrapping-up"}],tags:["redux"]},n.a.createElement("div",{className:"post","data-postid":"undefined"},n.a.createElement("h3",{id:"0-the-premise"},"0. The premise"),n.a.createElement("p",null,"This blog post is made up by 9 tiny self-contained experiments aiming to ",n.a.createElement("strong",null,"better our understanding of Redux middlewares"),". You are assumed to be familiar with the basic functionality of Redux. If you're not then ",n.a.createElement("a",{href:"http://redux.js.org/"},"go remedy that immediately"),", and let it be known that I'm severely jealous of you for still having that experience in front of you!"),n.a.createElement("p",null,"Throughout we'll use a ridiculously simple ",n.a.createElement("strong",null,"counter reducer"),", based off of Redux creator Dan Abramov's ",n.a.createElement("a",{href:"https://twitter.com/dan_abramov/status/664135757297295360"},"minimal Redux example"),". It knows only of a single action, ",n.a.createElement("code",null,"INCREMENT"),", and when that is encountered it increases state with the ",n.a.createElement("code",null,"by")," payload (thus the state is not an object but a simple number):"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-keyword"},"var")," reducer = ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"state,action"),")"),"{",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-keyword"},"switch"),"(action.type){",n.a.createElement("br",null),"        ",n.a.createElement("span",{className:"hljs-keyword"},"case")," ",n.a.createElement("span",{className:"hljs-string"},"'INCREMENT'"),": ",n.a.createElement("span",{className:"hljs-keyword"},"return")," (state || ",n.a.createElement("span",{className:"hljs-number"},"0"),") + (action.by || ",n.a.createElement("span",{className:"hljs-number"},"1"),");",n.a.createElement("br",null),"        ",n.a.createElement("span",{className:"hljs-keyword"},"default"),": ",n.a.createElement("span",{className:"hljs-keyword"},"return")," state;",n.a.createElement("br",null),"    }",n.a.createElement("br",null),"}")),n.a.createElement("p",null,"Just to try this out we can create a store with no middlewares:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-keyword"},"var")," store = Redux.createStore(reducer);")),n.a.createElement("p",null,"Assuming a ",n.a.createElement("code",null,"div")," with id ",n.a.createElement("code",null,"app")," we whip up a render function:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-keyword"},"var")," render = ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"}),")"),"{",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-keyword"},"var")," newhtml = ",n.a.createElement("span",{className:"hljs-string"},'"<h2>Clicked "'),"+store.getState()+",n.a.createElement("span",{className:"hljs-string"},'" times.</h2>"'),";",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-built_in"},"document"),".getElementById(",n.a.createElement("span",{className:"hljs-string"},'"app"'),").innerHTML = newhtml;",n.a.createElement("br",null),"}")),n.a.createElement("p",null,"We hook ",n.a.createElement("code",null,"render")," up to run when the store updates, and we also run an initial render:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},"store.subscribe(render);",n.a.createElement("br",null),"render();")),n.a.createElement("p",null,"Finally we set a click event which dispatches an action to the store:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs"},n.a.createElement("span",{className:"hljs-built_in"},"document"),".addEventListener(",n.a.createElement("span",{className:"hljs-string"},"'click'"),", ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"e"),")"),"{",n.a.createElement("br",null),"    store.dispatch({ ",n.a.createElement("span",{className:"hljs-attr"},"type"),": ",n.a.createElement("span",{className:"hljs-string"},"'INCREMENT'"),", ",n.a.createElement("span",{className:"hljs-attr"},"by"),": ",n.a.createElement("span",{className:"hljs-number"},"1")," });",n.a.createElement("br",null),"});")),n.a.createElement("p",null,"Try it out in the iframe below (or standalone ",n.a.createElement("a",{href:"/static/posts/exploring-redux-middleware/applets/reduxmiddleware/experiments/nomiddleware.html"},"here"),")"),n.a.createElement("iframe",{src:"/static/posts/exploring-redux-middleware/applets/reduxmiddleware/experiments/nomiddleware.html",height:"100px",width:"100%"}),n.a.createElement("p",null,"The following experiments will all be slight variations of this little app. Each will have a standalone link to an html document containing the full code, apart from Redux itself. There will be no other dependencies at all."),n.a.createElement("p",null,"I'll also be avoiding ES6 syntax to make it more clear what's going on, as arrow functions and implicit returns tend to muddy the waters a bit."),n.a.createElement("h3",{id:"1-the-simplest-possible-middleware"},"1. The simplest possible middleware"),n.a.createElement("p",null,"A middleware sits on top ",n.a.createElement("code",null,"store.dispatch"),". Each middleware is given a dispatched action object, doing their thing before passing it on to the next middleware in line, until it finally reaches the original ",n.a.createElement("code",null,"store.dispatch")," which will call the reducer."),n.a.createElement("p",null,"To get a sense for what the middleware looks like, check out this simplest possible middleware which does nothing but pass the action along:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-keyword"},"var")," noop = ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"middlewareAPI"),")"),"{",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"next"),")"),"{",n.a.createElement("br",null),"        ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"action"),")"),"{",n.a.createElement("br",null),"            ",n.a.createElement("span",{className:"hljs-keyword"},"return")," next(action);",n.a.createElement("br",null),"        }",n.a.createElement("br",null),"    }",n.a.createElement("br",null),"}")),n.a.createElement("p",null,"The ",n.a.createElement("code",null,"middlewareAPI")," object we're being passed up top contains ",n.a.createElement("code",null,"dispatch")," and ",n.a.createElement("code",null,"getState"),", letting us do all kinds of things should we want to. Here we're only doing what we're supposed to, namely passing the ",n.a.createElement("code",null,"action")," on to the ",n.a.createElement("code",null,"next")," in line, which in this case will be the actual ",n.a.createElement("code",null,"store.dispatch")," since there's no other middleware."),n.a.createElement("p",null,"Just as a sanity check, let's create a store using this useless middleware..."),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-keyword"},"var")," middlewares = Redux.applyMiddleware(noop);",n.a.createElement("br",null),n.a.createElement("span",{className:"hljs-keyword"},"var")," store = Redux.createStore(reducer,middlewares);")),n.a.createElement("p",null,"...and check that it is still functioning exactly like before (standalone ",n.a.createElement("a",{href:"/static/posts/exploring-redux-middleware/applets/reduxmiddleware/experiments/noop.html"},"here"),"):"),n.a.createElement("iframe",{src:"/static/posts/exploring-redux-middleware/applets/reduxmiddleware/experiments/noop.html",height:"100px",width:"100%"}),n.a.createElement("p",null,"Things appear to still be working as they should."),n.a.createElement("h3",{id:"2-a-breadcrumb-trail"},"2. A breadcrumb trail"),n.a.createElement("p",null,"In order to decipher what's going on, let's add a logging mechanism to our app! We add a ",n.a.createElement("code",null,'<div id="log"/>')," to the page, and write to it using this ",n.a.createElement("code",null,"output")," function:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-comment"},"// put stuff into the log"),n.a.createElement("br",null),n.a.createElement("span",{className:"hljs-keyword"},"var")," output = ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"txt"),")"),"{",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-keyword"},"var")," newparagraph = ",n.a.createElement("span",{className:"hljs-built_in"},"document"),".createElement(",n.a.createElement("span",{className:"hljs-string"},'"div"'),");",n.a.createElement("br",null),"    newparagraph.innerHTML = txt;",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-built_in"},"document"),".getElementById(",n.a.createElement("span",{className:"hljs-string"},'"log"'),").appendChild(newparagraph);",n.a.createElement("br",null),"}")),n.a.createElement("p",null,"Now we create a ",n.a.createElement("code",null,"logger")," middleware which uses ",n.a.createElement("code",null,"output")," to spy on what's happening. Actually, let's make a ",n.a.createElement("code",null,"loggerFactory(name)"),", so we can have more than one ",n.a.createElement("code",null,"logger")," with different names and track when the various parts of the middlewares are being called:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-keyword"},"var")," loggerFactory = ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"name"),")"),"{",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"middlewareAPI"),")"),"{",n.a.createElement("br",null),"        output(name+",n.a.createElement("span",{className:"hljs-string"},'": created"'),");",n.a.createElement("br",null),"        ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"next"),")"),"{",n.a.createElement("br",null),"            output(name+",n.a.createElement("span",{className:"hljs-string"},'": middle callback called"'),");",n.a.createElement("br",null),"            ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"action"),")"),"{",n.a.createElement("br",null),"                output(name+",n.a.createElement("span",{className:"hljs-string"},'": inner callback called with action "'),"+",n.a.createElement("span",{className:"hljs-built_in"},"JSON"),".stringify(action));",n.a.createElement("br",null),"                ",n.a.createElement("span",{className:"hljs-keyword"},"var")," ret = next(action);",n.a.createElement("br",null),"                output(name+",n.a.createElement("span",{className:"hljs-string"},'": State after calling next: "'),"+middlewareAPI.getState());",n.a.createElement("br",null),"                ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ret;",n.a.createElement("br",null),"            }",n.a.createElement("br",null),"        }",n.a.createElement("br",null),"    }",n.a.createElement("br",null),"}")),n.a.createElement("p",null,"Note how we use ",n.a.createElement("code",null,"middlewareAPI.getState")," to query the updated state after the ",n.a.createElement("code",null,"next")," call."),n.a.createElement("p",null,"We create a store with two of these loggers:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs"},"var log1 = logger",n.a.createElement("span",{className:"hljs-constructor"},"Factory(",n.a.createElement("span",{className:"hljs-string"},'"log1"'),")"),",",n.a.createElement("br",null),"    log2 = logger",n.a.createElement("span",{className:"hljs-constructor"},"Factory(",n.a.createElement("span",{className:"hljs-string"},'"log2"'),")"),",",n.a.createElement("br",null),"    middlewares = ",n.a.createElement("span",{className:"hljs-module-access"},n.a.createElement("span",{className:"hljs-module"},n.a.createElement("span",{className:"hljs-identifier"},"Redux"),".")),"apply",n.a.createElement("span",{className:"hljs-constructor"},"Middleware(",n.a.createElement("span",{className:"hljs-params"},"log1"),",",n.a.createElement("span",{className:"hljs-params"},"log2"),")"),",",n.a.createElement("br",null),"    store = ",n.a.createElement("span",{className:"hljs-module-access"},n.a.createElement("span",{className:"hljs-module"},n.a.createElement("span",{className:"hljs-identifier"},"Redux"),".")),"create",n.a.createElement("span",{className:"hljs-constructor"},"Store(",n.a.createElement("span",{className:"hljs-params"},"reducer"),",",n.a.createElement("span",{className:"hljs-params"},"middlewares"),")"),";")),n.a.createElement("p",null,"It's a bit spammy, but should give a good sense of what's going on (standalone ",n.a.createElement("a",{href:"/static/posts/exploring-redux-middleware/applets/reduxmiddleware/experiments/logger.html"},"here"),"):"),n.a.createElement("iframe",{src:"/static/posts/exploring-redux-middleware/applets/reduxmiddleware/experiments/logger.html",height:"400px",width:"100%"}),n.a.createElement("p",null,"Matching the spam to the various parts of the middleware, here's what we can deduce:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"middlewareAPI"),")"),"{ ",n.a.createElement("span",{className:"hljs-comment"},"// called at start, left to right"),n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"next"),")"),"{ ",n.a.createElement("span",{className:"hljs-comment"},"// called at start, right to left"),n.a.createElement("br",null),"        ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"action"),")"),"{ ",n.a.createElement("span",{className:"hljs-comment"},"// called per action"),n.a.createElement("br",null),"            ",n.a.createElement("span",{className:"hljs-comment"},"// code before `next` call runs left to right"),n.a.createElement("br",null),"            ",n.a.createElement("span",{className:"hljs-keyword"},"var")," ret = next(action);",n.a.createElement("br",null),"            ",n.a.createElement("span",{className:"hljs-comment"},"// code after next call runs right to left"),n.a.createElement("br",null),"            ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ret;",n.a.createElement("br",null),"        }",n.a.createElement("br",null),"    }",n.a.createElement("br",null),"}")),n.a.createElement("h3",{id:"3-having-some-fun"},"3. Having some fun"),n.a.createElement("p",null,"Just to internalize our findings so far, let's make some silly middlewares that messes about with the ",n.a.createElement("code",null,"next")," call! First we have a ",n.a.createElement("code",null,"deaf")," middleware which will only hear what you say a third of the time:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-keyword"},"var")," deaf = ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"middlewareAPI"),")"),"{",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-keyword"},"var")," i = ",n.a.createElement("span",{className:"hljs-number"},"0"),";",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"next"),")"),"{",n.a.createElement("br",null),"        ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"action"),")"),"{",n.a.createElement("br",null),"            ",n.a.createElement("span",{className:"hljs-keyword"},"if")," (!(i++%",n.a.createElement("span",{className:"hljs-number"},"3"),")) {",n.a.createElement("br",null),"                next(action);",n.a.createElement("br",null),"            }",n.a.createElement("br",null),"        }",n.a.createElement("br",null),"    }",n.a.createElement("br",null),"}")),n.a.createElement("p",null,"Next we have ",n.a.createElement("code",null,"nervous")," who will execute every action twice just to be sure:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-keyword"},"var")," nervous = ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"middlewareAPI"),")"),"{",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"next"),")"),"{",n.a.createElement("br",null),"        ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"action"),")"),"{",n.a.createElement("br",null),"            next(action);",n.a.createElement("br",null),"            next(action);",n.a.createElement("br",null),"        }",n.a.createElement("br",null),"    }",n.a.createElement("br",null),"}")),n.a.createElement("p",null,"Finally there's ",n.a.createElement("code",null,"impatient")," who will set ",n.a.createElement("code",null,".by")," to 5 instead of the default 1:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-keyword"},"var")," impatient = ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"middlewareAPI"),")"),"{",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"next"),")"),"{",n.a.createElement("br",null),"        ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"action"),")"),"{",n.a.createElement("br",null),"            ",n.a.createElement("span",{className:"hljs-comment"},"// it is good form not to mutate action so we make a copy"),n.a.createElement("br",null),"            next(",n.a.createElement("span",{className:"hljs-built_in"},"Object"),".assign({},action,{",n.a.createElement("span",{className:"hljs-attr"},"by"),":",n.a.createElement("span",{className:"hljs-number"},"5"),"}));",n.a.createElement("br",null),"        }",n.a.createElement("br",null),"    }",n.a.createElement("br",null),"}")),n.a.createElement("p",null,"We whip up a store using all three, in the mentioned order:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-keyword"},"var")," middlewares = Redux.applyMiddleware(deaf,nervous,impatient),",n.a.createElement("br",null),"    store = Redux.createStore(reducer,middlewares);")),n.a.createElement("p",null,"The net result should be that only every third click registers, but that click will increase the counter by 2*5 (standalone ",n.a.createElement("a",{href:"/static/posts/exploring-redux-middleware/applets/reduxmiddleware/experiments/havingsomefun.html"},"here"),"):"),n.a.createElement("iframe",{src:"/static/posts/exploring-redux-middleware/applets/reduxmiddleware/experiments/havingsomefun.html",height:"100px",width:"100%"}),n.a.createElement("h3",{id:"4-snooping-at-final-next"},"4. Snooping at final ",n.a.createElement("code",null,"next")),n.a.createElement("p",null,"Since the action eventually ends up with the regular ",n.a.createElement("code",null,"store.dispatch"),", that implies that ",n.a.createElement("code",null,"next")," inside the final middleware ",n.a.createElement("strong",null,"is")," the vanilla ",n.a.createElement("code",null,"store.dispatch"),". Let's see if that holds true! We make a middleware that makes the comparison: "),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-keyword"},"var")," vanilladispatch = Redux.createStore(reducer).dispatch;",n.a.createElement("br",null),n.a.createElement("span",{className:"hljs-keyword"},"var")," snoopForVanilla = ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"middlewareAPI"),")"),"{",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"next"),")"),"{",n.a.createElement("br",null),"        ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"action"),")"),"{",n.a.createElement("br",null),"            ",n.a.createElement("span",{className:"hljs-keyword"},"var")," comparison = (next.toString() === vanilladispatch.toString());",n.a.createElement("br",null),"            output(",n.a.createElement("span",{className:"hljs-string"},'"next === vanilla dispatch? "'),"+comparison);",n.a.createElement("br",null),"            ",n.a.createElement("span",{className:"hljs-keyword"},"return")," next(action);",n.a.createElement("br",null),"        }",n.a.createElement("br",null),"    }",n.a.createElement("br",null),"}")),n.a.createElement("p",null,"Note how we cannot compare references directly since they obviously won't be the same (as we picked ",n.a.createElement("code",null,"dispatch")," from a non-middlewared throwaway store), so we turn them to strings before we check equality."),n.a.createElement("p",null,"Now, let's put it to the test (standalone ",n.a.createElement("a",{href:"/static/posts/exploring-redux-middleware/applets/reduxmiddleware/experiments/snoopvanillanaive.html"},"here"),")!"),n.a.createElement("iframe",{src:"/static/posts/exploring-redux-middleware/applets/reduxmiddleware/experiments/snoopvanillanaive.html",height:"120px",width:"100%"}),n.a.createElement("p",null,"It seems our assumption was correct!"),n.a.createElement("h3",{id:"5-snooping-at-following-middleware"},"5. Snooping at following middleware"),n.a.createElement("p",null,"This raises a question - what is ",n.a.createElement("code",null,"next")," from the perspective of a middleware who ",n.a.createElement("strong",null,"isn't")," last in the chain? Let's revive or old friend the ",n.a.createElement("code",null,"noop")," middleware:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs"},n.a.createElement("span",{className:"hljs-keyword"},"var")," noop = ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),n.a.createElement("span",{className:"hljs-params"},"(middlewareAPI)")),"{",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),n.a.createElement("span",{className:"hljs-params"},"(next)")),"{",n.a.createElement("br",null),"        ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),n.a.createElement("span",{className:"hljs-params"},"(action)")),"{",n.a.createElement("br",null),"            ",n.a.createElement("span",{className:"hljs-keyword"},"return")," next(action);",n.a.createElement("br",null),"        }",n.a.createElement("br",null),"    }",n.a.createElement("br",null),"}")),n.a.createElement("p",null,"If we put it at the end and a snooper before it, what would that snooper actually see? An easy way to test that would be to simply log out ",n.a.createElement("code",null,"next"),", so let's create a snooper doing that:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-keyword"},"var")," snooper = ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"middlewareAPI"),")"),"{",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"next"),")"),"{",n.a.createElement("br",null),"        ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"action"),")"),"{",n.a.createElement("br",null),"            output(",n.a.createElement("span",{className:"hljs-string"},'"snooping at `next`: "'),"+next);",n.a.createElement("br",null),"            ",n.a.createElement("span",{className:"hljs-keyword"},"return")," next(action);",n.a.createElement("br",null),"        }",n.a.createElement("br",null),"    }",n.a.createElement("br",null),"}")),n.a.createElement("p",null,"We put both in a store, taking care to put ",n.a.createElement("code",null,"snooper")," before ",n.a.createElement("code",null,"noop"),":"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-keyword"},"var")," middlewares = Redux.applyMiddleware(snooper,noop),",n.a.createElement("br",null),"    store = Redux.createStore(reducer,middlewares);")),n.a.createElement("p",null,"...and voil\xe0 (standalone ",n.a.createElement("a",{href:"/static/posts/exploring-redux-middleware/applets/reduxmiddleware/experiments/snoopatfriend.html"},"here"),"):"),n.a.createElement("iframe",{src:"/static/posts/exploring-redux-middleware/applets/reduxmiddleware/experiments/snoopatfriend.html",height:"150px",width:"100%"}),n.a.createElement("p",null,"Evidently the inner part of the middleware becomes the ",n.a.createElement("code",null,"next"),". Which makes sense as the inner part is what takes the action as an argument, and it is the action we're feeding to ",n.a.createElement("code",null,"next"),"!"),n.a.createElement("p",null,"Curious what would happen if we put snooper last in the chain? You'd get a facefull of ",n.a.createElement("a",{href:"https://github.com/reactjs/redux/blob/e7295c33776be6199b826817934dadad5d0f9bb1/src/createStore.js#L148-L180"},"Redux source code")," is what, spelling out the entrails of the ",n.a.createElement("code",null,"dispatch")," method. Hack the standalone version and try it!"),n.a.createElement("h3",{id:"6-dispatch-return-value"},"6. Dispatch return value"),n.a.createElement("p",null,"Ok, so the middleware passes the action along by calling the ",n.a.createElement("code",null,"next")," it is given. But why does it return the result of that ",n.a.createElement("code",null,"next")," call? Since the action chain is done through the ",n.a.createElement("code",null,"next")," call, what purpose does that return value serve? "),n.a.createElement("p",null,"A clue might be that the ",n.a.createElement("a",{href:"http://redux.js.org/docs/api/Store.html#dispatch"},"documentation says")," that ",n.a.createElement("code",null,"store.dispatch(action)")," returns the action you passed in. The docs also notes, however, that middlewares can mess with the return value."),n.a.createElement("p",null,"First off, let's just hack the click handler to also output the return from ",n.a.createElement("code",null,"dispatch")," to the log:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs"},n.a.createElement("span",{className:"hljs-built_in"},"document"),".addEventListener(",n.a.createElement("span",{className:"hljs-string"},"'click'"),", ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"e"),")"),"{",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-keyword"},"var")," ret = store.dispatch({ ",n.a.createElement("span",{className:"hljs-attr"},"type"),": ",n.a.createElement("span",{className:"hljs-string"},"'INCREMENT'"),", ",n.a.createElement("span",{className:"hljs-attr"},"by"),": ",n.a.createElement("span",{className:"hljs-number"},"1")," });",n.a.createElement("br",null),"    output(",n.a.createElement("span",{className:"hljs-string"},'"return: "'),"+",n.a.createElement("span",{className:"hljs-built_in"},"JSON"),".stringify(ret));",n.a.createElement("br",null),"});")),n.a.createElement("p",null,"We run this with a no-middleware store (standalone ",n.a.createElement("a",{href:"/static/posts/exploring-redux-middleware/applets/reduxmiddleware/experiments/outputreturn.html"},"here"),"):"),n.a.createElement("iframe",{src:"/static/posts/exploring-redux-middleware/applets/reduxmiddleware/experiments/outputreturn.html",height:"150px",width:"100%"}),n.a.createElement("p",null,"Unsurprisingly it seems the docs told the truth - we simply get the action object back."),n.a.createElement("p",null,"And, also unsurprisingly, if we insert a stupid middleware which returns some bogus crap:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-keyword"},"var")," sillynoop = ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"middlewareAPI"),")"),"{",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"next"),")"),"{",n.a.createElement("br",null),"        ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"action"),")"),"{",n.a.createElement("br",null),"            next(action);",n.a.createElement("br",null),"            ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ",n.a.createElement("span",{className:"hljs-string"},'"WOO!"'),";",n.a.createElement("br",null),"        }",n.a.createElement("br",null),"    }",n.a.createElement("br",null),"}")),n.a.createElement("p",null,"...then bogus crap is what comes out at the end of the chain, even if we put a regular noop before and after:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-comment"},"// setting up the store"),n.a.createElement("br",null),n.a.createElement("span",{className:"hljs-keyword"},"var")," middlewares = Redux.applyMiddleware(noop,sillynoop,noop),",n.a.createElement("br",null),"    store = Redux.createStore(reducer,middlewares);")),n.a.createElement("p",null,"See for yourself (standalone ",n.a.createElement("a",{href:"/static/posts/exploring-redux-middleware/applets/reduxmiddleware/experiments/outputreturnsilly.html"},"here"),"):"),n.a.createElement("iframe",{src:"/static/posts/exploring-redux-middleware/applets/reduxmiddleware/experiments/outputreturnsilly.html",height:"150px",width:"100%"}),n.a.createElement("h3",{id:"7-localstorage-getsate"},"7. Localstorage getsate"),n.a.createElement("p",null,"We've utlized ",n.a.createElement("code",null,"middlewareAPI.getState")," in the ",n.a.createElement("code",null,"logger")," middleware. Here's another quick example of a more practical use; a ",n.a.createElement("code",null,"persist")," middleware which uses ",n.a.createElement("code",null,"middlewareAPI.getState")," to store the whole store state to ",n.a.createElement("code",null,"localStorage")," for every change."),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-keyword"},"var")," persist = ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"middlewareAPI"),")"),"{",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"next"),")"),"{",n.a.createElement("br",null),"        ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function")," ",n.a.createElement("span",{className:"hljs-title"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"action"),")"),"{",n.a.createElement("br",null),"            ",n.a.createElement("span",{className:"hljs-keyword"},"var")," ret = next(action),",n.a.createElement("br",null),"                str = ",n.a.createElement("span",{className:"hljs-built_in"},"JSON"),".stringify({",n.a.createElement("span",{className:"hljs-attr"},"data"),":middlewareAPI.getState()});",n.a.createElement("br",null),"            ",n.a.createElement("span",{className:"hljs-built_in"},"window"),".localStorage.setItem(",n.a.createElement("span",{className:"hljs-string"},'"SAVESTATE"'),",str);",n.a.createElement("br",null),"            ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ret;",n.a.createElement("br",null),"        }",n.a.createElement("br",null),"    }",n.a.createElement("br",null),"}")),n.a.createElement("p",null,"We put this in a store, and seed it with data from localStorage as initial state:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-keyword"},"var")," savedstr = ",n.a.createElement("span",{className:"hljs-built_in"},"window"),".localStorage.getItem(",n.a.createElement("span",{className:"hljs-string"},'"SAVESTATE"'),")||",n.a.createElement("span",{className:"hljs-string"},'"{}"'),",",n.a.createElement("br",null),"    initialstate = ",n.a.createElement("span",{className:"hljs-built_in"},"JSON"),".parse(savedstr).data,",n.a.createElement("br",null),"    middlewares = Redux.applyMiddleware(persist),",n.a.createElement("br",null),"    store = Redux.createStore(reducer,initialstate,middlewares);")),n.a.createElement("p",null,"Give it a few clicks below, then reload the page to watch the counter remember its position (and not at ",n.a.createElement("em",null,"all")," to give me extra page views)."),n.a.createElement("iframe",{src:"/static/posts/exploring-redux-middleware/applets/reduxmiddleware/experiments/persistence.html",height:"100px",width:"100%"}),n.a.createElement("p",null,"Standalone ",n.a.createElement("a",{href:"/static/posts/exploring-redux-middleware/applets/reduxmiddleware/experiments/persistence.html"},"here"),"."),n.a.createElement("h3",{id:"8-the-injected-dispatch"},"8. The injected ",n.a.createElement("code",null,"dispatch")),n.a.createElement("p",null,"We've utlized ",n.a.createElement("code",null,"middlewareAPI.getState")," in the ",n.a.createElement("code",null,"logger")," middleware. The use of it is pretty obvious. But what about the other method on the ",n.a.createElement("code",null,"middlewareAPI"),", namely ",n.a.createElement("code",null,"dispatch"),"? At first glance it doesn't really make sense. To continue the action chain we merely call ",n.a.createElement("code",null,"next"),", as we've seen several times over. Why would we want to start a new chain?"),n.a.createElement("p",null,"Just to test that this is really what will happen (because who knows, maybe ",n.a.createElement("code",null,"middlewareAPI.dispatch")," is a wormhole to the final ",n.a.createElement("code",null,"dispatch")," in the chain?), let's make a silly ",n.a.createElement("code",null,"echo")," middleware:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-keyword"},"var")," echo = ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"middlewareAPI"),")"),"{",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"next"),")"),"{",n.a.createElement("br",null),"        ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"action"),")"),"{",n.a.createElement("br",null),"            ",n.a.createElement("span",{className:"hljs-keyword"},"if")," (action.type !== ",n.a.createElement("span",{className:"hljs-string"},"'ECHO'"),"){",n.a.createElement("br",null),"                setTimeout(",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"}),")"),"{",n.a.createElement("br",null),"                    middlewareAPI.dispatch({",n.a.createElement("br",null),"                        ",n.a.createElement("span",{className:"hljs-attr"},"type"),": ",n.a.createElement("span",{className:"hljs-string"},"'ECHO'"),",",n.a.createElement("br",null),"                        ",n.a.createElement("span",{className:"hljs-attr"},"volume"),": ",n.a.createElement("span",{className:"hljs-number"},"3"),n.a.createElement("br",null),"                    });",n.a.createElement("br",null),"                },",n.a.createElement("span",{className:"hljs-number"},"500"),");",n.a.createElement("br",null),"                ",n.a.createElement("span",{className:"hljs-keyword"},"return")," next(action);",n.a.createElement("br",null),"            } ",n.a.createElement("span",{className:"hljs-keyword"},"else")," ",n.a.createElement("span",{className:"hljs-keyword"},"if")," (action.volume){",n.a.createElement("br",null),"                setTimeout(",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"}),")"),"{",n.a.createElement("br",null),"                    middlewareAPI.dispatch({",n.a.createElement("br",null),"                        ",n.a.createElement("span",{className:"hljs-attr"},"type"),": ",n.a.createElement("span",{className:"hljs-string"},"'ECHO'"),",",n.a.createElement("br",null),"                        ",n.a.createElement("span",{className:"hljs-attr"},"volume"),": action.volume - ",n.a.createElement("span",{className:"hljs-number"},"1"),n.a.createElement("br",null),"                    });",n.a.createElement("br",null),"                },",n.a.createElement("span",{className:"hljs-number"},"500"),");",n.a.createElement("br",null),"            }",n.a.createElement("br",null),"        }",n.a.createElement("br",null),"    }",n.a.createElement("br",null),"}")),n.a.createElement("p",null,"If the action it is given isn't an ",n.a.createElement("code",null,"ECHO"),", it will start a new chain with an ",n.a.createElement("code",null,"ECHO")," action with ",n.a.createElement("code",null,"volume")," 3. If it was an echo it will repeat it with one less volume unit, until the echo fades. Note that we're swallowing all ",n.a.createElement("code",null,"ECHO")," actions, not passing them along to ",n.a.createElement("code",null,"next"),"."),n.a.createElement("p",null,"In order to see this in action let's also revive our ",n.a.createElement("code",null,"loggerFactory"),", although slightly less spammy this time:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-keyword"},"var")," loggerFactory = ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"name"),")"),"{",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"middlewareAPI"),")"),"{",n.a.createElement("br",null),"        ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"next"),")"),"{",n.a.createElement("br",null),"            ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"action"),")"),"{",n.a.createElement("br",null),"                ",n.a.createElement("span",{className:"hljs-keyword"},"var")," ret = next(action),",n.a.createElement("br",null),"                    newstate = middlewareAPI.getState();",n.a.createElement("br",null),"                output(name+",n.a.createElement("span",{className:"hljs-string"},'": called with "'),"+",n.a.createElement("span",{className:"hljs-built_in"},"JSON"),".stringify(action)+",n.a.createElement("span",{className:"hljs-string"},'", state now "'),"+newstate);",n.a.createElement("br",null),"                ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ret;",n.a.createElement("br",null),"            }",n.a.createElement("br",null),"        }",n.a.createElement("br",null),"    }",n.a.createElement("br",null),"}")),n.a.createElement("p",null,"We set up a store with the ",n.a.createElement("code",null,"echo")," middleware sandwiched between two ",n.a.createElement("code",null,"logger"),"s:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-keyword"},"var")," log1 = loggerFactory(",n.a.createElement("span",{className:"hljs-string"},'"log1"'),"),",n.a.createElement("br",null),"    log2 = loggerFactory(",n.a.createElement("span",{className:"hljs-string"},'"log2"'),"),",n.a.createElement("br",null),"    middlewares = Redux.applyMiddleware(log1,echo,log2),",n.a.createElement("br",null),"    store = Redux.createStore(reducer,middlewares);")),n.a.createElement("p",null,"Try it out (standalone ",n.a.createElement("a",{href:"/static/posts/exploring-redux-middleware/applets/reduxmiddleware/experiments/testingdispatch.html"},"here"),")!"),n.a.createElement("iframe",{src:"/static/posts/exploring-redux-middleware/applets/reduxmiddleware/experiments/testingdispatch.html",height:"400px",width:"100%"}),n.a.createElement("h3",{id:"9-redux-thunk"},"9. Redux-thunk"),n.a.createElement("p",null,"So the previous experiment merely proved that ",n.a.createElement("code",null,"middlewareAPI.dispatch")," is a way to start a new chain, something which on the surface seems pretty useless. Here's a very good example for when it ",n.a.createElement("em",null,"is")," useful: ",n.a.createElement("a",{href:"https://github.com/gaearon/redux-thunk"},"Redux-thunk"),". It is a middleware where the source code looks like this:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-keyword"},"var")," thunk = ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"middlewareAPI"),")"),"{",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"next"),")"),"{",n.a.createElement("br",null),"        ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"action"),")"),"{",n.a.createElement("br",null),"            ",n.a.createElement("span",{className:"hljs-keyword"},"if")," (",n.a.createElement("span",{className:"hljs-keyword"},"typeof")," action === ",n.a.createElement("span",{className:"hljs-string"},"'function'"),"){",n.a.createElement("br",null),"                ",n.a.createElement("span",{className:"hljs-keyword"},"return")," action(middlewareAPI.dispatch,middlewareAPI.getState);",n.a.createElement("br",null),"            } ",n.a.createElement("span",{className:"hljs-keyword"},"else")," {",n.a.createElement("br",null),"                ",n.a.createElement("span",{className:"hljs-keyword"},"return")," next(action);",n.a.createElement("br",null),"            }",n.a.createElement("br",null),"        }",n.a.createElement("br",null),"    }",n.a.createElement("br",null),"}")),n.a.createElement("p",null,"So what's going on here? It checks if ",n.a.createElement("code",null,"action")," is a function (what?!), and if so it invokes that function with ",n.a.createElement("code",null,"dispatch")," and ",n.a.createElement("code",null,"getState")," from the ",n.a.createElement("code",null,"middlewareAPI"),". If ",n.a.createElement("code",null,"action")," is not a function, it simply passes it on to ",n.a.createElement("code",null,"next")," as per usual."),n.a.createElement("p",null,"The point of this is to enable developers to have action creators that are async. Let's take a look again at how the counter click handler is set in our experiments:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs"},n.a.createElement("span",{className:"hljs-built_in"},"document"),".addEventListener(",n.a.createElement("span",{className:"hljs-string"},"'click'"),", ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"e"),")"),"{",n.a.createElement("br",null),"    store.dispatch({ ",n.a.createElement("span",{className:"hljs-attr"},"type"),": ",n.a.createElement("span",{className:"hljs-string"},"'INCREMENT'"),", ",n.a.createElement("span",{className:"hljs-attr"},"by"),": ",n.a.createElement("span",{className:"hljs-number"},"1")," });",n.a.createElement("br",null),"});")),n.a.createElement("p",null,"In normal Redux usage, like for example in a React app using the ",n.a.createElement("a",{href:"https://github.com/reactjs/react-redux"},"React-Redux")," bridge, you won't pass around a reference to the store itself. Instead you'll pass around action creators, and have some central system feed whatever they return to ",n.a.createElement("code",null,"store.dispatch"),". Translating our code above, that might look something like this:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs"},n.a.createElement("span",{className:"hljs-comment"},'// these action creators are what "views" in your app will use'),n.a.createElement("br",null),n.a.createElement("span",{className:"hljs-keyword"},"var")," actionCreators = {",n.a.createElement("br",null),"    increase: ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),n.a.createElement("span",{className:"hljs-params"},"(inc)")),"{",n.a.createElement("br",null),"         ",n.a.createElement("span",{className:"hljs-comment"},"// we return an action that'll go to the `dispatch` chain"),n.a.createElement("br",null),"        ",n.a.createElement("span",{className:"hljs-keyword"},"return")," {type: ",n.a.createElement("span",{className:"hljs-string"},"'INCREMENT'"),", by: inc};",n.a.createElement("br",null),"    }",n.a.createElement("br",null),"}",n.a.createElement("br",null),n.a.createElement("br",null),n.a.createElement("span",{className:"hljs-comment"},"// The views will use the actionCreators through a bridge to the dispatch method:"),n.a.createElement("br",null),n.a.createElement("span",{className:"hljs-keyword"},"var")," bridge = ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),n.a.createElement("span",{className:"hljs-params"},"(dispatch)")),"{",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-keyword"},"return")," {",n.a.createElement("br",null),"        increase: ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),n.a.createElement("span",{className:"hljs-params"},"(inc)")),"{ dispatch(actions.increase(inc)); }",n.a.createElement("br",null),"    }",n.a.createElement("br",null),"};")),n.a.createElement("p",null,"The point of the bridge is that we don't pass the store or ",n.a.createElement("code",null,"dispatch")," around, we just provide it at hookup time by passing it to the bridge function."),n.a.createElement("p",null,"This model as seen so far doesn't really allow for defining async actions in a smooth way. Sure, we could do some async stuff in our ",n.a.createElement("code",null,"bridge")," function above, but ideally we'd like to have that logic in the ",n.a.createElement("code",null,"actionCreators")," definition. This is what ",n.a.createElement("code",null,"Redux-thunk")," allows us to do. Remember how it checked if an action was a function, and if so invoked that? That allows us to do stuff like this (this is an extract from our ",n.a.createElement("a",{href:"a-react-redux-firebase-app-with-authentication/"},"Redux Firebase example"),"): "),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-keyword"},"var")," actionCreators = {",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-attr"},"startQuoteEdit"),": ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"qid"),")"),"{",n.a.createElement("br",null),"        ",n.a.createElement("span",{className:"hljs-keyword"},"return")," {",n.a.createElement("span",{className:"hljs-attr"},"type"),":C.START_QUOTE_EDIT,qid};",n.a.createElement("br",null),"    },",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-attr"},"cancelQuoteEdit"),": ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"qid"),")"),"{",n.a.createElement("br",null),"        ",n.a.createElement("span",{className:"hljs-keyword"},"return")," {",n.a.createElement("span",{className:"hljs-attr"},"type"),":C.FINISH_QUOTE_EDIT,qid};",n.a.createElement("br",null),"    },",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-attr"},"deleteQuote"),": ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"qid"),")"),"{",n.a.createElement("br",null),"        ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"dispatch,getState"),")"),"{",n.a.createElement("br",null),"            dispatch({",n.a.createElement("span",{className:"hljs-attr"},"type"),":C.SUBMIT_QUOTE_EDIT,qid});",n.a.createElement("br",null),"            quotesRef.child(qid).remove(",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"error"),")"),"{",n.a.createElement("br",null),"                dispatch({",n.a.createElement("span",{className:"hljs-attr"},"type"),":C.FINISH_QUOTE_EDIT,qid});",n.a.createElement("br",null),"                ",n.a.createElement("span",{className:"hljs-keyword"},"if")," (error){",n.a.createElement("br",null),"                    dispatch({",n.a.createElement("span",{className:"hljs-attr"},"type"),":C.DISPLAY_ERROR,",n.a.createElement("span",{className:"hljs-attr"},"error"),":",n.a.createElement("span",{className:"hljs-string"},'"Deletion failed! "'),"+error});",n.a.createElement("br",null),"                } ",n.a.createElement("span",{className:"hljs-keyword"},"else")," {",n.a.createElement("br",null),"                    dispatch({",n.a.createElement("span",{className:"hljs-attr"},"type"),":C.DISPLAY_MESSAGE,",n.a.createElement("span",{className:"hljs-attr"},"message"),":",n.a.createElement("span",{className:"hljs-string"},'"Quote successfully deleted!"'),"});",n.a.createElement("br",null),"                }",n.a.createElement("br",null),"            });",n.a.createElement("br",null),"        };",n.a.createElement("br",null),"    },",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-comment"},"// ..."),n.a.createElement("br",null),"}")),n.a.createElement("p",null,"As you can see, ",n.a.createElement("code",null,"startQuoteEdit")," and ",n.a.createElement("code",null,"cancelQuoteEdit")," are normal sync actions using regular plain action objects, while ",n.a.createElement("code",null,"deleteQuote")," contains lots of logic doing both sync and async stuff. "),n.a.createElement("p",null,"When a ",n.a.createElement("code",null,"deleteQuote")," action (which is a function) enters the ",n.a.createElement("code",null,"dispatch")," chain, the ",n.a.createElement("code",null,"thunk")," middleware will catch it, run it, and the result with be further calls to ",n.a.createElement("code",null,"dispatch")," with (most often) regular action objects."),n.a.createElement("p",null,"As you can imagine it is important to put ",n.a.createElement("code",null,"thunk")," at the beginning of the middleware chain, since no other middleware will be expecting actions which are functions!"),n.a.createElement("p",null,"To further wrap our brains around this, let's make a contrived experiment of our own using ",n.a.createElement("code",null,"thunk"),". Let's pretend-play that we're a real app and define our action like this:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs"},"var actionCreators = {",n.a.createElement("br",null),"    increase: ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),n.a.createElement("span",{className:"hljs-params"},"(inc)")),"{",n.a.createElement("br",null),"        ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),n.a.createElement("span",{className:"hljs-params"},"(dispatch,getState)")),"{",n.a.createElement("br",null),"            dispatch({",n.a.createElement("span",{className:"hljs-built_in"},"type"),": ",n.a.createElement("span",{className:"hljs-string"},"'INCREMENTINCOMING'"),"});",n.a.createElement("br",null),"            setTimeout(",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),n.a.createElement("span",{className:"hljs-params"},"()")),"{",n.a.createElement("br",null),"                dispatch({",n.a.createElement("span",{className:"hljs-built_in"},"type"),": ",n.a.createElement("span",{className:"hljs-string"},"'INCREMENT'"),", by:inc});",n.a.createElement("br",null),"            },",n.a.createElement("span",{className:"hljs-number"},"1000"),");",n.a.createElement("br",null),"        }",n.a.createElement("br",null),"    }",n.a.createElement("br",null),"}")),n.a.createElement("p",null,'We\'ll change the click hookup to look like this (although a "real" app would use a bridge of some kind and not a direct store reference):'),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs"},n.a.createElement("span",{className:"hljs-built_in"},"document"),".addEventListener(",n.a.createElement("span",{className:"hljs-string"},"'click'"),", ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"e"),")"),"{",n.a.createElement("br",null),"    store.dispatch( actionCreators.increase(",n.a.createElement("span",{className:"hljs-number"},"1"),") );",n.a.createElement("br",null),"});")),n.a.createElement("p",null,"To see this in action we also make use of a simple ",n.a.createElement("code",null,"logger"),":"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs"},n.a.createElement("span",{className:"hljs-keyword"},"var")," logger = ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function")),"(middlewareAPI){",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function")),"(next){",n.a.createElement("br",null),"        ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function")),"(action){",n.a.createElement("br",null),"            ",n.a.createElement("span",{className:"hljs-keyword"},"var")," ret = next(action),",n.a.createElement("br",null),"                ",n.a.createElement("span",{className:"hljs-keyword"},"new"),n.a.createElement("span",{className:"hljs-type"},"state")," = middlewareAPI.getState();",n.a.createElement("br",null),"            output(",n.a.createElement("span",{className:"hljs-string"},'"action "'),"+JSON.stringify(action)+",n.a.createElement("span",{className:"hljs-string"},'", state now "'),"+",n.a.createElement("span",{className:"hljs-keyword"},"new"),n.a.createElement("span",{className:"hljs-type"},"state"),");",n.a.createElement("br",null),"            ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ret;",n.a.createElement("br",null),"        }",n.a.createElement("br",null),"    }",n.a.createElement("br",null),"}")),n.a.createElement("p",null,"We take care to put that ",n.a.createElement("em",null,"after")," ",n.a.createElement("code",null,"thunk")," in the middleware chain:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs"},"var middlewares = ",n.a.createElement("span",{className:"hljs-module-access"},n.a.createElement("span",{className:"hljs-module"},n.a.createElement("span",{className:"hljs-identifier"},"Redux"),".")),"apply",n.a.createElement("span",{className:"hljs-constructor"},"Middleware(",n.a.createElement("span",{className:"hljs-params"},"thunk"),",",n.a.createElement("span",{className:"hljs-params"},"logger"),")"),",",n.a.createElement("br",null),"    store = ",n.a.createElement("span",{className:"hljs-module-access"},n.a.createElement("span",{className:"hljs-module"},n.a.createElement("span",{className:"hljs-identifier"},"Redux"),".")),"create",n.a.createElement("span",{className:"hljs-constructor"},"Store(",n.a.createElement("span",{className:"hljs-params"},"reducer"),",",n.a.createElement("span",{className:"hljs-params"},"middlewares"),")"),";")),n.a.createElement("p",null,"Check it out (standalone ",n.a.createElement("a",{href:"/static/posts/exploring-redux-middleware/applets/reduxmiddleware/experiments/thunk.html"},"here"),")!"),n.a.createElement("iframe",{src:"/static/posts/exploring-redux-middleware/applets/reduxmiddleware/experiments/thunk.html",height:"150px",width:"100%"}),n.a.createElement("p",null,"This use was rather contrived, but again, remember - the point of thunks as actions is merely to allow us to write asynchronous action creators without being dependent on a reference to the store."),n.a.createElement("h3",{id:"wrapping-up"},"Wrapping up"),n.a.createElement("p",null,"I hope this little series of laboratory concoction was useful. Mind you, a good way to understand Redux is to read the source - it is tiny! In fact the full version with warnings and comments just has an ever so slightly larger character count than this blog post...")),n.a.createElement("hr",null))}},qCfh:function(e,a,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/posts/exploring-redux-middleware",function(){var e=t("9TpG");return{page:e.default||e}}])}},[["qCfh",1,0]]]);