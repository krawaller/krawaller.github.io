(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{"+pr8":function(e,a,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/posts/a-react-redux-example-followup",function(){var e=t("x8Wg");return{page:e.default||e}}])},x8Wg:function(e,a,t){"use strict";t.r(a);var l=t("q1tI"),s=t.n(l),n=t("JRaF"),r=t("YFqc"),c=t.n(r),m={url:"a-react-redux-example-followup",id:"reduxorganisation",type:"post",title:"A React-Redux example followup",date:"2017-01-06",tags:["react","redux"],author:"david",excerpt:"Following up on our React-Redux example, discussing what logic goes where",folder:"/Users/davidwaller/gitreps/mine/blog2/sources/2017-01-04_reduxorganisation",hasStaticContent:!0,headlines:[{level:3,text:"The premise",id:"the-premise"},{level:3,text:"Reacquainting ourselves with the example",id:"reacquainting-ourselves-with-the-example"},{level:3,text:"The bug",id:"the-bug"},{level:3,text:"Solving the problem",id:"solving-the-problem"},{level:3,text:"Discussing our options",id:"discussing-our-options"},{level:3,text:"Wrapping up",id:"wrapping-up"}]};a.default=function(){return s.a.createElement(n.a,{kind:"post",data:m,title:"A React-Redux example followup",summary:"Following up on our React-Redux example, discussing what logic goes where",headlines:[{level:3,text:"The premise",id:"the-premise"},{level:3,text:"Reacquainting ourselves with the example",id:"reacquainting-ourselves-with-the-example"},{level:3,text:"The bug",id:"the-bug"},{level:3,text:"Solving the problem",id:"solving-the-problem"},{level:3,text:"Discussing our options",id:"discussing-our-options"},{level:3,text:"Wrapping up",id:"wrapping-up"}],tags:["react","redux"]},s.a.createElement("div",{className:"post","data-postid":"reduxorganisation"},s.a.createElement("h3",{id:"the-premise"},"The premise"),s.a.createElement("p",null,"In October 2015 we posted ",s.a.createElement(c.a,{href:"/posts/a-react-redux-example-app",prefetch:!0},s.a.createElement("a",null,"A React-Redux example app")),", still one of the most-read posts on this blog. Which, as is always the case when old code is scrutinized, feels increasingly embarrassing."),s.a.createElement("p",null,"Even more so when Samuel Bleckley wrote a ",s.a.createElement("a",{href:"https://blog.krawaller.se/posts/a-react-redux-example-app/#comment-3035129301"},"comment pointing out a pretty severe bug")," in the example app! This blog post explains the bug and solves it, giving us a good excuse to discuss where to put logic in a Redux app:"),s.a.createElement("ol",null,s.a.createElement("li",null,"In the view?"),s.a.createElement("li",null,"In the action creator?"),s.a.createElement("li",null,"In the reducer?"),s.a.createElement("li",null,"Somewhere else entirely?")),s.a.createElement("h3",{id:"reacquainting-ourselves-with-the-example"},"Reacquainting ourselves with the example"),s.a.createElement("p",null,"The ",s.a.createElement("a",{href:"https://github.com/krawaller/riastart2015"},"old source code")," is running in the iframe below (you can also access it directly at ",s.a.createElement("a",{href:"https://blog.krawaller.se/riastart2015/"},"https://blog.krawaller.se/riastart2015/"),")."),s.a.createElement("iframe",{src:"https://blog.krawaller.se/riastart2015/index.html",style:{height:500,width:"100%"}}),s.a.createElement("p",null,"You're assumed to have read ",s.a.createElement("a",{href:"a-react-redux-example-app/"},"the old blog post"),", but here's a whirlwind recap. The app state has two parts to it:"),s.a.createElement("ul",null,s.a.createElement("li",null,s.a.createElement("code",null,"heroes")," holds persistent information for each hero, such as number of kills total"),s.a.createElement("li",null,s.a.createElement("code",null,"battlefield")," holds the state of the currently ongoing battle")),s.a.createElement("p",null,"As usual with Redux, each of these top-level keys has a reducer of its own, thus we have a ",s.a.createElement("code",null,"heroesReducer")," and a ",s.a.createElement("code",null,"battlefieldReducer"),"."),s.a.createElement("p",null,"You can see this more clearly by peeking at the ",s.a.createElement("a",{href:"https://github.com/krawaller/riastart2015/blob/gh-pages/src/initialstate.js"},"old initial state")," code:"),s.a.createElement("pre",null,s.a.createElement("code",{className:"hljs language-javascript"},s.a.createElement("span",{className:"hljs-built_in"},"module"),".exports = ",s.a.createElement("span",{className:"hljs-function"},s.a.createElement("span",{className:"hljs-keyword"},"function"),"(",s.a.createElement("span",{className:"hljs-params"}),") "),"{",s.a.createElement("br",null),"  ",s.a.createElement("span",{className:"hljs-keyword"},"return")," {",s.a.createElement("br",null),"    ",s.a.createElement("span",{className:"hljs-comment"},'// "persistent" data on heroes'),s.a.createElement("br",null),"    ",s.a.createElement("span",{className:"hljs-attr"},"heroes"),": {",s.a.createElement("br",null),"      ",s.a.createElement("span",{className:"hljs-attr"},"batman"),": {",s.a.createElement("br",null),"        ",s.a.createElement("span",{className:"hljs-attr"},"quote"),": ",s.a.createElement("span",{className:"hljs-string"},'"I\'m batman."'),",",s.a.createElement("br",null),"        ",s.a.createElement("span",{className:"hljs-attr"},"kills"),": ",s.a.createElement("span",{className:"hljs-number"},"0"),s.a.createElement("br",null),"      },",s.a.createElement("br",null),"      ",s.a.createElement("span",{className:"hljs-attr"},"superman"),": {",s.a.createElement("br",null),"        ",s.a.createElement("span",{className:"hljs-attr"},"quote"),": ",s.a.createElement("span",{className:"hljs-string"},'"I can fly!"'),",",s.a.createElement("br",null),"        ",s.a.createElement("span",{className:"hljs-attr"},"kills"),": ",s.a.createElement("span",{className:"hljs-number"},"0"),s.a.createElement("br",null),"      },",s.a.createElement("br",null),"      ",s.a.createElement("span",{className:"hljs-attr"},"spiderman"),": {",s.a.createElement("br",null),"        ",s.a.createElement("span",{className:"hljs-attr"},"quote"),": ",s.a.createElement("span",{className:"hljs-string"},'"Why don\'t you love me, Lois?"'),",",s.a.createElement("br",null),"        ",s.a.createElement("span",{className:"hljs-attr"},"kills"),": ",s.a.createElement("span",{className:"hljs-number"},"0"),s.a.createElement("br",null),"      },",s.a.createElement("br",null),"      ",s.a.createElement("span",{className:"hljs-string"},'"he-man"'),": {",s.a.createElement("br",null),"        ",s.a.createElement("span",{className:"hljs-attr"},"quote"),": ",s.a.createElement("span",{className:"hljs-string"},'"By the power of Grayskull!"'),",",s.a.createElement("br",null),"        ",s.a.createElement("span",{className:"hljs-attr"},"kills"),": ",s.a.createElement("span",{className:"hljs-number"},"0"),s.a.createElement("br",null),"      }",s.a.createElement("br",null),"    },",s.a.createElement("br",null),"    ",s.a.createElement("span",{className:"hljs-comment"},"// data on the current battle"),s.a.createElement("br",null),"    ",s.a.createElement("span",{className:"hljs-attr"},"battlefield"),": {",s.a.createElement("br",null),"      ",s.a.createElement("span",{className:"hljs-attr"},"doing"),": {",s.a.createElement("br",null),"        ",s.a.createElement("span",{className:"hljs-attr"},"batman"),": C.WAITING,",s.a.createElement("br",null),"        ",s.a.createElement("span",{className:"hljs-attr"},"superman"),": C.WAITING,",s.a.createElement("br",null),"        ",s.a.createElement("span",{className:"hljs-attr"},"spiderman"),": C.WAITING,",s.a.createElement("br",null),"        ",s.a.createElement("span",{className:"hljs-string"},'"he-man"'),": C.WAITING",s.a.createElement("br",null),"      },",s.a.createElement("br",null),"      ",s.a.createElement("span",{className:"hljs-attr"},"standing"),": ",s.a.createElement("span",{className:"hljs-number"},"4"),",",s.a.createElement("br",null),"      ",s.a.createElement("span",{className:"hljs-attr"},"log"),": [",s.a.createElement("span",{className:"hljs-string"},'"Ready.... fight!"'),"]",s.a.createElement("br",null),"    }",s.a.createElement("br",null),"  };",s.a.createElement("br",null),"};")),s.a.createElement("p",null,"To see the persistent stats for a particular hero, simply click his name:"),s.a.createElement("p",null,s.a.createElement("img",{src:"/static/posts/a-react-redux-example-followup/img/reduxexampleherodetail.gif",alt:""})),s.a.createElement("h3",{id:"the-bug"},"The bug"),s.a.createElement("p",null,"The bug that Samuel Bleckley found is the embarrassing fact that kills are recorded even for shots that fail to take out their target. This happens if"),s.a.createElement("ul",null,s.a.createElement("li",null,"the target is ducking"),s.a.createElement("li",null,"the target was killed by someone else first"),s.a.createElement("li",null,"the shooter got taken out while aiming")),s.a.createElement("p",null,"Here you can see it in action - After the 2 second aiming period Batman gets a kill recorded even though Superman is ducking:"),s.a.createElement("p",null,s.a.createElement("img",{src:"/static/posts/a-react-redux-example-followup/img/reactreduxexamplebug.gif",alt:""})),s.a.createElement("p",null,"The explanation as to why this happens is pretty straightforward. Here is the ",s.a.createElement("a",{href:"https://github.com/krawaller/riastart2015/blob/gh-pages/src/actions.js#L24-L32"},"action creator")," that is called when we click a kill button:"),s.a.createElement("pre",null,s.a.createElement("code",{className:"hljs language-javascript"},"aimAt: ",s.a.createElement("span",{className:"hljs-function"},s.a.createElement("span",{className:"hljs-keyword"},"function"),"(",s.a.createElement("span",{className:"hljs-params"},"killer,victim"),")"),"{",s.a.createElement("br",null),"  ",s.a.createElement("span",{className:"hljs-keyword"},"return")," ",s.a.createElement("span",{className:"hljs-function"},s.a.createElement("span",{className:"hljs-keyword"},"function"),"(",s.a.createElement("span",{className:"hljs-params"},"dispatch,getState"),")"),"{",s.a.createElement("br",null),"    dispatch({",s.a.createElement("span",{className:"hljs-attr"},"type"),":constants.AIM_AT,",s.a.createElement("span",{className:"hljs-attr"},"killer"),":killer,",s.a.createElement("span",{className:"hljs-attr"},"victim"),":victim});",s.a.createElement("br",null),"    ",s.a.createElement("span",{className:"hljs-built_in"},"setTimeout"),"(",s.a.createElement("span",{className:"hljs-function"},s.a.createElement("span",{className:"hljs-keyword"},"function"),"(",s.a.createElement("span",{className:"hljs-params"}),")"),"{",s.a.createElement("br",null),"      dispatch({",s.a.createElement("span",{className:"hljs-attr"},"type"),":constants.KILL_HERO,",s.a.createElement("span",{className:"hljs-attr"},"killer"),":killer,",s.a.createElement("span",{className:"hljs-attr"},"victim"),":victim});",s.a.createElement("br",null),"    },",s.a.createElement("span",{className:"hljs-number"},"2000"),");",s.a.createElement("br",null),"  };",s.a.createElement("br",null),"}")),s.a.createElement("p",null,"It synchronously dispatches ",s.a.createElement("code",null,"AIM_AT"),", and then 2 seconds later, ",s.a.createElement("code",null,"KILL_HERO"),". The effect of ",s.a.createElement("code",null,"KILL_HERO")," is calculated in the ",s.a.createElement("a",{href:"https://github.com/krawaller/riastart2015/blob/gh-pages/src/reducers/battlefield.js#L26-L52"},s.a.createElement("code",null,"battlefieldReducer")),":"),s.a.createElement("pre",null,s.a.createElement("code",{className:"hljs language-javascript"},s.a.createElement("span",{className:"hljs-keyword"},"case")," C.KILL_HERO:",s.a.createElement("br",null),"  ",s.a.createElement("span",{className:"hljs-keyword"},"if")," (state.doing[action.killer] === C.DEAD){",s.a.createElement("br",null),"    newstate.log.push(",s.a.createElement("span",{className:"hljs-string"},'"The trigger finger twitches on "'),"+action.killer+",s.a.createElement("span",{className:"hljs-string"},'"\'s corpse"'),");",s.a.createElement("br",null),"  } ",s.a.createElement("span",{className:"hljs-keyword"},"else")," {",s.a.createElement("br",null),"    newstate.doing[action.killer] = C.WAITING; ",s.a.createElement("span",{className:"hljs-comment"},"// whatever happens we should no longer be aiming"),s.a.createElement("br",null),"    ",s.a.createElement("span",{className:"hljs-comment"},"// the target is ducking"),s.a.createElement("br",null),"    ",s.a.createElement("span",{className:"hljs-keyword"},"if")," (state.doing[action.victim] === C.DUCKING) {",s.a.createElement("br",null),"      newstate.log.push(action.victim+",s.a.createElement("span",{className:"hljs-string"},'" dodges a blast from "'),"+action.killer+",s.a.createElement("span",{className:"hljs-string"},'"!"'),");",s.a.createElement("br",null),"    ",s.a.createElement("span",{className:"hljs-comment"},"// the target has already been killed"),s.a.createElement("br",null),"    } ",s.a.createElement("span",{className:"hljs-keyword"},"else")," ",s.a.createElement("span",{className:"hljs-keyword"},"if")," (state.doing[action.victim] === C.DEAD) {",s.a.createElement("br",null),"      newstate.log.push(action.killer+",s.a.createElement("span",{className:"hljs-string"},'" blasts "'),"+action.victim+",s.a.createElement("span",{className:"hljs-string"},'"\'s corpse."'),");",s.a.createElement("br",null),"    ",s.a.createElement("span",{className:"hljs-comment"},"// we kill the target!"),s.a.createElement("br",null),"    } ",s.a.createElement("span",{className:"hljs-keyword"},"else")," {",s.a.createElement("br",null),"      ",s.a.createElement("span",{className:"hljs-keyword"},"if")," (state.doing[action.victim]===C.AIMING){",s.a.createElement("br",null),"        newstate.log.push(action.killer+",s.a.createElement("span",{className:"hljs-string"},'" killed "'),"+action.victim+",s.a.createElement("span",{className:"hljs-string"},'" before he got his shot off!"'),");",s.a.createElement("br",null),"      } ",s.a.createElement("span",{className:"hljs-keyword"},"else")," {",s.a.createElement("br",null),"        newstate.log.push(action.killer+",s.a.createElement("span",{className:"hljs-string"},'" killed "'),"+action.victim+",s.a.createElement("span",{className:"hljs-string"},'"!"'),");",s.a.createElement("br",null),"      }",s.a.createElement("br",null),"      newstate.doing[action.victim] = C.DEAD;",s.a.createElement("br",null),"      newstate.standing = newstate.standing - ",s.a.createElement("span",{className:"hljs-number"},"1"),";",s.a.createElement("br",null),"      ",s.a.createElement("span",{className:"hljs-keyword"},"if")," (newstate.standing === ",s.a.createElement("span",{className:"hljs-number"},"1"),"){",s.a.createElement("br",null),"        newstate.log.push(action.killer+",s.a.createElement("span",{className:"hljs-string"},'" WINS!!"'),");",s.a.createElement("br",null),"      }",s.a.createElement("br",null),"    }",s.a.createElement("br",null),"  }",s.a.createElement("br",null),s.a.createElement("span",{className:"hljs-keyword"},"return")," newstate;")),s.a.createElement("p",null,"Zooming out, here's a map of the logic happening when we fire:"),s.a.createElement("p",null,s.a.createElement("img",{src:"/static/posts/a-react-redux-example-followup/diagrams/reactreduxexampleflow.svg",alt:""})),s.a.createElement("p",null,"But since we branch between a valid kill and a spam message inside ",s.a.createElement("code",null,"battlefieldReducer"),", there's no way for anyone else to distinguish between a kill and an attempted kill!"),s.a.createElement("p",null,"And this is our problem. The ",s.a.createElement("a",{href:"https://github.com/krawaller/riastart2015/blob/gh-pages/src/reducers/heroes.js"},s.a.createElement("code",null,"heroesReducer"))," simply listens for the ",s.a.createElement("code",null,"KILL_HERO")," action to register a kill:"),s.a.createElement("pre",null,s.a.createElement("code",{className:"hljs language-javascript"},s.a.createElement("span",{className:"hljs-keyword"},"var")," newstate = ",s.a.createElement("span",{className:"hljs-built_in"},"Object"),".assign({}, state);",s.a.createElement("br",null),s.a.createElement("span",{className:"hljs-keyword"},"switch")," (action.type) {",s.a.createElement("br",null),"  ",s.a.createElement("span",{className:"hljs-keyword"},"case")," constants.KILL_HERO:",s.a.createElement("br",null),"    newstate[action.killer].kills += ",s.a.createElement("span",{className:"hljs-number"},"1"),";",s.a.createElement("br",null),"    ",s.a.createElement("span",{className:"hljs-keyword"},"return")," newstate;",s.a.createElement("br",null),"  ",s.a.createElement("span",{className:"hljs-keyword"},"default"),":",s.a.createElement("br",null),"    ",s.a.createElement("span",{className:"hljs-keyword"},"return")," state || initialState().heroes;",s.a.createElement("br",null),"}")),s.a.createElement("p",null,"Initially there was no ",s.a.createElement("code",null,"AIM_AT")," and no ducking - when you clicked kill, you instakilled your target. At that point in time, everything worked as expected. Then I added the 2-second aiming period and ducking, essentially ",s.a.createElement("em",null,"changing the meaning of the ",s.a.createElement("code",null,"KILL_HERO")," action to ",s.a.createElement("code",null,"MAYBE_KILL")),"."),s.a.createElement("p",null,"With the current setup, there isn't really a simple way to solve this! The ",s.a.createElement("code",null,"heroesReducer")," only cares about actual kills, but cannot easily differentiate those since the branching is done inside the ",s.a.createElement("code",null,"battlefieldReducer"),"."),s.a.createElement("h3",{id:"solving-the-problem"},"Solving the problem"),s.a.createElement("p",null,"Here's a fixed version of the app! Note how failed shots won't register as kills here."),s.a.createElement("iframe",{src:"https://blog.krawaller.se/reactreduxexamplev2/index.html",style:{height:500,width:"100%"}}),s.a.createElement("p",null,"The new source code - which, apart from the bug fix, also has updated dependencies, an ES6 makeover and some reorganisation - is available at ",s.a.createElement("a",{href:"https://github.com/krawaller/reactreduxexamplev2"},"https://github.com/krawaller/reactreduxexamplev2"),"."),s.a.createElement("p",null,"We squashed the bug by updating the ",s.a.createElement("a",{href:"https://github.com/krawaller/reactreduxexamplev2/blob/gh-pages/src/actions.js#L25-L51"},"action creator"),", making it host the main branching logic:"),s.a.createElement("pre",null,s.a.createElement("code",{className:"hljs language-javascript"},s.a.createElement("span",{className:"hljs-keyword"},"if")," (state.doing[killer] === C.DEAD) {",s.a.createElement("br",null),"  dispatch({ ",s.a.createElement("span",{className:"hljs-attr"},"type"),": C.TWITCH_FINGER, ",s.a.createElement("span",{className:"hljs-attr"},"who"),": killer });",s.a.createElement("br",null),"} ",s.a.createElement("span",{className:"hljs-keyword"},"else")," {",s.a.createElement("br",null),"  ",s.a.createElement("span",{className:"hljs-comment"},"// the target is ducking"),s.a.createElement("br",null),"  ",s.a.createElement("span",{className:"hljs-keyword"},"if")," (state.doing[victim] === C.DUCKING) {",s.a.createElement("br",null),"    dispatch({ ",s.a.createElement("span",{className:"hljs-attr"},"type"),": C.MISS_SHOT, killer, victim });",s.a.createElement("br",null),"    ",s.a.createElement("span",{className:"hljs-comment"},"// the target has already been killed"),s.a.createElement("br",null),"  } ",s.a.createElement("span",{className:"hljs-keyword"},"else")," ",s.a.createElement("span",{className:"hljs-keyword"},"if")," (state.doing[victim] === C.DEAD) {",s.a.createElement("br",null),"    dispatch({ ",s.a.createElement("span",{className:"hljs-attr"},"type"),": C.BLAST_CORPSE, killer, victim });",s.a.createElement("br",null),"    ",s.a.createElement("span",{className:"hljs-comment"},"// we kill the target!"),s.a.createElement("br",null),"  } ",s.a.createElement("span",{className:"hljs-keyword"},"else")," {",s.a.createElement("br",null),"    dispatch({ ",s.a.createElement("span",{className:"hljs-attr"},"type"),": C.KILL_HERO, killer, victim });",s.a.createElement("br",null),"  }",s.a.createElement("br",null),"}")),s.a.createElement("p",null,"The ",s.a.createElement("code",null,"battlefieldReducer")," has corresponding ",s.a.createElement("a",{href:"https://github.com/krawaller/reactreduxexamplev2/blob/gh-pages/src/store/reducers/battlefield.js#L29-L39"},"new action cases"),"..."),s.a.createElement("pre",null,s.a.createElement("code",{className:"hljs language-javascript"},s.a.createElement("span",{className:"hljs-keyword"},"case")," C.TWITCH_FINGER:",s.a.createElement("br",null),"  newstate.log.push(",s.a.createElement("span",{className:"hljs-string"},'"The trigger finger twitches on "'),"+action.who+",s.a.createElement("span",{className:"hljs-string"},'"\'s corpse"'),");",s.a.createElement("br",null),"  ",s.a.createElement("span",{className:"hljs-keyword"},"return")," newstate;",s.a.createElement("br",null),s.a.createElement("span",{className:"hljs-keyword"},"case")," C.MISS_SHOT:",s.a.createElement("br",null),"  newstate.doing[action.killer] = C.WAITING;",s.a.createElement("br",null),"  newstate.log.push(action.victim+",s.a.createElement("span",{className:"hljs-string"},'" dodges a blast from "'),"+action.killer+",s.a.createElement("span",{className:"hljs-string"},'"!"'),");",s.a.createElement("br",null),"  ",s.a.createElement("span",{className:"hljs-keyword"},"return")," newstate;",s.a.createElement("br",null),s.a.createElement("span",{className:"hljs-keyword"},"case")," C.BLAST_CORPSE:",s.a.createElement("br",null),"  newstate.doing[action.killer] = C.WAITING;",s.a.createElement("br",null),"  newstate.log.push(action.killer+",s.a.createElement("span",{className:"hljs-string"},'" blasts "'),"+action.victim+",s.a.createElement("span",{className:"hljs-string"},'"\'s corpse."'),");",s.a.createElement("br",null),"  ",s.a.createElement("span",{className:"hljs-keyword"},"return")," newstate;")),s.a.createElement("p",null,"...and an ",s.a.createElement("a",{href:"https://github.com/krawaller/reactreduxexamplev2/blob/gh-pages/src/store/reducers/battlefield.js#L40-L52"},"updated ",s.a.createElement("code",null,"KILL_HERO")," case"),":"),s.a.createElement("pre",null,s.a.createElement("code",{className:"hljs language-javascript"},s.a.createElement("span",{className:"hljs-keyword"},"case")," C.KILL_HERO:",s.a.createElement("br",null),"  ",s.a.createElement("span",{className:"hljs-keyword"},"if")," (state.doing[action.victim]===C.AIMING){",s.a.createElement("br",null),"    newstate.log.push(action.killer+",s.a.createElement("span",{className:"hljs-string"},'" killed "'),"+action.victim+",s.a.createElement("span",{className:"hljs-string"},'" before he got his shot off!"'),");",s.a.createElement("br",null),"  } ",s.a.createElement("span",{className:"hljs-keyword"},"else")," {",s.a.createElement("br",null),"    newstate.log.push(action.killer+",s.a.createElement("span",{className:"hljs-string"},'" killed "'),"+action.victim+",s.a.createElement("span",{className:"hljs-string"},'"!"'),");",s.a.createElement("br",null),"  }",s.a.createElement("br",null),"  newstate.doing[action.victim] = C.DEAD;",s.a.createElement("br",null),"  newstate.doing[action.killer] = C.WAITING;",s.a.createElement("br",null),"  newstate.standing = newstate.standing - ",s.a.createElement("span",{className:"hljs-number"},"1"),";",s.a.createElement("br",null),"  ",s.a.createElement("span",{className:"hljs-keyword"},"if")," (newstate.standing === ",s.a.createElement("span",{className:"hljs-number"},"1"),"){",s.a.createElement("br",null),"    newstate.log.push(action.killer+",s.a.createElement("span",{className:"hljs-string"},'" WINS!!"'),");",s.a.createElement("br",null),"  }",s.a.createElement("br",null),"  ",s.a.createElement("span",{className:"hljs-keyword"},"return")," newstate;")),s.a.createElement("p",null,"Now ",s.a.createElement("code",null,"KILL_HERO")," actually means what it says again."),s.a.createElement("h3",{id:"discussing-our-options"},"Discussing our options"),s.a.createElement("p",null,"Looking again at our four options for placing logic in Redux:"),s.a.createElement("ol",null,s.a.createElement("li",null,"In the view?"),s.a.createElement("li",null,"In the action creator?"),s.a.createElement("li",null,"In the reducer?"),s.a.createElement("li",null,"Somewhere else entirely?")),s.a.createElement("p",null,"Option 1 is almost always wrong. We want to keep our views simple and as decoupled from the business logic as possible. You should be able to switch framework without doing any business logic reworkings at all!"),s.a.createElement("p",null,"Option 2 is often right, especially when you aren't sure. Don't be afraid to have fat action creators and small reducers! See the sum of them as your business logic. I saw a quote which I cannot find now, but which said that"),s.a.createElement("blockquote",null,s.a.createElement("p",null,"You should be able to fully understand an app by looking at its [Redux] reducers.")),s.a.createElement("p",null,"I disagree - the quote should be"),s.a.createElement("blockquote",null,s.a.createElement("p",null,"You should be able to fully understand an app by looking at its [Redux] reducers and action creators.")),s.a.createElement("p",null,"In the case of my little example app, option 3 was wrong for the shot consequence calculation. Because a reducer cared about the goings-on inside another reducer I had painted myself into a corner."),s.a.createElement("p",null,"What about option 4? Recently I made a web version of the print & play demo of the board game ",s.a.createElement("a",{href:"https://boardgamegeek.com/boardgame/201921/tiny-epic-quest"},"Tiny Epic Quest"),", to support its ",s.a.createElement("a",{href:"https://www.kickstarter.com/projects/coe/tiny-epic-quest-introducing-itemeeplestm/"},"Kickstarter campaign"),". Here you can see the web app in action:"),s.a.createElement("p",null,s.a.createElement("img",{src:"/static/posts/a-react-redux-example-followup/img/teqdemo.gif",alt:""})),s.a.createElement("p",null,"Each player commands a group of adventurers that roam around the map, solve quests, gain items, adventure into temples, battle goblins, etc. You can probably imagine that the business logic for this is very complex!"),s.a.createElement("p",null,"Before I sat out, I naturally expected the Redux parts of my app to be very heavy. Yet here is my entire ",s.a.createElement("code",null,"battleReducer"),":"),s.a.createElement("pre",null,s.a.createElement("code",{className:"hljs"},s.a.createElement("span",{className:"hljs-keyword"},"function")," battle",s.a.createElement("span",{className:"hljs-constructor"},"Reducer(",s.a.createElement("span",{className:"hljs-params"},"currentstate"),",",s.a.createElement("span",{className:"hljs-params"},"action"),")"),"{",s.a.createElement("br",null),"  ",s.a.createElement("span",{className:"hljs-keyword"},"let")," newstate = augment",s.a.createElement("span",{className:"hljs-constructor"},"Battle(",s.a.createElement("span",{className:"hljs-params"},"cloneDeep"),"(",s.a.createElement("span",{className:"hljs-params"},"currentstate")," ",s.a.createElement("span",{className:"hljs-operator"},"||")," ",s.a.createElement("span",{className:"hljs-params"},"initialState"),".",s.a.createElement("span",{className:"hljs-params"},"battle"),")"),")",s.a.createElement("br",null),"  switch(action.",s.a.createElement("span",{className:"hljs-keyword"},"type"),"){",s.a.createElement("br",null),"    case C.START_GAME: return console.log('act',action)",s.a.createElement("span",{className:"hljs-operator"}," || "),"go",s.a.createElement("span",{className:"hljs-constructor"},"ToMode(",s.a.createElement("span",{className:"hljs-params"},"startBattle"),"(",s.a.createElement("span",{className:"hljs-params"},"action"),".",s.a.createElement("span",{className:"hljs-params"},"seating"),", ",s.a.createElement("span",{className:"hljs-params"},"action"),".",s.a.createElement("span",{className:"hljs-params"},"layout"),", ",s.a.createElement("span",{className:"hljs-params"},"action"),".",s.a.createElement("span",{className:"hljs-params"},"startingQuests"),")"),",C.MODE_GENERATE_BOARD)",s.a.createElement("br",null),"    case C.SELECT_TRAVEL: return make",s.a.createElement("span",{className:"hljs-constructor"},"Choice(",s.a.createElement("span",{className:"hljs-params"},"newstate"),", '",s.a.createElement("span",{className:"hljs-params"},"travel"),"', ",s.a.createElement("span",{className:"hljs-params"},"action"),".",s.a.createElement("span",{className:"hljs-params"},"travel"),")"),s.a.createElement("br",null),"    case C.SELECT_UNIT: return make",s.a.createElement("span",{className:"hljs-constructor"},"Choice(",s.a.createElement("span",{className:"hljs-params"},"newstate"),", '",s.a.createElement("span",{className:"hljs-params"},"unit"),"', ",s.a.createElement("span",{className:"hljs-params"},"action"),".",s.a.createElement("span",{className:"hljs-params"},"unit"),")"),s.a.createElement("br",null),"    case C.SELECT_SECTION: return make",s.a.createElement("span",{className:"hljs-constructor"},"Choice(",s.a.createElement("span",{className:"hljs-params"},"newstate"),", '",s.a.createElement("span",{className:"hljs-params"},"section"),"', ",s.a.createElement("span",{className:"hljs-params"},"action"),".",s.a.createElement("span",{className:"hljs-params"},"section"),")"),s.a.createElement("br",null),"    case C.SELECT_GOBLIN: return make",s.a.createElement("span",{className:"hljs-constructor"},"Choice(",s.a.createElement("span",{className:"hljs-params"},"newstate"),", '",s.a.createElement("span",{className:"hljs-params"},"goblin"),"', ",s.a.createElement("span",{className:"hljs-params"},"action"),".",s.a.createElement("span",{className:"hljs-params"},"goblin"),")"),s.a.createElement("br",null),"    case C.SELECT_QUEST: return make",s.a.createElement("span",{className:"hljs-constructor"},"Choice(",s.a.createElement("span",{className:"hljs-params"},"newstate"),", '",s.a.createElement("span",{className:"hljs-params"},"quest"),"', ",s.a.createElement("span",{className:"hljs-params"},"action"),".",s.a.createElement("span",{className:"hljs-params"},"quest"),")"),s.a.createElement("br",null),"    case C.SELECT_COMMAND: return newstate.commands",s.a.createElement("span",{className:"hljs-literal"},"[",s.a.createElement("span",{className:"hljs-identifier"},"action"),".",s.a.createElement("span",{className:"hljs-identifier"},"command"),"]"),".effect(newstate,action.arg)",s.a.createElement("br",null),"    default: return newstate;",s.a.createElement("br",null),"  }",s.a.createElement("br",null),"};",s.a.createElement("br",null))),s.a.createElement("p",null,"As you might gather, the actions correspond to interactions with the UI - this is a list of all the different categories of items that a user can click on. Which also means that the action creators are similarly simple. So, then, where is the logic?"),s.a.createElement("p",null,"It lives in a gargantuan object of \"modes\". Each mode is a specific point in the game, and defines what input it requires, what commands are available and what happens when they are called. As an example, here's the mode for when we've visited a mushroom village to get some help battling goblins:"),s.a.createElement("pre",null,s.a.createElement("code",{className:"hljs language-javascript"},"[C.MODE_VILLAGE_HIT2]: {",s.a.createElement("br",null),"  ",s.a.createElement("span",{className:"hljs-attr"},"setup"),": ",s.a.createElement("span",{className:"hljs-function"},s.a.createElement("span",{className:"hljs-params"},"b"),"=>")," {",s.a.createElement("br",null),"    ",s.a.createElement("span",{className:"hljs-keyword"},"if")," (!",s.a.createElement("span",{className:"hljs-built_in"},"Object"),".keys(activeGoblinTargets(b)).length){",s.a.createElement("br",null),"      ",s.a.createElement("span",{className:"hljs-keyword"},"return")," goToMode(b,C.MODE_CHECK_QUESTS)",s.a.createElement("br",null),"    }",s.a.createElement("br",null),"    ",s.a.createElement("span",{className:"hljs-keyword"},"return")," b",s.a.createElement("br",null),"  },",s.a.createElement("br",null),"  ",s.a.createElement("span",{className:"hljs-attr"},"instruction"),": ",s.a.createElement("span",{className:"hljs-function"},s.a.createElement("span",{className:"hljs-params"},"b"),"=>")," ",s.a.createElement("span",{className:"hljs-string"},'"Deal 2 dmg to a goblin one of your heroes are fighting!"'),",",s.a.createElement("br",null),"  ",s.a.createElement("span",{className:"hljs-attr"},"options"),": {",s.a.createElement("br",null),"    ",s.a.createElement("span",{className:"hljs-attr"},"goblin"),": activeGoblinTargets",s.a.createElement("br",null),"  },",s.a.createElement("br",null),"  ",s.a.createElement("span",{className:"hljs-attr"},"commands"),": ",s.a.createElement("span",{className:"hljs-function"},"(",s.a.createElement("span",{className:"hljs-params"},"b"),")=>")," ({",s.a.createElement("br",null),"    ",s.a.createElement("span",{className:"hljs-attr"},"hit"),": {",s.a.createElement("br",null),"      ",s.a.createElement("span",{className:"hljs-attr"},"available"),": ",s.a.createElement("span",{className:"hljs-function"},s.a.createElement("span",{className:"hljs-params"},"b"),"=>")," b.choices.goblin,",s.a.createElement("br",null),"      ",s.a.createElement("span",{className:"hljs-attr"},"effect"),": ",s.a.createElement("span",{className:"hljs-function"},s.a.createElement("span",{className:"hljs-params"},"b"),"=>")," {",s.a.createElement("br",null),"        b = pokeGoblin(b)",s.a.createElement("br",null),"        ",s.a.createElement("span",{className:"hljs-keyword"},"return")," goToMode(b,C.MODE_CHECK_QUESTS)",s.a.createElement("br",null),"      }",s.a.createElement("br",null),"    },",s.a.createElement("br",null),"    ",s.a.createElement("span",{className:"hljs-attr"},"skip"),": {",s.a.createElement("br",null),"      ",s.a.createElement("span",{className:"hljs-attr"},"effect"),": ",s.a.createElement("span",{className:"hljs-function"},s.a.createElement("span",{className:"hljs-params"},"b"),"=>")," goToMode(b,C.MODE_CHECK_QUESTS)",s.a.createElement("br",null),"    }",s.a.createElement("br",null),"  })",s.a.createElement("br",null),"}")),s.a.createElement("p",null,"In other words, the business logic is spearated not just from the views (React), but also from the data layer (Redux)! In a bout of nostalgia I could switch out Redux for Reflux, and I wouldn't have to touch my business code."),s.a.createElement("h3",{id:"wrapping-up"},"Wrapping up"),s.a.createElement("p",null,"Now, I'm not saying that option 4 rulez all, and that you should go forth to separate the business logic from Redux like this. But there are times when it has merits, and I think there is value just in realising that there ",s.a.createElement("em",null,"are")," 4 options and not just 3!"),s.a.createElement("p",null,"And, again - don't be afraid of fat action creators!")),s.a.createElement("hr",null))}}},[["+pr8",1,0]]]);