(window.webpackJsonp=window.webpackJsonp||[]).push([[158],{"l/39":function(e,a,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/posts/using-master-templates-with-metalsmith",function(){var e=t("yw80");return{page:e.default||e}}])},yw80:function(e,a,t){"use strict";t.r(a);var l=t("q1tI"),s=t.n(l),n=t("JRaF"),r=(t("YFqc"),{url:"using-master-templates-with-metalsmith",id:"mastertemplate",title:"Using master templates with Metalsmith",author:"david",tags:["metalsmith","handlebars"],date:"2014-08-21",excerpt:"How we used our hack of the metalsmith templates plugin to allow master templates",type:"post",folder:"/Users/davidwaller/gitreps/mine/blog2/sources/2014-08-21_mastertemplate",hasStaticContent:!1,headlines:[{level:3,text:"Master template",id:"master-template"},{level:3,text:"The power of partials",id:"the-power-of-partials"},{level:3,text:"Page types",id:"page-types"}]});a.default=function(){return s.a.createElement(n.a,{kind:"post",data:r,title:"Using master templates with Metalsmith",summary:"How we used our hack of the metalsmith templates plugin to allow master templates",headlines:[{level:3,text:"Master template",id:"master-template"},{level:3,text:"The power of partials",id:"the-power-of-partials"},{level:3,text:"Page types",id:"page-types"}],tags:["metalsmith","handlebars"]},s.a.createElement("div",{className:"post","data-postid":"mastertemplate"},s.a.createElement("h3",{id:"master-template"},"Master template"),s.a.createElement("p",null,"Recently I ",s.a.createElement("a",{href:"https://github.com/segmentio/metalsmith-templates/pull/21/files"},"hacked the metalsmith-templates plugin")," to support master templates. The idea is that you pass in a ",s.a.createElement("code",null,"master")," option, naming a master template file in the templates directory. This template will be applied to all files ",s.a.createElement("em",null,"after")," an eventual file-specific template and/or a default template."),s.a.createElement("p",null,"Here's what our call to the templates plugin looks like:"),s.a.createElement("pre",null,s.a.createElement("code",{className:"hljs language-javascript"},".use(templates({",s.a.createElement("br",null),"  ",s.a.createElement("span",{className:"hljs-attr"},"engine"),": ",s.a.createElement("span",{className:"hljs-string"},"'handlebars'"),",",s.a.createElement("br",null),"  ",s.a.createElement("span",{className:"hljs-attr"},"directory"),": ",s.a.createElement("span",{className:"hljs-string"},"'./templates'"),",",s.a.createElement("br",null),"  ",s.a.createElement("span",{className:"hljs-attr"},"master"),":",s.a.createElement("span",{className:"hljs-string"},"'master.hbt'"),",",s.a.createElement("br",null),"  ",s.a.createElement("span",{className:"hljs-attr"},"pattern"),": [",s.a.createElement("span",{className:"hljs-string"},'"*/*/*html"'),",",s.a.createElement("span",{className:"hljs-string"},'"*html"'),"]",s.a.createElement("br",null),"}))")),s.a.createElement("p",null,"The ",s.a.createElement("code",null,"contents")," variable in the master template file will contain the full result of the previous template, or the raw file contents if no previous template has been run. This enabled us to really clean up our page-specific templates (index, post, author, tag, etc), as they no longer needed to deal with headers and footers and the like."),s.a.createElement("h3",{id:"the-power-of-partials"},"The power of partials"),s.a.createElement("p",null,"We have a subdirectory in the ",s.a.createElement("code",null,"templates")," directory named ",s.a.createElement("code",null,"partials"),". Any file put here will automatically be added as a Handlebars partial through the following loop:"),s.a.createElement("pre",null,s.a.createElement("code",{className:"hljs language-javascript"},"_.each(fs.readdirSync(",s.a.createElement("span",{className:"hljs-string"},"'templates/partials'"),"),",s.a.createElement("span",{className:"hljs-function"},s.a.createElement("span",{className:"hljs-keyword"},"function"),"(",s.a.createElement("span",{className:"hljs-params"},"file"),")"),"{",s.a.createElement("br",null),"  ",s.a.createElement("span",{className:"hljs-keyword"},"var")," name = file.split(",s.a.createElement("span",{className:"hljs-string"},'"."'),")[",s.a.createElement("span",{className:"hljs-number"},"0"),"],",s.a.createElement("br",null),"      contents = fs.readFileSync(__dirname+",s.a.createElement("span",{className:"hljs-string"},'"/templates/partials/"'),"+file).toString();",s.a.createElement("br",null),"  Handlebars.registerPartial(name,contents);",s.a.createElement("br",null),"});")),s.a.createElement("p",null,"Combined with using a master template, this makes for really skinny page templates! Here's the full code for the index page template:"),s.a.createElement("pre",null,s.a.createElement("code",{className:"hljs language-html"},"{{#posts}}",s.a.createElement("br",null),s.a.createElement("br",null),"{{> listedpost root=true}}",s.a.createElement("br",null),s.a.createElement("br",null),"{{/posts}}")),s.a.createElement("p",null,"It loops through the ",s.a.createElement("code",null,"posts")," array, and prints each post using the ",s.a.createElement("code",null,"listedpost")," partial. Note that we're also passing a hash with extra variables which will extend the context, a syntax available since Handlebars 2."),s.a.createElement("p",null,"Here's what ",s.a.createElement("code",null,"listedpost")," looks like:"),s.a.createElement("pre",null,s.a.createElement("code",{className:"hljs language-html"},s.a.createElement("span",{className:"hljs-tag"},"<",s.a.createElement("span",{className:"hljs-name"},"article"),">"),s.a.createElement("br",null),"  {{> posthead root=root}}",s.a.createElement("br",null),"  ",s.a.createElement("span",{className:"hljs-tag"},"<",s.a.createElement("span",{className:"hljs-name"},"section")," ",s.a.createElement("span",{className:"hljs-attr"},"class"),"=",s.a.createElement("span",{className:"hljs-string"},'"post-excerpt"'),">"),s.a.createElement("br",null),"    ",s.a.createElement("span",{className:"hljs-tag"},"<",s.a.createElement("span",{className:"hljs-name"},"p"),">"),"{{excerpt}}",s.a.createElement("span",{className:"hljs-tag"},"</",s.a.createElement("span",{className:"hljs-name"},"p"),">"),s.a.createElement("br",null),"  ",s.a.createElement("span",{className:"hljs-tag"},"</",s.a.createElement("span",{className:"hljs-name"},"section"),">"),s.a.createElement("br",null),s.a.createElement("span",{className:"hljs-tag"},"</",s.a.createElement("span",{className:"hljs-name"},"article"),">"))),s.a.createElement("p",null,"Each markdown post file on our blog contains an ",s.a.createElement("code",null,"excerpt")," in the YAML front matter, which is what we use when we show a post in a list."),s.a.createElement("p",null,"Here's the ",s.a.createElement("code",null,"posthead")," partial, where we finally have use for the ",s.a.createElement("code",null,"root")," variable.:"),s.a.createElement("pre",null,s.a.createElement("code",{className:"hljs language-html"},s.a.createElement("span",{className:"hljs-tag"},"<",s.a.createElement("span",{className:"hljs-name"},"header")," ",s.a.createElement("span",{className:"hljs-attr"},"class"),"=",s.a.createElement("span",{className:"hljs-string"},'"post-header"'),">"),s.a.createElement("br",null),"  ",s.a.createElement("span",{className:"hljs-tag"},"<",s.a.createElement("span",{className:"hljs-name"},"h2")," ",s.a.createElement("span",{className:"hljs-attr"},"class"),"=",s.a.createElement("span",{className:"hljs-string"},'"post-title"'),">"),s.a.createElement("br",null),"    ",s.a.createElement("span",{className:"hljs-tag"},"<",s.a.createElement("span",{className:"hljs-name"},"a")," ",s.a.createElement("span",{className:"hljs-attr"},"href"),"=",s.a.createElement("span",{className:"hljs-string"},'"{{#unless root}}../../{{/unless}}{{path}}"'),">"),"{{{title}}}",s.a.createElement("span",{className:"hljs-tag"},"</",s.a.createElement("span",{className:"hljs-name"},"a"),">"),s.a.createElement("br",null),"    ",s.a.createElement("span",{className:"hljs-tag"},"<",s.a.createElement("span",{className:"hljs-name"},"span")," ",s.a.createElement("span",{className:"hljs-attr"},"class"),"=",s.a.createElement("span",{className:"hljs-string"},'"post-meta"'),">"),s.a.createElement("br",null),"      ",s.a.createElement("span",{className:"hljs-tag"},"<",s.a.createElement("span",{className:"hljs-name"},"time")," ",s.a.createElement("span",{className:"hljs-attr"},"datetime"),"=",s.a.createElement("span",{className:"hljs-string"},'"{{date}}"'),">"),"{{moment date 'MMM Do YYYY'}}",s.a.createElement("span",{className:"hljs-tag"},"</",s.a.createElement("span",{className:"hljs-name"},"time"),">")," ",s.a.createElement("br",null),"    ",s.a.createElement("span",{className:"hljs-tag"},"</",s.a.createElement("span",{className:"hljs-name"},"span"),">"),s.a.createElement("br",null),"  ",s.a.createElement("span",{className:"hljs-tag"},"</",s.a.createElement("span",{className:"hljs-name"},"h2"),">"),s.a.createElement("br",null),"    ",s.a.createElement("span",{className:"hljs-tag"},"<",s.a.createElement("span",{className:"hljs-name"},"div")," ",s.a.createElement("span",{className:"hljs-attr"},"class"),"=",s.a.createElement("span",{className:"hljs-string"},"'tags'"),">"),s.a.createElement("br",null),"      By: ",s.a.createElement("span",{className:"hljs-tag"},"<",s.a.createElement("span",{className:"hljs-name"},"span"),">"),s.a.createElement("span",{className:"hljs-tag"},"<",s.a.createElement("span",{className:"hljs-name"},"a")," ",s.a.createElement("span",{className:"hljs-attr"},"href"),"=",s.a.createElement("span",{className:"hljs-string"},"'{{#unless root}}../../{{/unless}}about/{{toLowerCase author}}'"),">"),"{{author}}",s.a.createElement("span",{className:"hljs-tag"},"</",s.a.createElement("span",{className:"hljs-name"},"a"),">"),s.a.createElement("span",{className:"hljs-tag"},"</",s.a.createElement("span",{className:"hljs-name"},"span"),">"),s.a.createElement("br",null),"    ",s.a.createElement("span",{className:"hljs-tag"},"</",s.a.createElement("span",{className:"hljs-name"},"div"),">"),s.a.createElement("br",null),"    ",s.a.createElement("span",{className:"hljs-tag"},"<",s.a.createElement("span",{className:"hljs-name"},"div")," ",s.a.createElement("span",{className:"hljs-attr"},"class"),"=",s.a.createElement("span",{className:"hljs-string"},'"tags"'),">"),s.a.createElement("br",null),"      Tags:",s.a.createElement("br",null),"      {{#tags}}",s.a.createElement("br",null),"        ",s.a.createElement("span",{className:"hljs-tag"},"<",s.a.createElement("span",{className:"hljs-name"},"span"),">"),s.a.createElement("span",{className:"hljs-tag"},"<",s.a.createElement("span",{className:"hljs-name"},"a")," ",s.a.createElement("span",{className:"hljs-attr"},"href"),"=",s.a.createElement("span",{className:"hljs-string"},"'{{#unless ../root}}../../{{/unless}}tags/{{this}}/'"),">"),"{{this}}",s.a.createElement("span",{className:"hljs-tag"},"</",s.a.createElement("span",{className:"hljs-name"},"a"),">"),s.a.createElement("span",{className:"hljs-tag"},"</",s.a.createElement("span",{className:"hljs-name"},"span"),">"),s.a.createElement("br",null),"      {{/tags}}",s.a.createElement("br",null),"    ",s.a.createElement("span",{className:"hljs-tag"},"</",s.a.createElement("span",{className:"hljs-name"},"div"),">"),s.a.createElement("br",null),s.a.createElement("span",{className:"hljs-tag"},"</",s.a.createElement("span",{className:"hljs-name"},"header"),">"))),s.a.createElement("p",null,"This partial is also used in the ",s.a.createElement("code",null,"post.hbt")," template, hence the need for the ",s.a.createElement("code",null,"root")," flag as a post-specific file is two levels deeper. Here's the ",s.a.createElement("code",null,"post.hbt")," code, with some boring Disqus stuff removed:"),s.a.createElement("pre",null,s.a.createElement("code",{className:"hljs language-html"},s.a.createElement("br",null),s.a.createElement("span",{className:"hljs-tag"},"<",s.a.createElement("span",{className:"hljs-name"},"article"),">"),s.a.createElement("br",null),s.a.createElement("br",null),"  {{> posthead}}",s.a.createElement("br",null),s.a.createElement("br",null),"  ",s.a.createElement("span",{className:"hljs-tag"},"<",s.a.createElement("span",{className:"hljs-name"},"section")," ",s.a.createElement("span",{className:"hljs-attr"},"class"),"=",s.a.createElement("span",{className:"hljs-string"},"'post-content'"),">"),s.a.createElement("br",null),"  {{{contents}}}",s.a.createElement("br",null),"  ",s.a.createElement("span",{className:"hljs-tag"},"</",s.a.createElement("span",{className:"hljs-name"},"section"),">"),s.a.createElement("br",null),s.a.createElement("br",null),"  ",s.a.createElement("span",{className:"hljs-comment"},"\x3c!-- Disqus code redacted ---\x3e"),s.a.createElement("br",null),s.a.createElement("br",null),s.a.createElement("span",{className:"hljs-tag"},"</",s.a.createElement("span",{className:"hljs-name"},"article"),">"),"  ")),s.a.createElement("h3",{id:"page-types"},"Page types"),s.a.createElement("p",null,"To centralize control over template usage, and allow for some further shortcuts in the templates, we invented the notion of page types. In all markdown files to be processed, instead of naming templates, we have a ",s.a.createElement("code",null,"type")," variable in the YAML front matter. So far, type can be ",s.a.createElement("code",null,"post"),", ",s.a.createElement("code",null,"author"),", ",s.a.createElement("code",null,"index"),", ",s.a.createElement("code",null,"tag")," or ",s.a.createElement("code",null,"taglist"),". For example, here's the YAML for this very post:"),s.a.createElement("pre",null,s.a.createElement("code",{className:"hljs language-yaml"},s.a.createElement("span",{className:"hljs-attr"},"title:")," ",s.a.createElement("span",{className:"hljs-string"},"Using")," ",s.a.createElement("span",{className:"hljs-string"},"master")," ",s.a.createElement("span",{className:"hljs-string"},"templates")," ",s.a.createElement("span",{className:"hljs-string"},"with")," ",s.a.createElement("span",{className:"hljs-string"},"Metalsmith"),s.a.createElement("br",null),s.a.createElement("span",{className:"hljs-attr"},"author:")," ",s.a.createElement("span",{className:"hljs-string"},"David"),s.a.createElement("br",null),s.a.createElement("span",{className:"hljs-attr"},"tags:")," [",s.a.createElement("span",{className:"hljs-string"},"metalsmith"),",",s.a.createElement("span",{className:"hljs-string"},"handlebars"),"]",s.a.createElement("br",null),s.a.createElement("span",{className:"hljs-attr"},"date:")," ",s.a.createElement("span",{className:"hljs-number"},"2014-08-21"),s.a.createElement("br",null),s.a.createElement("span",{className:"hljs-attr"},"excerpt:")," ",s.a.createElement("span",{className:"hljs-string"},"How")," ",s.a.createElement("span",{className:"hljs-string"},"we")," ",s.a.createElement("span",{className:"hljs-string"},"used")," ",s.a.createElement("span",{className:"hljs-string"},"our")," ",s.a.createElement("span",{className:"hljs-string"},"hack")," ",s.a.createElement("span",{className:"hljs-string"},"of")," ",s.a.createElement("span",{className:"hljs-string"},"the")," ",s.a.createElement("span",{className:"hljs-string"},"metalsmith")," ",s.a.createElement("span",{className:"hljs-string"},"templates")," ",s.a.createElement("span",{className:"hljs-string"},"plugin")," ",s.a.createElement("span",{className:"hljs-string"},"to")," ",s.a.createElement("span",{className:"hljs-string"},"allow")," ",s.a.createElement("span",{className:"hljs-string"},"master")," ",s.a.createElement("span",{className:"hljs-string"},"templates"),s.a.createElement("br",null),s.a.createElement("span",{className:"hljs-attr"},"type:")," ",s.a.createElement("span",{className:"hljs-string"},"post"))),s.a.createElement("p",null,"We use the ",s.a.createElement("code",null,"type")," variable through a mini Metalsmith plugin running all files through the following ",s.a.createElement("code",null,"map"),":"),s.a.createElement("pre",null,s.a.createElement("code",{className:"hljs language-javascript"},".use(",s.a.createElement("span",{className:"hljs-function"},s.a.createElement("span",{className:"hljs-keyword"},"function"),"(",s.a.createElement("span",{className:"hljs-params"},"files,metalsmith,done"),")"),"{",s.a.createElement("br",null),"  _.map(files,",s.a.createElement("span",{className:"hljs-function"},s.a.createElement("span",{className:"hljs-keyword"},"function"),"(",s.a.createElement("span",{className:"hljs-params"},"file"),")"),"{",s.a.createElement("br",null),"    ",s.a.createElement("span",{className:"hljs-keyword"},"return")," file.type ? _.extend(file,{",s.a.createElement("span",{className:"hljs-attr"},"template"),":file.type+",s.a.createElement("span",{className:"hljs-string"},'".hbt"'),"},_.object([",s.a.createElement("span",{className:"hljs-string"},'"is"'),"+file.type],[",s.a.createElement("span",{className:"hljs-literal"},"true"),"])) : file;",s.a.createElement("br",null),"  });",s.a.createElement("br",null),"  done();",s.a.createElement("br",null),"})")),s.a.createElement("p",null,"Now a file with ",s.a.createElement("code",null,"type")," set to ",s.a.createElement("code",null,"post")," will have a ",s.a.createElement("code",null,"template")," and ",s.a.createElement("code",null,"ispost")," variable added like thus:"),s.a.createElement("pre",null,s.a.createElement("code",{className:"hljs language-yaml"},s.a.createElement("span",{className:"hljs-attr"},"type:")," ",s.a.createElement("span",{className:"hljs-string"},"post"),s.a.createElement("br",null),s.a.createElement("span",{className:"hljs-attr"},"template:")," ",s.a.createElement("span",{className:"hljs-string"},"post.hbt"),s.a.createElement("br",null),s.a.createElement("span",{className:"hljs-attr"},"ispost:")," ",s.a.createElement("span",{className:"hljs-literal"},"true"))),s.a.createElement("p",null,"This means that should we change templating tactics, we don't need to update all individual files, instead we can simply add some logic to our mini plugin loop."),s.a.createElement("p",null,"The last thing added in the example above, ",s.a.createElement("code",null,"ispost: true"),", allows us to simplify doing post-specific stuff in the Handlebars templates. Testing for equality in Handlebars is ",s.a.createElement("a",{href:"http://stackoverflow.com/questions/8853396/logical-operator-in-a-handlebars-js-if-conditional"},"complicated"),", but testing truthiness is easy, which is why the ",s.a.createElement("code",null,"ispost")," type variables are useful. As an example, here's a snippet from the master template:"),s.a.createElement("pre",null,s.a.createElement("code",{className:"hljs language-html"},"{{#if isindex}}",s.a.createElement("br",null),"  ",s.a.createElement("span",{className:"hljs-tag"},"<",s.a.createElement("span",{className:"hljs-name"},"link")," ",s.a.createElement("span",{className:"hljs-attr"},"rel"),"=",s.a.createElement("span",{className:"hljs-string"},'"stylesheet"')," ",s.a.createElement("span",{className:"hljs-attr"},"href"),"=",s.a.createElement("span",{className:"hljs-string"},'"css/theme.css"'),"/>"),s.a.createElement("br",null),"{{else}}",s.a.createElement("br",null),"  ",s.a.createElement("span",{className:"hljs-tag"},"<",s.a.createElement("span",{className:"hljs-name"},"link")," ",s.a.createElement("span",{className:"hljs-attr"},"rel"),"=",s.a.createElement("span",{className:"hljs-string"},'"stylesheet"')," ",s.a.createElement("span",{className:"hljs-attr"},"href"),"=",s.a.createElement("span",{className:"hljs-string"},'"../../css/highlight.css"'),">"),s.a.createElement("br",null),"  ",s.a.createElement("span",{className:"hljs-tag"},"<",s.a.createElement("span",{className:"hljs-name"},"link")," ",s.a.createElement("span",{className:"hljs-attr"},"rel"),"=",s.a.createElement("span",{className:"hljs-string"},'"stylesheet"')," ",s.a.createElement("span",{className:"hljs-attr"},"href"),"=",s.a.createElement("span",{className:"hljs-string"},'"../../css/theme.css"'),"/>"),s.a.createElement("br",null),"{{/if}}"))),s.a.createElement("hr",null))}}},[["l/39",1,0]]]);