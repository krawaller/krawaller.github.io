(window.webpackJsonp=window.webpackJsonp||[]).push([[149],{"f+9p":function(e,a,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/posts/the-reflux-data-flow-model",function(){var e=t("ooyU");return{page:e.default||e}}])},ooyU:function(e,a,t){"use strict";t.r(a);var l=t("q1tI"),n=t.n(l),s=t("JRaF"),r=(t("YFqc"),{url:"the-reflux-data-flow-model",id:"refluxstructure",title:"The Reflux data flow model",author:"david",tags:["react","reflux","backbone"],date:"2014-11-04",excerpt:"Exploring the Reflux data flow model, advocating why it is a good idea, and showing what it can look like in a React app",type:"post",folder:"/Users/davidwaller/gitreps/mine/blog2/sources/2014-11-04_refluxstructure",hasStaticContent:!0,headlines:[{level:3,text:"Rewhat?",id:"rewhat"},{level:3,text:"The regular pubsub approach",id:"the-regular-pubsub-approach"},{level:3,text:"The Reflux pubsub approach",id:"the-reflux-pubsub-approach"},{level:3,text:"Reflux Stores and Actions",id:"reflux-stores-and-actions"},{level:3,text:"Communicating between objects",id:"communicating-between-objects"},{level:3,text:"Take 1 - direct calling",id:"take-1-direct-calling"},{level:3,text:"Take 2 - object-triggered event",id:"take-2-objecttriggered-event"},{level:3,text:"Take 3 - using a global event bus",id:"take-3-using-a-global-event-bus"},{level:3,text:"Take 4 - Using Reflux",id:"take-4-using-reflux"},{level:3,text:"Global event busing the Reflux way",id:"global-event-busing-the-reflux-way"},{level:3,text:"A comparison with Flux",id:"a-comparison-with-flux"},{level:3,text:"Using Reflux in React",id:"using-reflux-in-react"},{level:3,text:"A chat example",id:"a-chat-example"},{level:3,text:"Wrapping up",id:"wrapping-up"}]});a.default=function(){return n.a.createElement(s.a,{kind:"post",data:r,title:"The Reflux data flow model",summary:"Exploring the Reflux data flow model, advocating why it is a good idea, and showing what it can look like in a React app",headlines:[{level:3,text:"Rewhat?",id:"rewhat"},{level:3,text:"The regular pubsub approach",id:"the-regular-pubsub-approach"},{level:3,text:"The Reflux pubsub approach",id:"the-reflux-pubsub-approach"},{level:3,text:"Reflux Stores and Actions",id:"reflux-stores-and-actions"},{level:3,text:"Communicating between objects",id:"communicating-between-objects"},{level:3,text:"Take 1 - direct calling",id:"take-1-direct-calling"},{level:3,text:"Take 2 - object-triggered event",id:"take-2-objecttriggered-event"},{level:3,text:"Take 3 - using a global event bus",id:"take-3-using-a-global-event-bus"},{level:3,text:"Take 4 - Using Reflux",id:"take-4-using-reflux"},{level:3,text:"Global event busing the Reflux way",id:"global-event-busing-the-reflux-way"},{level:3,text:"A comparison with Flux",id:"a-comparison-with-flux"},{level:3,text:"Using Reflux in React",id:"using-reflux-in-react"},{level:3,text:"A chat example",id:"a-chat-example"},{level:3,text:"Wrapping up",id:"wrapping-up"}],tags:["react","reflux","backbone"]},n.a.createElement("div",{className:"post","data-postid":"refluxstructure"},n.a.createElement("h3",{id:"rewhat"},"Rewhat?"),n.a.createElement("p",null,"At its heart, ",n.a.createElement("a",{href:"https://github.com/spoike/refluxjs"},"Reflux")," is really just a PubSub library. That is, we have a Publisher API for objects who transmit events, and a Subscriber API for objects who want to listen to such events."),n.a.createElement("p",null,"There is however a paradigm shift in how Reflux expects you to structure your data flow, which can be ",n.a.createElement("a",{href:"https://github.com/spoike/refluxjs/issues/105"},"hard to grasp initially"),". This post will try to explain this approach."),n.a.createElement("h3",{id:"the-regular-pubsub-approach"},"The regular pubsub approach"),n.a.createElement("p",null,"For a look at what a pubsub API normally looks like let's take a look at Backbone, which has a very traditional implementation in its Events module. This module contains both publisher and subscriber functionality and is mixed in to all Views, Models and Controllers, as well as into the Backbone object itself."),n.a.createElement("p",null,"The main subscriber method is ",n.a.createElement("code",null,"listenTo"),":"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs"},"subscriber.listen",n.a.createElement("span",{className:"hljs-constructor"},"To(",n.a.createElement("span",{className:"hljs-params"},"publisher"),",",n.a.createElement("span",{className:"hljs-params"},"eventname"),",",n.a.createElement("span",{className:"hljs-params"},"callback"),")"),";")),n.a.createElement("p",null,"The publishers then have a corresponding ",n.a.createElement("code",null,"trigger")," method. So if the publisher above did this:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs"},n.a.createElement("span",{className:"hljs-attribute"},"publisher"),".trigger(eventname,data",n.a.createElement("span",{className:"hljs-number"},"1"),",data",n.a.createElement("span",{className:"hljs-number"},"2"),");")),n.a.createElement("p",null,"Then this call would be made in response:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs"},n.a.createElement("span",{className:"hljs-attribute"},"callback"),"(data",n.a.createElement("span",{className:"hljs-number"},"1"),",data",n.a.createElement("span",{className:"hljs-number"},"2"),");")),n.a.createElement("p",null,"You could say that each publisher is a radio transmitter with different frequency channels. A subscriber then chooses which channel (",n.a.createElement("code",null,"eventname"),") to listen to."),n.a.createElement("p",null,"We have a very similar situation in the DOM, where each DOM node can transmit a range of different events."),n.a.createElement("h3",{id:"the-reflux-pubsub-approach"},"The Reflux pubsub approach"),n.a.createElement("p",null,"The only thing Reflux does differently is that it does away with the different channels. Hence there is no ",n.a.createElement("code",null,"eventname")," concept in Reflux. The above sequence in Reflux would be:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs"},n.a.createElement("span",{className:"hljs-regexp"},"//")," first",n.a.createElement("br",null),"subscriber.listenTo(publisher,callback);",n.a.createElement("br",null),n.a.createElement("span",{className:"hljs-regexp"},"//")," later",n.a.createElement("br",null),"publisher.trigger(data1,data2);",n.a.createElement("br",null),n.a.createElement("span",{className:"hljs-regexp"},"//")," immediately following that",n.a.createElement("br",null),"callback(data1,data2);")),n.a.createElement("p",null,"Each publisher will only ever transmit the same kind of event. Initially I thought this to be extremely limiting - and it is - but as it turns out, this makes the whole application data flow much easier to reason about."),n.a.createElement("h3",{id:"reflux-stores-and-actions"},"Reflux Stores and Actions"),n.a.createElement("p",null,"The core of Reflux is the Publisher and Subscriber (here called Listener) modules, which can be mixed in to any object (here using underscore/lodash):"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs"},"var mypublisher = ",n.a.createElement("span",{className:"hljs-module-access"},n.a.createElement("span",{className:"hljs-module"},n.a.createElement("span",{className:"hljs-identifier"},"_"),".")),"extend(mypublisherdef,Reflux.PublisherMethods);",n.a.createElement("br",null),"mypublisher.trigger(",n.a.createElement("span",{className:"hljs-string"},'"i can trigger!"'),");",n.a.createElement("br",null),n.a.createElement("br",null),"var mysubscriber = ",n.a.createElement("span",{className:"hljs-module-access"},n.a.createElement("span",{className:"hljs-module"},n.a.createElement("span",{className:"hljs-identifier"},"_"),".")),"extend(mysubscriberdef,Reflux.ListenerMethods);",n.a.createElement("br",null),"mysubscriber.listen",n.a.createElement("span",{className:"hljs-constructor"},"To(",n.a.createElement("span",{className:"hljs-params"},"mypublisher"),",",n.a.createElement("span",{className:"hljs-params"},"callback"),")"),";",n.a.createElement("br",null),n.a.createElement("br",null),"var mypubsuber = ",n.a.createElement("span",{className:"hljs-module-access"},n.a.createElement("span",{className:"hljs-module"},n.a.createElement("span",{className:"hljs-identifier"},"_"),".")),"extend(mypubsubdef,Reflux.PublisherMethods,Reflux.ListenerMethods);",n.a.createElement("br",null),"mypubsuber.trigger(",n.a.createElement("span",{className:"hljs-string"},'"i can trigger too!"'),");",n.a.createElement("br",null),"mypubsuber.listen",n.a.createElement("span",{className:"hljs-constructor"},"To(",n.a.createElement("span",{className:"hljs-params"},"mypublisher"),",",n.a.createElement("span",{className:"hljs-params"},"callback"),")"),";")),n.a.createElement("p",null,"What then are the Action and Store concepts in Reflux? Well: a Reflux Action is merely an object consuming the ",n.a.createElement("code",null,"PublisherMethods")," like ",n.a.createElement("code",null,"mypublisher")," above, but with a few conveinence extras. Foremost is the fact that the action is a function wired to the ",n.a.createElement("code",null,"trigger")," method:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs"},"var mypublisher = ",n.a.createElement("span",{className:"hljs-module-access"},n.a.createElement("span",{className:"hljs-module"},n.a.createElement("span",{className:"hljs-identifier"},"Reflux"),".")),"create",n.a.createElement("span",{className:"hljs-constructor"},"Action()"),";",n.a.createElement("br",null),"mypublisher(",n.a.createElement("span",{className:"hljs-string"},'"i can trigger!"'),");")),n.a.createElement("p",null,"A Reflux Store corresponds to ",n.a.createElement("code",null,"mypubsuber"),", i.e. it is both a Publisher and a Subscriber:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs"},"var mypubsuber = ",n.a.createElement("span",{className:"hljs-module-access"},n.a.createElement("span",{className:"hljs-module"},n.a.createElement("span",{className:"hljs-identifier"},"Reflux"),".")),"create",n.a.createElement("span",{className:"hljs-constructor"},"Store(",n.a.createElement("span",{className:"hljs-params"},"mypubsubdef"),")"),";",n.a.createElement("br",null),"mypubsuber.trigger(",n.a.createElement("span",{className:"hljs-string"},'"i can trigger too!"'),");",n.a.createElement("br",null),"mypubsuber.listen",n.a.createElement("span",{className:"hljs-constructor"},"To(",n.a.createElement("span",{className:"hljs-params"},"mypublisher"),",",n.a.createElement("span",{className:"hljs-params"},"callback"),")"),";")),n.a.createElement("p",null,"What about an equivalent for ",n.a.createElement("code",null,"mysubscriber"),"? Well - as we will see, an object which does nothing but listen in your app will likely be a view. For React, Reflux therefore supplies a special mixin containing the ",n.a.createElement("code",null,"ListenerMethods")," and which takes care of mopping up if the view goes out of existence:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs"},n.a.createElement("span",{className:"hljs-keyword"},"var")," mysubscriber = React.createClass({",n.a.createElement("br",null),"    mixins: [Reflux.ListenerMixin],",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-comment"},"// other stuff from mysubscriberdef"),n.a.createElement("br",null),"});",n.a.createElement("br",null),"mysubscriber.listenTo(mypublisher,callback);")),n.a.createElement("h3",{id:"communicating-between-objects"},"Communicating between objects"),n.a.createElement("p",null,"Now that we know what tools Reflux supplies, we can start to discuss how to use them! First consider the problem; Something is happening in one object (a user event caught in a view), which we want to react to somewhere else (say a localStorage module storing the setting that the user just selected). How can we set this up?"),n.a.createElement("p",null,"For discussion's sake, let's explore a few different ways in which this could be set up in a Backbone app:"),n.a.createElement("h3",{id:"take-1---direct-calling"},"Take 1 - direct calling"),n.a.createElement("p",null,"The view can have a reference to the settings module and call a method on it directly:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("br",null),n.a.createElement("span",{className:"hljs-keyword"},"var")," settings = ",n.a.createElement("span",{className:"hljs-built_in"},"require"),"(",n.a.createElement("span",{className:"hljs-string"},'"./settings"'),");",n.a.createElement("br",null),n.a.createElement("br",null),n.a.createElement("span",{className:"hljs-keyword"},"var")," settingview = Backbone.View.extend({",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-attr"},"events"),": ",n.a.createElement("span",{className:"hljs-string"},'"click .submit"'),":",n.a.createElement("span",{className:"hljs-string"},'"toggleSetting"'),",",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-attr"},"toggleSetting"),": ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"}),")"),"{",n.a.createElement("br",null),"        settings.updateVolumeSetting(",n.a.createElement("span",{className:"hljs-built_in"},"this"),".$el.find(",n.a.createElement("span",{className:"hljs-string"},'".myinput"'),").val());",n.a.createElement("br",null),"    },",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-attr"},"render"),": ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"}),")"),"{ ",n.a.createElement("span",{className:"hljs-comment"},"/* stuff */")," }",n.a.createElement("br",null),"});",n.a.createElement("br",null))),n.a.createElement("p",null,"Simple but a bit clunky. The view needs a reference to the settings object, and it is dependant on the exact API of the ",n.a.createElement("code",null,"settings.updateVolumeSetting")," method. The two objects are very tightly coupled, which is a good way to ensure future headache."),n.a.createElement("h3",{id:"take-2---object-triggered-event"},"Take 2 - object-triggered event"),n.a.createElement("p",null,"The settings module can listen to events from the view:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-comment"},"// settingsview.js"),n.a.createElement("br",null),n.a.createElement("span",{className:"hljs-keyword"},"var")," settingview = Backbone.View.extend({",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-attr"},"toggleSetting"),": ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"}),")"),"{",n.a.createElement("br",null),"        ",n.a.createElement("span",{className:"hljs-built_in"},"this"),".trigger(",n.a.createElement("span",{className:"hljs-string"},'"changedvolume"'),",",n.a.createElement("span",{className:"hljs-built_in"},"this"),".$el.find(",n.a.createElement("span",{className:"hljs-string"},'".myinput"'),").val())",n.a.createElement("br",null),"    },",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-comment"},"// rest like before"),n.a.createElement("br",null),"});",n.a.createElement("br",null),n.a.createElement("br",null),n.a.createElement("span",{className:"hljs-comment"},"// settings.js"),n.a.createElement("br",null),n.a.createElement("span",{className:"hljs-keyword"},"var")," settingsview = ",n.a.createElement("span",{className:"hljs-built_in"},"require"),"(",n.a.createElement("span",{className:"hljs-string"},"'./settingsview'"),");",n.a.createElement("br",null),n.a.createElement("br",null),n.a.createElement("span",{className:"hljs-keyword"},"var")," settingsobject = Backbone.Model.extend({",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-attr"},"initialize"),": ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"o"),")"),"{",n.a.createElement("br",null),"        ",n.a.createElement("span",{className:"hljs-built_in"},"this"),".listenTo(settingsview,",n.a.createElement("span",{className:"hljs-string"},'"changedvolume"'),",",n.a.createElement("span",{className:"hljs-built_in"},"this"),".updateVolumeSetting);",n.a.createElement("br",null),"    },",n.a.createElement("br",null),"    updateVolumeSetting(val){ ",n.a.createElement("span",{className:"hljs-comment"},"/* store new volume value if it's metal enough */")," }",n.a.createElement("br",null),"});")),n.a.createElement("p",null,"Now we must instead pass the view to the settings object, which isn't much better. At least we got rid of the API dependency, but the coupling is still tight."),n.a.createElement("p",null,"Note that this approach also requires that the ",n.a.createElement("code",null,"settingsview.js")," returns a view instance and not a constructor."),n.a.createElement("h3",{id:"take-3---using-a-global-event-bus"},"Take 3 - using a global event bus"),n.a.createElement("p",null,"We can use a global event bus to transmit the events. In Backbone, the Backbone object itself is a convenient place for this at it is already a dependency of all objects, and it contains the Events API."),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-comment"},"// settingsview.js"),n.a.createElement("br",null),n.a.createElement("span",{className:"hljs-keyword"},"var")," settingview = Backbone.View.extend({",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-attr"},"toggleSetting"),": ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"}),")"),"{",n.a.createElement("br",null),"        Backbone.trigger(",n.a.createElement("span",{className:"hljs-string"},'"changedvolume"'),",",n.a.createElement("span",{className:"hljs-built_in"},"this"),".$el.find(",n.a.createElement("span",{className:"hljs-string"},'".myinput"'),").val())",n.a.createElement("br",null),"    },",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-comment"},"// rest like before"),n.a.createElement("br",null),"});",n.a.createElement("br",null),n.a.createElement("br",null),n.a.createElement("span",{className:"hljs-comment"},"// settings.js"),n.a.createElement("br",null),n.a.createElement("span",{className:"hljs-keyword"},"var")," settingsobject = Backbone.Model.extend({",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-attr"},"initialize"),": ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"o"),")"),"{",n.a.createElement("br",null),"        ",n.a.createElement("span",{className:"hljs-built_in"},"this"),".listenTo(Backbone,",n.a.createElement("span",{className:"hljs-string"},'"changedvolume"'),",",n.a.createElement("span",{className:"hljs-built_in"},"this"),".updateVolumeSetting);",n.a.createElement("br",null),"    },",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-comment"},"// rest like before"),n.a.createElement("br",null),"});")),n.a.createElement("p",null,"This looks a lot better - we no longer have to pass object references around at all! Instead of having one of the participating objects depend on the other, we make them both depend on a third party (the Backbone object) which takes care of the communication."),n.a.createElement("p",null,"On the other hand, communicating lots of events over a central channel like this can easily get out of hand; let your guard down for an afternoon of coding, and you'll suddenly have a real hell trying to figure out who transmitted what to make the app blow up in your face like it just did."),n.a.createElement("h3",{id:"take-4---using-reflux"},"Take 4 - Using Reflux"),n.a.createElement("p",null,"Here's what a solution could look like using Reflux in our Backbone example (not an advocated match, but used here for the sake of discussion (and I'm not even sure importing Reflux in this way would overwrite Backbone's Events API (probably not))):"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs language-javascript"},n.a.createElement("span",{className:"hljs-comment"},"// actions.js"),n.a.createElement("br",null),n.a.createElement("span",{className:"hljs-keyword"},"var")," actions = Reflux.createActions([",n.a.createElement("span",{className:"hljs-string"},'"changevolume"'),", ",n.a.createElement("span",{className:"hljs-comment"},"/* likely some other actions too */")," ]);",n.a.createElement("br",null),n.a.createElement("br",null),n.a.createElement("span",{className:"hljs-comment"},"// settingsview.js"),n.a.createElement("br",null),n.a.createElement("span",{className:"hljs-keyword"},"var")," actions = ",n.a.createElement("span",{className:"hljs-built_in"},"require"),"(",n.a.createElement("span",{className:"hljs-string"},'"./actions"'),");",n.a.createElement("br",null),n.a.createElement("br",null),n.a.createElement("span",{className:"hljs-keyword"},"var")," settingview = Backbone.View.extend({",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-attr"},"toggleSetting"),": ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"}),")"),"{",n.a.createElement("br",null),"        actions.changevolume(",n.a.createElement("span",{className:"hljs-built_in"},"this"),".$el.find(",n.a.createElement("span",{className:"hljs-string"},'".myinput"'),").val())",n.a.createElement("br",null),"    },",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-comment"},"// rest like before"),n.a.createElement("br",null),"},Reflux.PublisherMethods);",n.a.createElement("br",null),n.a.createElement("br",null),n.a.createElement("span",{className:"hljs-comment"},"// settings.js"),n.a.createElement("br",null),n.a.createElement("span",{className:"hljs-keyword"},"var")," actions = ",n.a.createElement("span",{className:"hljs-built_in"},"require"),"(",n.a.createElement("span",{className:"hljs-string"},'"./actions"'),");",n.a.createElement("br",null),n.a.createElement("br",null),n.a.createElement("span",{className:"hljs-keyword"},"var")," settingsobject = Backbone.Model.extend({",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-attr"},"initialize"),": ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),"(",n.a.createElement("span",{className:"hljs-params"},"o"),")"),"{",n.a.createElement("br",null),"        ",n.a.createElement("span",{className:"hljs-built_in"},"this"),".listenTo(actions.changevolume,",n.a.createElement("span",{className:"hljs-built_in"},"this"),".changevolume);",n.a.createElement("br",null),"    },",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-comment"},"// rest like before"),n.a.createElement("br",null),"},Reflux.ListenerMethods);")),n.a.createElement("p",null,"As you can see, Reflux is really similar to the global event bus solution from before. The only difference is that instead of one global channel in which we specify event type, there are lots of global channels, each dedicated to a specific event."),n.a.createElement("h3",{id:"global-event-busing-the-reflux-way"},"Global event busing the Reflux way"),n.a.createElement("p",null,"So, is having many global channels really any better than having just one? As it turns out, yes! There are several advantages:"),n.a.createElement("ul",null,n.a.createElement("li",null,"No more magic string event names like ",n.a.createElement("code",null,"changedvolume")," just begging to be misspelled (granted we could mitigate that risk with a constants object, but that is a hassle too)."),n.a.createElement("li",null,"Code becomes slightly shorter, less verbose and easier to read"),n.a.createElement("li",null,"The file ",n.a.createElement("code",null,"actions.js")," will in essence become a list of all available events in your app! This is helpful in many ways, perhaps foremost that it forces you to think about your events on a higher level."),n.a.createElement("li",null,"It also becomes very easy to compartmentalise the events if you want to. Instead of a single ",n.a.createElement("code",null,"actions")," definition you can split it into thematically defined modules; ",n.a.createElement("code",null,"useractions"),", ",n.a.createElement("code",null,"serveractions"),", etc.")),n.a.createElement("h3",{id:"a-comparison-with-flux"},"A comparison with Flux"),n.a.createElement("p",null,'On a higher level, the structure employed by Flux and Reflux are very similar. Flux too employs a global event bus approach, with event-specific channels. However, instead of making all actions into event dispatchers like Reflux, Flux employs a single "app dispatcher" much like Backbone, although with mechanisms in play to enforce the event-specific channel approach.'),n.a.createElement("p",null,"The fact that Flux has a central Dispatcher makes for lots of cruft in the code, as our ",n.a.createElement("a",{href:"https://blog.krawaller.se/posts/react-js-architecture-flux-vs-reflux/"},"previous code comparison")," between the two clearly demonstrated."),n.a.createElement("p",null,"If you need more convincing, compare the ",n.a.createElement("a",{href:"https://github.com/spoike/refluxjs-todo/"},"Reflux TodoMVC implementation")," with the ",n.a.createElement("a",{href:"https://github.com/facebook/flux/tree/master/examples/flux-todomvc/"},"Flux version"),"."),n.a.createElement("h3",{id:"using-reflux-in-react"},"Using Reflux in React"),n.a.createElement("p",null,"Enough Backbone babbling, what about best practices for using Reflux in React? We touched on it in the previous post, but wanted to revisit that here in the context of event flow. Here therefore is a stone tablet of divine law:"),n.a.createElement("ul",null,n.a.createElement("li",null,"Isolate database communication into Stores."),n.a.createElement("li",null,"When a Store receives new data from the server, it should trigger with the new data."),n.a.createElement("li",null,"React components should listen to the relevant stores."),n.a.createElement("li",null,"React components should call actions in response to user events."),n.a.createElement("li",null,"Stores should listen to actions and potentially talk to backend API:s accordingly, which might in turn cause new data to be sent back and thus an event to be triggered.")),n.a.createElement("p",null,"To wit:"),n.a.createElement("ul",null,n.a.createElement("li",null,"A component calls Actions and listens to Stores."),n.a.createElement("li",null,"A store listens to Actions and triggers events.")),n.a.createElement("h3",{id:"a-chat-example"},"A chat example"),n.a.createElement("p",null,"It's been done to death, but here is the (relevant parts of a) Firebase chat setup from a recent site work of ours:"),n.a.createElement("pre",null,n.a.createElement("code",{className:"hljs"},n.a.createElement("span",{className:"hljs-comment"},"// A view displaying the list of chat messages. Listens to changes from the Chatstore"),n.a.createElement("br",null),n.a.createElement("span",{className:"hljs-keyword"},"var")," Chatlog = React.createClass({",n.a.createElement("br",null),"  mixins: [Reflux.connect(Chatstore,",n.a.createElement("span",{className:"hljs-string"},'"messages"'),")], ",n.a.createElement("span",{className:"hljs-comment"},'// will set up listenTo call and then do this.setState("messages",data)'),n.a.createElement("br",null),"  getInitialState: ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),n.a.createElement("span",{className:"hljs-params"},"()")),"{",n.a.createElement("span",{className:"hljs-keyword"},"return")," {messages:{}};},",n.a.createElement("br",null),"  render: ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),n.a.createElement("span",{className:"hljs-params"},"()")),"{",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-keyword"},"return")," (",n.a.createElement("br",null),"      <div>",n.a.createElement("br",null),"        <Chatform />",n.a.createElement("br",null),"        <div>",n.a.createElement("br",null),"          {_.map(",n.a.createElement("span",{className:"hljs-keyword"},"this"),".state.messages,",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),n.a.createElement("span",{className:"hljs-params"},"(msg)")),"{",n.a.createElement("br",null),"              ",n.a.createElement("span",{className:"hljs-keyword"},"return")," (<p><small>{msg.date}</small><span>{msg.message}</span>);",n.a.createElement("br",null),"          })}",n.a.createElement("br",null),"        </div>",n.a.createElement("br",null),"      </div>",n.a.createElement("br",null),"    );",n.a.createElement("br",null),"  }",n.a.createElement("br",null),"});",n.a.createElement("br",null),n.a.createElement("br",null),n.a.createElement("span",{className:"hljs-comment"},"// a view displaying the form for entering a new msg. calls addmsg action"),n.a.createElement("br",null),n.a.createElement("span",{className:"hljs-keyword"},"var")," Chatform = React.createClass({",n.a.createElement("br",null),"  onSubmit: ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),n.a.createElement("span",{className:"hljs-params"},"(e)")),"{",n.a.createElement("br",null),"    actions.addchatmessage(",n.a.createElement("span",{className:"hljs-keyword"},"this"),".refs[",n.a.createElement("span",{className:"hljs-string"},"'field'"),"].getDOMNode().value)",n.a.createElement("br",null),"    e.preventDefault();",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ",n.a.createElement("span",{className:"hljs-literal"},"false"),";",n.a.createElement("br",null),"  },",n.a.createElement("br",null),"  render: ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),n.a.createElement("span",{className:"hljs-params"},"()")," "),"{",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-keyword"},"return")," (",n.a.createElement("br",null),"      <form onSubmit={",n.a.createElement("span",{className:"hljs-keyword"},"this"),".onSubmit}>",n.a.createElement("br",null),"        <input className=",n.a.createElement("span",{className:"hljs-string"},"'form-control'")," type=",n.a.createElement("span",{className:"hljs-string"},"'text'")," ref=",n.a.createElement("span",{className:"hljs-string"},"'field'"),"/>",n.a.createElement("br",null),"        <button className=",n.a.createElement("span",{className:"hljs-string"},"'btn btn-default'")," type=",n.a.createElement("span",{className:"hljs-string"},"'submit'"),">Send!</button>",n.a.createElement("br",null),"      </form>",n.a.createElement("br",null),"    );",n.a.createElement("br",null),"  }",n.a.createElement("br",null),"});",n.a.createElement("br",null),n.a.createElement("br",null),n.a.createElement("span",{className:"hljs-comment"},"// A store listening to addmsg action. Will trigger upon receiving server data"),n.a.createElement("br",null),n.a.createElement("span",{className:"hljs-keyword"},"var")," chatRef = ",n.a.createElement("span",{className:"hljs-keyword"},"new")," Firebase(",n.a.createElement("span",{className:"hljs-string"},'"https://<firebaseusername>.firebaseio.com/web/data/chat"'),");",n.a.createElement("br",null),n.a.createElement("br",null),n.a.createElement("span",{className:"hljs-keyword"},"var")," Chatstore = Reflux.createStore({",n.a.createElement("br",null),"  init: ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),n.a.createElement("span",{className:"hljs-params"},"()")),"{",n.a.createElement("br",null),"    chatRef.on(",n.a.createElement("span",{className:"hljs-string"},'"value"'),",",n.a.createElement("span",{className:"hljs-keyword"},"this"),".updateChat.bind(",n.a.createElement("span",{className:"hljs-keyword"},"this"),"));",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-keyword"},"this"),".listenTo(actions.addchatmessage,",n.a.createElement("span",{className:"hljs-keyword"},"this"),".addChatMsg.bind(",n.a.createElement("span",{className:"hljs-keyword"},"this"),"));",n.a.createElement("br",null),"  },",n.a.createElement("br",null),"  addChatMsg: ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),n.a.createElement("span",{className:"hljs-params"},"(msg)")),"{",n.a.createElement("br",null),"    chatRef.push(msg,",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),n.a.createElement("span",{className:"hljs-params"},"(err)")),"{",n.a.createElement("br",null),"      ",n.a.createElement("span",{className:"hljs-keyword"},"if")," (err){",n.a.createElement("br",null),"        actions.error(",n.a.createElement("span",{className:"hljs-string"},'"Chat send failure: "'),"+err);",n.a.createElement("br",null),"      } ",n.a.createElement("span",{className:"hljs-keyword"},"else")," {",n.a.createElement("br",null),"        actions.log(",n.a.createElement("span",{className:"hljs-string"},'"Message sent"'),",msg);",n.a.createElement("br",null),"      }",n.a.createElement("br",null),"    });",n.a.createElement("br",null),"  },",n.a.createElement("br",null),"  updateChat: ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),n.a.createElement("span",{className:"hljs-params"},"(snapshot)")),"{",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-keyword"},"this"),".trigger((",n.a.createElement("span",{className:"hljs-keyword"},"this"),".last = snapshot.val()||{}));",n.a.createElement("br",null),"  },",n.a.createElement("br",null),"  getDefaultData: ",n.a.createElement("span",{className:"hljs-function"},n.a.createElement("span",{className:"hljs-keyword"},"function"),n.a.createElement("span",{className:"hljs-params"},"()")),"{",n.a.createElement("br",null),"    ",n.a.createElement("span",{className:"hljs-keyword"},"return")," ",n.a.createElement("span",{className:"hljs-keyword"},"this"),".last || {};",n.a.createElement("br",null),"  }",n.a.createElement("br",null),"});")),n.a.createElement("p",null,"Here's what will happen when a user enters a new chat message:"),n.a.createElement("ol",null,n.a.createElement("li",null,"The Chatform React component will call the ",n.a.createElement("code",null,"addchatmessage")," Reflux action"),n.a.createElement("li",null,"Chatstore is listening to that action, and will make an API call to Firebase in the ",n.a.createElement("code",null,"addChatMsg")," method"),n.a.createElement("li",null,"Firebase will update its data"),n.a.createElement("li",null,"Chatstore receives the new data from Firebase in the ",n.a.createElement("code",null,"updateChat")," method, which makes the store trigger an event with the new data"),n.a.createElement("li",null,"Chatlog is listening to the store and so receives the new data, which updates its state and causes a render")),n.a.createElement("p",null,"If we anonymize the components to get back to the stone tablet laws, here's what's going on:"),n.a.createElement("p",null,n.a.createElement("img",{src:"/static/posts/the-reflux-data-flow-model/img/refluxflow2.jpeg",alt:"Reflux flow"})),n.a.createElement("p",null,'Each "published to"-arrow of course corresponds to a reversed "listens to"-arrow.'),n.a.createElement("h3",{id:"wrapping-up"},"Wrapping up"),n.a.createElement("p",null,"This post aimed at..."),n.a.createElement("ul",null,n.a.createElement("li",null,"explaining how Reflux is merely a pubsub solution minus the event names,"),n.a.createElement("li",null,"advocating why this is a good idea,"),n.a.createElement("li",null,"...and show how to utilize this flow in React.")),n.a.createElement("p",null,"If any of these three points missed their mark, scroll back to the top and read again, or make an angry comment below!")),n.a.createElement("hr",null))}}},[["f+9p",1,0]]]);