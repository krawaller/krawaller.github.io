<!DOCTYPE html><html><head><link rel="stylesheet" type="text/css" href="/static/styles/nprogress.css"/><link rel="stylesheet" href="/static/styles/code.css"/><link rel="stylesheet" href="/static/styles/site.css"/><link href="https://fonts.googleapis.com/css?family=Open+Sans&amp;display=swap" rel="stylesheet"/><link href="https://fonts.googleapis.com/css?family=Lexend+Zetta&amp;display=swap" rel="stylesheet"/><script async="" src="https://www.google-analytics.com/analytics.js"></script><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-11433118-1', 'auto');
  ga("send", "pageview");</script><meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"/><meta charSet="utf-8"/><title>A React encapsulation pattern</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/wQeVqw4-MCmoY2Zy_p65E/pages/posts/a-react-encapsulation-pattern.js" as="script"/><link rel="preload" href="/_next/static/wQeVqw4-MCmoY2Zy_p65E/pages/_app.js" as="script"/><link rel="preload" href="/_next/static/runtime/webpack-3df6523e264ff2ac6548.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.ebbfd942159f83091516.js" as="script"/><link rel="preload" href="/_next/static/runtime/main-c1620565ee9f1f33603c.js" as="script"/></head><body><div id="__next"><div style="margin-bottom:20px"></div><div class="master"><h1><a href="/"><span>k</span><span>r</span><span>a</span><span>w</span><span>a</span><span>l</span><span>l</span><span>e</span><span>r</span></a></h1><hr/><div class="summary">Exploring how we can encapsulate concerns in React by using mixin factories</div><hr/><h2>A React encapsulation pattern</h2><p class="taglist">Tags:<!-- --> <a href="/tags/react/">react</a><a href="/tags/underscore/">underscore</a></p><div class="page-content"><div class="post" data-postid="reactpattern"><h3 id="fruits">Fruits!</h3><p>As a first step towards a discussion on an encapsulation pattern using mixin factories, please consider this little object of intellectual fruit opinions:</p><pre><code class="hljs language-javascript"><span class="hljs-keyword">var</span> fruits = {<br/>  <span class="hljs-attr">apples</span>: <span class="hljs-string">&quot;nice&quot;</span>,<br/>  <span class="hljs-attr">oranges</span>: <span class="hljs-string">&quot;a hassle to peel&quot;</span>,<br/>  <span class="hljs-attr">bananas</span>: <span class="hljs-string">&quot;funny&quot;</span><br/>};</code></pre><p>I now want the user to be able to select one a time, something like this:</p><iframe src="/static/posts/a-react-encapsulation-pattern/applets/reactpattern/select01.html" style="height:70px;width:100%"></iframe><p>What parts are involved in the select bar? Well, we need to:</p><ol><li>have an initially selected option</li><li>render the bar, highlighting the currently selected option</li><li>update state whenever another option is selected</li></ol><p>Here&#x27;s a naïve implementation of this component:</p><pre><code class="hljs"><span class="hljs-keyword">var</span> Opinion = React.createClass({<br/>  getInitialState: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{<br/>    <span class="hljs-keyword">return</span> {fruit:<span class="hljs-string">&quot;apples&quot;</span>};<br/>  },<br/>  chooseFruit: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(c)</span></span>{<br/>    <span class="hljs-keyword">this</span>.setState({fruit:c});<br/>  },<br/>  render: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{<br/>    <span class="hljs-keyword">var</span> selector = (<br/>      &lt;div className=<span class="hljs-string">&quot;btn-group clearfix&quot;</span>&gt;<br/>        {_.map(_.keys(fruits),<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(c)</span></span>{<br/>          <span class="hljs-keyword">return</span> &lt;button onClick={_.partial(<span class="hljs-keyword">this</span>.chooseFruit,c)} className={<span class="hljs-string">&#x27;btn btn-default&#x27;</span>+(c===<span class="hljs-keyword">this</span>.state.fruit?<span class="hljs-string">&#x27; active&#x27;</span>:<span class="hljs-string">&#x27;&#x27;</span>)}&gt;{c}&lt;/button&gt;<br/>        },<span class="hljs-keyword">this</span>)}<br/>      &lt;/div&gt;<br/>    );<br/>    <span class="hljs-keyword">return</span> (<br/>      &lt;div className=<span class="hljs-string">&quot;center-block&quot;</span> style={{maxWidth:<span class="hljs-string">&quot;800px;&quot;</span>,padding:<span class="hljs-string">&quot;1em;&quot;</span>}}&gt;<br/>        I posit that {selector} are {fruits[<span class="hljs-keyword">this</span>.state.fruit]}!<br/>      &lt;/div&gt;<br/>    )<br/>  }<br/>});</code></pre><p>We provide an initial value through the <code>getInitialState</code> method, and have a click handler that updates our state with the clicked option.</p><h3 id="vegetables">Vegetables!</h3><p>Seems clean enough! So, what&#x27;s wrong with this? Well, not much (and we&#x27;ll get to that later). But when the vegetables arrive...</p><pre><code class="hljs">var vegetables = {<br/>  carrots: <span class="hljs-comment">&quot;are for bunnies&quot;</span>,<br/>  peas: <span class="hljs-comment">&quot;are perfect for flicking at your mum&quot;</span>,<br/>  eggplants: <span class="hljs-comment">&quot;are just weird&quot;</span><br/>};</code></pre><p>...and we now want this...</p><iframe src="/static/posts/a-react-encapsulation-pattern/applets/reactpattern/select01v.html" style="height:140px;width:100%"></iframe><p>...things get rather messy! Extending <code>Opinion</code> using the same approach as before we end up with something like this:</p><pre><code class="hljs language-javascript"><span class="hljs-keyword">var</span> List = React.createClass({<br/>  <span class="hljs-attr">getInitialState</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{<br/>    <span class="hljs-keyword">return</span> { <span class="hljs-attr">fruit</span>: <span class="hljs-string">&quot;apples&quot;</span>, <span class="hljs-attr">vegetable</span>: <span class="hljs-string">&quot;carrots&quot;</span> };<br/>  },<br/>  <span class="hljs-attr">chooseFruit</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">c</span>) </span>{<br/>    <span class="hljs-built_in">this</span>.setState({ <span class="hljs-attr">fruit</span>: c });<br/>  },<br/>  <span class="hljs-attr">chooseVegetable</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">c</span>) </span>{<br/>    <span class="hljs-built_in">this</span>.setState({ <span class="hljs-attr">vegetable</span>: c });<br/>  },<br/>  <span class="hljs-attr">render</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{<br/>    <span class="hljs-keyword">var</span> fruitSelector = (<br/>      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;btn-group clearfix&quot;</span>&gt;</span><br/>        {_.map(<br/>          _.keys(fruits),<br/>          function(c) {<br/>            return (<br/>              <span class="hljs-tag">&lt;<span class="hljs-name">button</span><br/>                <span class="hljs-attr">onClick</span>=<span class="hljs-string">{_.partial(this.chooseFruit,</span> <span class="hljs-attr">c</span>)}<br/>                <span class="hljs-attr">className</span>=<span class="hljs-string">{</span><br/>                  &quot;<span class="hljs-attr">btn</span> <span class="hljs-attr">btn-default</span>&quot; + (<span class="hljs-attr">c</span> === <span class="hljs-string">this.state.fruit</span> ? &quot; <span class="hljs-attr">active</span>&quot; <span class="hljs-attr">:</span> &quot;&quot;)<br/>                }<br/>              &gt;</span><br/>                {c}<br/>              <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br/>            );<br/>          },<br/>          this<br/>        )}<br/>      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br/>    );<br/>    <span class="hljs-keyword">var</span> veggySelector = (<br/>      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;btn-group clearfix&quot;</span>&gt;</span><br/>        {_.map(<br/>          _.keys(vegetables),<br/>          function(c) {<br/>            return (<br/>              <span class="hljs-tag">&lt;<span class="hljs-name">button</span><br/>                <span class="hljs-attr">onClick</span>=<span class="hljs-string">{_.partial(this.chooseVegetable,</span> <span class="hljs-attr">c</span>)}<br/>                <span class="hljs-attr">className</span>=<span class="hljs-string">{</span><br/>                  &quot;<span class="hljs-attr">btn</span> <span class="hljs-attr">btn-default</span>&quot; +<br/>                  (<span class="hljs-attr">c</span> === <span class="hljs-string">this.state.vegetable</span> ? &quot; <span class="hljs-attr">active</span>&quot; <span class="hljs-attr">:</span> &quot;&quot;)<br/>                }<br/>              &gt;</span><br/>                {c}<br/>              <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br/>            );<br/>          },<br/>          this<br/>        )}<br/>      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br/>    );<br/>    <span class="hljs-keyword">return</span> (<br/>      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span><br/>        <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;center-block&quot;</span><br/>        <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">maxWidth:</span> &quot;<span class="hljs-attr">800px</span>;&quot;, <span class="hljs-attr">padding:</span> &quot;<span class="hljs-attr">1em</span>;&quot; }}<br/>      &gt;</span><br/>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br/>          I posit that {fruitSelector} are {fruits[this.state.fruit]}!<br/>        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br/>        <span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span><br/>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br/>          Also {veggySelector} are {vegetables[this.state.vegetable]}.<br/>        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br/>      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br/>    );<br/>  }<br/>});</code></pre><p>This is starting to look decidedly non-dry.</p><h3 id="componentifying">Componentifying</h3><p>What springs immediately to mind is of course that we could encapsulate the rendering of the bar into a component! Let&#x27;s call it <code>Select</code>:</p><pre><code class="hljs language-javascript"><span class="hljs-keyword">var</span> Select = React.createClass({<br/>  <span class="hljs-attr">propTypes</span>: {<br/>    <span class="hljs-attr">options</span>: React.PropTypes.arrayOf(React.PropTypes.string).isRequired,<br/>    <span class="hljs-attr">makeSelection</span>: React.PropTypes.func.isRequired,<br/>    <span class="hljs-attr">current</span>: React.PropTypes.string.isRequired<br/>  },<br/>  <span class="hljs-attr">render</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{<br/>    <span class="hljs-keyword">return</span> (<br/>      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;btn-group clearfix&quot;</span>&gt;</span><br/>        {_.map(<br/>          this.props.options,<br/>          function(c) {<br/>            var handler = _.partial(this.props.makeSelection, c);<br/>            var active = c === this.props.current;<br/>            return (<br/>              <span class="hljs-tag">&lt;<span class="hljs-name">button</span><br/>                <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handler}</span><br/>                <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>&quot;<span class="hljs-attr">btn</span> <span class="hljs-attr">btn-default</span>&quot; + (<span class="hljs-attr">active</span> ? &quot; <span class="hljs-attr">active</span>&quot; <span class="hljs-attr">:</span> &quot;&quot;)}<br/>              &gt;</span><br/>                {c}<br/>              <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br/>            );<br/>          },<br/>          this<br/>        )}<br/>      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br/>    );<br/>  }<br/>});</code></pre><p>The component expects an <strong>array of options</strong>, a <strong>clickhandler</strong> and the <strong>currenly selected value</strong>. Note how we&#x27;re using the <code>_.partial</code> currying function to call the click handler with the clicked value.</p><p>Using this component, <code>Opinion</code> can now be reduced to this:</p><pre><code class="hljs language-javascript"><span class="hljs-keyword">var</span> Opinion = React.createClass({<br/>  <span class="hljs-attr">getInitialState</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{<br/>    <span class="hljs-keyword">return</span> { <span class="hljs-attr">fruit</span>: <span class="hljs-string">&quot;apples&quot;</span>, <span class="hljs-attr">vegetable</span>: <span class="hljs-string">&quot;carrots&quot;</span> };<br/>  },<br/>  <span class="hljs-attr">chooseFruit</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">c</span>) </span>{<br/>    <span class="hljs-built_in">this</span>.setState({ <span class="hljs-attr">fruit</span>: c });<br/>  },<br/>  <span class="hljs-attr">chooseVegetable</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">c</span>) </span>{<br/>    <span class="hljs-built_in">this</span>.setState({ <span class="hljs-attr">vegetable</span>: c });<br/>  },<br/>  <span class="hljs-attr">render</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{<br/>    <span class="hljs-keyword">var</span> s = <span class="hljs-built_in">this</span>.state;<br/>    <span class="hljs-keyword">var</span> fruitSelector = (<br/>      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Select</span><br/>        <span class="hljs-attr">options</span>=<span class="hljs-string">{_.keys(fruits)}</span><br/>        <span class="hljs-attr">current</span>=<span class="hljs-string">{s.fruit}</span><br/>        <span class="hljs-attr">makeSelection</span>=<span class="hljs-string">{this.chooseFruit}</span><br/>      /&gt;</span></span><br/>    );<br/>    <span class="hljs-keyword">var</span> veggySelector = (<br/>      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Select</span><br/>        <span class="hljs-attr">options</span>=<span class="hljs-string">{_.keys(vegetables)}</span><br/>        <span class="hljs-attr">current</span>=<span class="hljs-string">{s.vegetable}</span><br/>        <span class="hljs-attr">makeSelection</span>=<span class="hljs-string">{this.chooseVegetable}</span><br/>      /&gt;</span></span><br/>    );<br/>    <span class="hljs-keyword">return</span> (<br/>      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span><br/>        <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;center-block&quot;</span><br/>        <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">maxWidth:</span> &quot;<span class="hljs-attr">800px</span>;&quot;, <span class="hljs-attr">padding:</span> &quot;<span class="hljs-attr">1em</span>;&quot; }}<br/>      &gt;</span><br/>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br/>          I posit that {fruitSelector} are {fruits[s.fruit]}!<br/>        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br/>        <span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span><br/>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br/>          Also {veggySelector} are {vegetables[s.vegetable]}.<br/>        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br/>      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br/>    );<br/>  }<br/>});</code></pre><p>That is indeed much better! We still have lots of methods in our class, but the <code>render</code> method is far less messy than before.</p><h3 id="underscore-intermission">Underscore intermission</h3><p>Before we move on with the React ponderings, let&#x27;s take an Underscore detour. Since we&#x27;re already using the <code>_.partial</code> curry function inside <code>Select</code>, we could do it in <code>Opinion</code> too to merge <code>chooseVegetable(opt)</code> and <code>chooseFruit(opt)</code> into a <code>choose(prop,opt)</code> method:</p><pre><code class="hljs language-javascript"><span class="hljs-keyword">var</span> Opinion = React.createClass({<br/>  <span class="hljs-attr">getInitialState</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{<br/>    <span class="hljs-keyword">return</span> { <span class="hljs-attr">fruit</span>: <span class="hljs-string">&quot;apples&quot;</span>, <span class="hljs-attr">vegetable</span>: <span class="hljs-string">&quot;carrots&quot;</span> };<br/>  },<br/>  <span class="hljs-attr">choose</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">prop, c</span>) </span>{<br/>    <span class="hljs-built_in">this</span>.setState(_.object([prop], [c]));<br/>  },<br/>  <span class="hljs-attr">render</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{<br/>    <span class="hljs-keyword">var</span> cb = <span class="hljs-built_in">this</span>.choose,<br/>      s = <span class="hljs-built_in">this</span>.state;<br/>    <span class="hljs-keyword">var</span> fruitSelector = (<br/>      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Select</span><br/>        <span class="hljs-attr">options</span>=<span class="hljs-string">{_.keys(fruits)}</span><br/>        <span class="hljs-attr">current</span>=<span class="hljs-string">{s.fruit}</span><br/>        <span class="hljs-attr">makeSelection</span>=<span class="hljs-string">{_.partial(cb,</span> &quot;<span class="hljs-attr">fruit</span>&quot;)}<br/>      /&gt;</span></span><br/>    );<br/>    <span class="hljs-keyword">var</span> veggySelector = (<br/>      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Select</span><br/>        <span class="hljs-attr">options</span>=<span class="hljs-string">{_.keys(vegetables)}</span><br/>        <span class="hljs-attr">current</span>=<span class="hljs-string">{s.vegetable}</span><br/>        <span class="hljs-attr">makeSelection</span>=<span class="hljs-string">{_.partial(cb,</span> &quot;<span class="hljs-attr">vegetable</span>&quot;)}<br/>      /&gt;</span></span><br/>    );<br/>    <span class="hljs-keyword">return</span> (<br/>      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span><br/>        <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;center-block&quot;</span><br/>        <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">maxWidth:</span> &quot;<span class="hljs-attr">800px</span>;&quot;, <span class="hljs-attr">padding:</span> &quot;<span class="hljs-attr">1em</span>;&quot; }}<br/>      &gt;</span><br/>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br/>          I posit that {fruitSelector} are {fruits[s.fruit]}!<br/>        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br/>        <span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span><br/>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br/>          Also {veggySelector} are {vegetables[s.vegetable]}.<br/>        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br/>      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br/>    );<br/>  }<br/>});</code></pre><p>Note the calls to <code>partial</code> towards the end of the <code>fruitSelector</code> and <code>veggySelector</code> definitions.</p><p>Inside <code>choose</code> we use the <code>_.object</code> method to create the argument to <code>setState</code>. It takes two arrays, one of keys and one of values, and bakes these into an object. Thus calling it with <code>choose(&quot;fruit&quot;,&quot;apples&quot;)</code> would cause <code>setState({fruit:&quot;apples&quot;})</code>. This way we can create objects with a single line of code even when the key is dynamic.</p><h3 id="the-actual-problem">The actual problem</h3><p>Now back to React. What was my problem with the code for <code>Opinion</code>? Especially the last version looks pretty sleek!</p><p>Here&#x27;s my problem; The seeding of inital values (<code>getInitialState</code>) and the click handler (<code>choose</code>) are intimately connected to <code>Select</code>. None is usable without the other two. This makes me want to package them all together! And since <code>Select</code> is a component, it seems logical to somehow shove <code>choose</code> and <code>getInitialState</code> inside that component definition!</p><p>Why is that not easy? Well, because we need to deal with the state of the outer component. Then I remembered - I&#x27;ve been there before! As told in the <a href="/posts/reflux-refinement/">Reflux refinement</a> post, I made a syntax that reduced this:</p><pre><code class="hljs"><span class="hljs-keyword">var</span> Cart = React.createClass({<br/>  mixins: [Reflux.ListenerMixin],<br/>  componentDidMount: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{<br/>    <span class="hljs-keyword">this</span>.listenTo(appStore, <span class="hljs-keyword">this</span>._onStuffChange);<br/>  },<br/>  <span class="hljs-comment">// rest redacted</span><br/>});</code></pre><p>...to this:</p><pre><code class="hljs language-javascript"><span class="hljs-keyword">var</span> Cart = React.createClass({<br/>  <span class="hljs-attr">mixins</span>: [Reflux.listenTo(appStore, <span class="hljs-string">&quot;_onStuffChange&quot;</span>)]<br/>  <span class="hljs-comment">// rest redacted</span><br/>});</code></pre><p>Instead of a mixin I made a mixin factory. We pass the factory the data it needs to generate the <code>componentDidMount</code> call for you, making the code far less boilerplaty.</p><h3 id="tried-and-trusted">Tried and trusted</h3><p>Perchance we could use that same teqnique here? If we try to turn the <code>Select</code> component into a mixin factory - what would the resulting mixin need to contain?</p><ul><li>We need to set the initial value (as currently done in <code>getInitialState</code>)</li><li>We need a clickHandler that updates state (as currently done in <code>choose</code>)</li><li>We need a way to render the select bar (as currently done in the <code>Select</code> component)</li></ul><p>To provide this, what does the mixin factory need to know?</p><ul><li>The name of the state property to use</li><li>The available options</li><li>What option is initially selected - unless we always start with the first, which I opted for here</li></ul><p>Ok, so we&#x27;ll have a signature like this: <code>Select(propname,options)</code></p><p>And the provided mixin object will look like this:</p><pre><code class="hljs language-javascript">{<br/>  <span class="hljs-attr">getInitialState</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{<br/>    <span class="hljs-keyword">return</span> {<span class="hljs-attr">propname</span>:options[<span class="hljs-number">0</span>]}<br/>  },<br/>  <span class="hljs-attr">choose</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">opt</span>)</span>{<br/>    <span class="hljs-built_in">this</span>.setState({<span class="hljs-attr">propname</span>:opt})<br/>  },<br/>  <span class="hljs-attr">renderbar</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{<br/>    <span class="hljs-keyword">return</span> (<br/>      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;btn-group clearfix&quot;</span>&gt;</span><br/>        // maploop blah blah<br/>      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br/>    );<br/>  }<br/>}</code></pre><h3 id="the-solution">The solution</h3><p>Here&#x27;s my Underscore-heavy solution for the factory mixin:</p><pre><code class="hljs language-javascript"><span class="hljs-keyword">var</span> Select = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name, opts</span>) </span>{<br/>  <span class="hljs-keyword">return</span> _.object(<br/>    [<br/>      <span class="hljs-string">&quot;getInitialState&quot;</span>,<br/>      <span class="hljs-string">&quot;Select&quot;</span> + name.charAt(<span class="hljs-number">0</span>).toUpperCase() + name.slice(<span class="hljs-number">1</span>)<br/>    ],<br/>    [<br/>      <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{<br/>        <span class="hljs-keyword">return</span> _.object([name], [opts[<span class="hljs-number">0</span>]]);<br/>      },<br/>      <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{<br/>        <span class="hljs-keyword">var</span> me = <span class="hljs-built_in">this</span>;<br/>        <span class="hljs-keyword">return</span> (<br/>          <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span><br/>            <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">display:</span> &quot;<span class="hljs-attr">inline-block</span>&quot; }}<br/>            <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;btn-group clearfix&quot;</span><br/>          &gt;</span><br/>            {_.map(opts, function(g) {<br/>              return (<br/>                <span class="hljs-tag">&lt;<span class="hljs-name">button</span><br/>                  <span class="hljs-attr">onClick</span>=<span class="hljs-string">{function()</span> {<br/>                    <span class="hljs-attr">me.setState</span>(<span class="hljs-attr">_.object</span>([<span class="hljs-attr">name</span>], [<span class="hljs-attr">g</span>]));<br/>                  }}<br/>                  <span class="hljs-attr">className</span>=<span class="hljs-string">{</span><br/>                    &quot;<span class="hljs-attr">btn</span> <span class="hljs-attr">btn-default</span>&quot; + (<span class="hljs-attr">g</span> === <span class="hljs-string">me.state[name]</span> ? &quot; <span class="hljs-attr">active</span>&quot; <span class="hljs-attr">:</span> &quot;&quot;)<br/>                  }<br/>                &gt;</span><br/>                  {g}<br/>                <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br/>              );<br/>            })}<br/>          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br/>        );<br/>      }<br/>    ]<br/>  );<br/>};</code></pre><p>The string dancing up top is to make a better name than <code>renderbar</code> - if the propname is <code>flower</code>, the bar renderer will be <code>SelectFlower</code>.</p><p>Here&#x27;s what <code>Opinion</code> looks like when using this mixin factory:</p><pre><code class="hljs language-javascript"><span class="hljs-keyword">var</span> Opinion = React.createClass({<br/>  <span class="hljs-attr">mixins</span>: [<br/>    Select(<span class="hljs-string">&quot;fruit&quot;</span>, _.keys(fruits)),<br/>    Select(<span class="hljs-string">&quot;vegetable&quot;</span>, _.keys(vegetables))<br/>  ],<br/>  <span class="hljs-attr">render</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{<br/>    <span class="hljs-keyword">return</span> (<br/>      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span><br/>        <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;center-block&quot;</span><br/>        <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">maxWidth:</span> &quot;<span class="hljs-attr">800px</span>;&quot;, <span class="hljs-attr">padding:</span> &quot;<span class="hljs-attr">1em</span>;&quot; }}<br/>      &gt;</span><br/>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br/>          I posit that {this.SelectFruit()} are {fruits[this.state.fruit]}!<br/>        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br/>        <span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span><br/>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br/>          Also {this.SelectVegetable()} are {vegetables[this.state.vegetable]}.<br/>        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br/>      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br/>    );<br/>  }<br/>});</code></pre><p>And voilà - nothing is hanging out of the pants anymore, everything is isolated inside <code>Select</code>. Our goal is achieved!</p><h3 id="final-scare">Final scare</h3><p>But as is always the case, the bad guy suddenly rises again! Happily cleaning up my code with the new mixin factory, my crusade suddenly ground to a halt when I arrived at a case where the options depended on the component properties. Translated to our example it would mean that <code>Opinion</code> was rendered like this:</p><pre><code class="hljs language-javascript">&lt;Opinion vegetables={vegetables} fruits={fruits} /&gt;</code></pre><p>The <code>vegetables</code> and <code>fruits</code> objects are passed as props to <code>Opinion</code> by its parent. Thus inside the <code>Opinion</code> definition we have no idea what the options are, and we can&#x27;t make the call to the mixin factory!</p><h3 id="passing-the-instance">Passing the instance</h3><p>Since we depend on the properties, we can&#x27;t make any call until we have access to them. That smells like we should be doing our thing inside the <code>componentWillMount</code> method - at that point we can access <code>this.props</code>, and the component isn&#x27;t yet rendered. So we should be able to do something like this:</p><pre><code class="hljs language-javascript"><span class="hljs-keyword">var</span> Opinion = React.createClass({<br/>  <span class="hljs-attr">componentWillMount</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{<br/>    SelectSyntax2(<span class="hljs-string">&quot;fruit&quot;</span>, _.keys(<span class="hljs-built_in">this</span>.props.fruits));<br/>    SelectSyntax2(<span class="hljs-string">&quot;vegetables&quot;</span>, _.keys(<span class="hljs-built_in">this</span>.props.vegetables));<br/>  }<br/>  <span class="hljs-comment">// rest redacted</span><br/>});</code></pre><p>Inside <code>SelectSyntax2</code> we must update state to the initial value, and give access to the bar renderer. But hang on, to do that we must access the component instance! Previously we did that through using <code>this</code> inside the various methods, since they became methods on the instance. But that&#x27;s not the case now, and <code>this</code> inside <code>SelectSyntax2</code> points to god knows what!</p><p>Clearly we need to pass the instance into <code>SelectSyntax2</code>, giving us the signature <code>SelectSyntax2(propname,opts,instance)</code>. That would let us do what we need:</p><pre><code class="hljs language-javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SelectSyntax2</span>(<span class="hljs-params">propname, opts, instance</span>) </span>{<br/>  instance.setState(_.object([propname], [opts[<span class="hljs-number">0</span>]]));<br/>  instance.renderbar = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{<br/>    <span class="hljs-keyword">return</span> (<br/>      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">display:</span> &quot;<span class="hljs-attr">inline-block</span>&quot; }} <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;btn-group clearfix&quot;</span>&gt;</span><br/>        {_.map(opts, function(g) {<br/>          var handler = function() {<br/>            instance.setState(_.object([name], [g]));<br/>          };<br/>          var active = g === instance.state[name];<br/>          return (<br/>            <span class="hljs-tag">&lt;<span class="hljs-name">button</span><br/>              <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handler}</span><br/>              <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>&quot;<span class="hljs-attr">btn</span> <span class="hljs-attr">btn-default</span>&quot; + (<span class="hljs-attr">active</span> ? &quot; <span class="hljs-attr">active</span>&quot; <span class="hljs-attr">:</span> &quot;&quot;)}<br/>            &gt;</span><br/>              {g}<br/>            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br/>          );<br/>        })}<br/>      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br/>    );<br/>  };<br/>}</code></pre><h3 id="2-in-1">2 in 1</h3><p>Since the two use cases have different signatures, I opted to only have the one method and make it behave differently depending on whether or not the third argument (the instance) was provided. Here&#x27;s my code:</p><pre><code class="hljs language-javascript"><span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name,opts,instance</span>)</span>{<br/>  <span class="hljs-comment">// allow passing opts as an object, if so make the _.keys call here</span><br/>  <span class="hljs-keyword">var</span> opts = _.isObject(opts) ? _.keys(opts) : opts;<br/>  <span class="hljs-comment">// build good renderer name</span><br/>  <span class="hljs-keyword">var</span> rendername = <span class="hljs-string">&quot;Select&quot;</span>+name.charAt(<span class="hljs-number">0</span>).toUpperCase() + name.slice(<span class="hljs-number">1</span>)<br/>  <span class="hljs-comment">// create the renderer function</span><br/>  <span class="hljs-keyword">var</span> renderer = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{<br/>    <span class="hljs-keyword">var</span> me=<span class="hljs-built_in">this</span>;<br/>    <span class="hljs-keyword">return</span> (<br/>      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{display:</span>&quot;<span class="hljs-attr">inline-block</span>&quot;}} <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;btn-group clearfix&quot;</span>&gt;</span><br/>          {_.map(opts,function(g){<br/>            return <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{function(){</span><br/>              <span class="hljs-attr">me.setState</span>(<span class="hljs-attr">_.object</span>([<span class="hljs-attr">name</span>],[<span class="hljs-attr">g</span>]));<br/>            }} <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>&#x27;<span class="hljs-attr">btn</span> <span class="hljs-attr">btn-default</span>&#x27;+(<span class="hljs-attr">g</span>===<span class="hljs-string">me.state[name]?</span>&#x27; <span class="hljs-attr">active</span>&#x27;<span class="hljs-attr">:</span>&#x27;&#x27;)}&gt;</span>{g}<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br/>          })}<br/>      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br/>    );<br/>  };<br/>  <span class="hljs-comment">// second style syntax, attach renderer and set initial value</span><br/>  <span class="hljs-keyword">if</span> (instance){<br/>    instance[rendername] = renderer;<br/>    instance.setState(_.object([name],[opts[<span class="hljs-number">0</span>]]));<br/>  <span class="hljs-comment">// mixin syntax, return object with getInitialState and renderer</span><br/>  } <span class="hljs-keyword">else</span> {<br/>    <span class="hljs-keyword">return</span> _.object(<br/>      [<span class="hljs-string">&quot;getInitialState&quot;</span>, rendername],<br/>      [<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{<span class="hljs-keyword">return</span> _.object([name],[opts[<span class="hljs-number">0</span>]])}, renderer]<br/>    );<br/>  }<br/>};</code></pre><p>It is actually safe to use <code>this</code> to access the component even in the second syntax, since the renderer will be called as a method on the instance.</p><p>Here&#x27;s the full code for <code>Opinion</code> using the second syntax:</p><pre><code class="hljs language-javascript"><span class="hljs-keyword">var</span> List = React.createClass({<br/>  <span class="hljs-attr">componentWillMount</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{<br/>    Select(<span class="hljs-string">&quot;fruit&quot;</span>, <span class="hljs-built_in">this</span>.props.fruits, <span class="hljs-built_in">this</span>);<br/>    Select(<span class="hljs-string">&quot;vegetable&quot;</span>, <span class="hljs-built_in">this</span>.props.vegetables, <span class="hljs-built_in">this</span>);<br/>  },<br/>  <span class="hljs-attr">render</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{<br/>    <span class="hljs-keyword">return</span> (<br/>      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span><br/>        <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;center-block&quot;</span><br/>        <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">maxWidth:</span> &quot;<span class="hljs-attr">800px</span>;&quot;, <span class="hljs-attr">padding:</span> &quot;<span class="hljs-attr">1em</span>;&quot; }}<br/>      &gt;</span><br/>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br/>          I posit that {this.SelectFruit()} are {fruits[this.state.fruit]}!<br/>        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br/>        <span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span><br/>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br/>          Also {this.SelectVegetable()} are {vegetables[this.state.vegetable]}.<br/>        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br/>      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br/>    );<br/>  }<br/>});</code></pre><h3 id="wrapping-up">Wrapping up</h3><p>As is my habit I took so long detailing the journey that the point risk being lost. The point is this: <strong>Using mixin factories can often be a very powerful way to package concerns together</strong>, especially when you find that using a component forces you to implement cruft methods in the parent.</p><p>Since discovering the pattern I&#x27;ve used it in many different places, and it&#x27;s a tool I&#x27;m particularly happy to have in my belt. I hope you find use for it too!</p></div><hr/></div><div id="disqus_thread" style="display:none"></div></div></div><script id="__NEXT_DATA__" type="application/json">{"dataManager":"[]","props":{"pageProps":{}},"page":"/posts/a-react-encapsulation-pattern","query":{},"buildId":"wQeVqw4-MCmoY2Zy_p65E","dynamicBuildId":false,"nextExport":true}</script><script async="" id="__NEXT_PAGE__/posts/a-react-encapsulation-pattern" src="/_next/static/wQeVqw4-MCmoY2Zy_p65E/pages/posts/a-react-encapsulation-pattern.js"></script><script async="" id="__NEXT_PAGE__/_app" src="/_next/static/wQeVqw4-MCmoY2Zy_p65E/pages/_app.js"></script><script src="/_next/static/runtime/webpack-3df6523e264ff2ac6548.js" async=""></script><script src="/_next/static/chunks/commons.ebbfd942159f83091516.js" async=""></script><script src="/_next/static/runtime/main-c1620565ee9f1f33603c.js" async=""></script><script type="text/javascript" async="" src="https://krawaller.disqus.com/embed.js"></script></body></html>