<!DOCTYPE html><html><head><link rel="stylesheet" type="text/css" href="/static/styles/nprogress.css"/><link rel="stylesheet" href="/static/styles/code.css"/><link rel="stylesheet" href="/static/styles/site.css"/><link href="https://fonts.googleapis.com/css?family=Open+Sans&amp;display=swap" rel="stylesheet"/><link href="https://fonts.googleapis.com/css?family=Lexend+Zetta&amp;display=swap" rel="stylesheet"/><script async="" src="https://www.google-analytics.com/analytics.js"></script><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-11433118-1', 'auto');
  ga("send", "pageview");</script><meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"/><meta charSet="utf-8"/><title>First flirt with impact</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/wQeVqw4-MCmoY2Zy_p65E/pages/posts/first-flirt-with-impact.js" as="script"/><link rel="preload" href="/_next/static/wQeVqw4-MCmoY2Zy_p65E/pages/_app.js" as="script"/><link rel="preload" href="/_next/static/runtime/webpack-3df6523e264ff2ac6548.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.ebbfd942159f83091516.js" as="script"/><link rel="preload" href="/_next/static/runtime/main-c1620565ee9f1f33603c.js" as="script"/></head><body><div id="__next"><div style="margin-bottom:20px"></div><div class="master"><h1><a href="/"><span>k</span><span>r</span><span>a</span><span>w</span><span>a</span><span>l</span><span>l</span><span>e</span><span>r</span></a></h1><hr/><div class="summary">A quick experiment with ImpactJS and Box2D</div><hr/><h2>First flirt with impact</h2><p class="taglist">Tags:<!-- --> <a href="/tags/impactjs/">impactjs</a><a href="/tags/box2d/">box2d</a></p><div class="page-content"><div class="post" data-postid="firstflirtwithimpact"><p>A few weekends ago, I got to shut myself in with my two brothers and a few friends in the Spotify Gothenburg office. Counterstrike, Nerf gun wars, FIFA tournaments and male bonding ensued! Most importantly, we had a night-long hack trying out Impact for the first time. So much fun!!</p><p>As weekends have an unfortunate habit of ending we didn&#x27;t get too far (also the constant temptation of another CS round didn&#x27;t help), but leaving the office we did have a working prototype of a classic (same-computer) multiplayer tank game. We built with Impact and Box2D, a very nice although woefully undocumented marriage.</p><p>Our little game is woefully simple and light years from completion, but with features like respawn, grace, reload time and recoil, it still feels like the start of something!</p><p><img src="/static/posts/first-flirt-with-impact/img/kratank.png" alt="screenshot"/></p><p>Live link <a href="http://krawaller.github.io/kratankpubl/live">here</a>, repo <a href="https://github.com/krawaller/kratankpubl">here</a> (although with minified impact source, as per the license). Only the green tank can actually fire, which gives him an ever so slight advantage...</p><h3 id="code">Code</h3><p>We used the Box2D tutorial <a href="https://www.iforce2d.net/b2dtut/top-down-car">top down car physics</a> as a starting point. It is in java and uses a different Box2D version so it took us a while to get up and running.</p><p>Here&#x27;s a quick rundown of the code in the repo:</p><h4 id="brains">Brains</h4><p>The files that make up the non-impact parts of the game (i.e, what we wrote) is all in the <a href="https://github.com/krawaller/kratankpubl/tree/gh-pages/live/lib/game">live/lib/game</a> folder. This folder contains 3 files:</p><ul><li><a href="https://github.com/krawaller/kratankpubl/blob/gh-pages/live/lib/game/player.js">player.js</a> is our abstraction for a person playing the game (not a tank, but the person controlling the tank). Here we put code for spawning and losing tanks, score, etc.</li><li><a href="https://github.com/krawaller/kratankpubl/blob/gh-pages/live/lib/game/main.js">main.js</a> is the standard Impact entry point. It loads all dependencies, initiates Player objects and makes the spawn a tank each.</li><li><a href="https://github.com/krawaller/kratankpubl/blob/gh-pages/live/lib/game/data.js">data.js</a> is really just a JSON file of settings for tanks and guns. Plan was to extend this object if in the future we add different kinds of tanks, but for now there&#x27;s just the one.</li></ul><h4 id="objects">Objects</h4><p>There are also 5 files in an <a href="https://github.com/krawaller/kratankpubl/tree/gh-pages/live/lib/game/entities">entities</a> folder, who fit together like thus:</p><p><img src="/static/posts/first-flirt-with-impact/img/kratankentities.jpg" alt="diagram"/></p><p>These files do pretty much what you&#x27;d think:</p><ul><li>The <a href="https://github.com/krawaller/kratankpubl/blob/gh-pages/live/lib/game/entities/_baseclass.js">_baseclass.js</a> file contains the basic stuff needed for an entity to exist in the world, setting up collision etc.</li><li><a href="https://github.com/krawaller/kratankpubl/blob/gh-pages/live/lib/game/entities/_playercontrolled.js">_playercontrolled.js</a> sets up controls and ties the entity to a player object. It also contains health bar code, which should probably be abstracted out to a <code>_destructible.js</code> baseclass.</li><li><a href="https://github.com/krawaller/kratankpubl/blob/gh-pages/live/lib/game/entities/tank.js">tank.js</a> are of course the actual tanks. They mostly contain shooting code.</li><li><a href="https://github.com/krawaller/kratankpubl/blob/gh-pages/live/lib/game/entities/projectile.js">projectile.js</a> destroys itself if off screen, and catches collision notification from box2D. If target is a tank (or in the future a <code>_destructible</code>), it deals damage and destroys itself.</li><li><a href="https://github.com/krawaller/kratankpubl/blob/gh-pages/live/lib/game/entities/crate.js">crate.js</a> just sets some initiation stuff such as weight and mass, and then does nothing else.</li></ul><p>The main challenge was deciphering the java code from the tutorial that compensates for lateral velocity:</p><pre><code class="hljs language-java"><span class="hljs-function">b2Vec2 <span class="hljs-title">getLateralVelocity</span><span class="hljs-params">()</span> </span>{<br/>  b2Vec2 currentRightNormal = m_body-&gt;GetWorldVector( b2Vec2(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>) );<br/>  <span class="hljs-keyword">return</span> b2Dot( currentRightNormal, m_body-&gt;GetLinearVelocity() ) * currentRightNormal;<br/>}<br/><br/><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">updateFriction</span><span class="hljs-params">()</span> </span>{<br/>  b2Vec2 impulse = m_body-&gt;GetMass() * -getLateralVelocity();<br/>  m_body-&gt;ApplyAngularImpulse( <span class="hljs-number">0.1f</span> * m_body-&gt;GetInertia() * -m_body-&gt;GetAngularVelocity() );<br/>}</code></pre><p>Here&#x27;s what we ended up with, in case someone wants to make the same java-javascript transition we did:</p><pre><code class="hljs language-javascript">getLateralCounterForce(){<br/>    <span class="hljs-keyword">var</span> vector = <span class="hljs-keyword">new</span> Box2D.Common.Math.b2Vec2(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>),<br/>        currentRightNormal = <span class="hljs-built_in">this</span>.body.GetWorldVector(vector),<br/>        linearVel = <span class="hljs-built_in">this</span>.body.GetLinearVelocity(),<br/>        dot = Box2D.Common.Math.b2Math.Dot(currentRightNormal,linearVel);<br/>    currentRightNormal.Multiply(-dot*<span class="hljs-built_in">this</span>.body.GetMass()*(<span class="hljs-built_in">this</span>.lateralCounterForceFactor||<span class="hljs-number">1</span>));<br/>    <span class="hljs-keyword">return</span> currentRightNormal;<br/>}</code></pre><h3 id="box2d">Box2D</h3><p>Box2D is included as a plugin to Impact. The main hooks into Impact are in <a href="https://github.com/krawaller/kratankpubl/blob/gh-pages/live/lib/plugins/box2d/collision.js">collision.js</a>, a file we had to modify rather heavily to get stuff working the way we wanted.</p></div><hr/></div><div id="disqus_thread" style="display:none"></div></div></div><script id="__NEXT_DATA__" type="application/json">{"dataManager":"[]","props":{"pageProps":{}},"page":"/posts/first-flirt-with-impact","query":{},"buildId":"wQeVqw4-MCmoY2Zy_p65E","dynamicBuildId":false,"nextExport":true}</script><script async="" id="__NEXT_PAGE__/posts/first-flirt-with-impact" src="/_next/static/wQeVqw4-MCmoY2Zy_p65E/pages/posts/first-flirt-with-impact.js"></script><script async="" id="__NEXT_PAGE__/_app" src="/_next/static/wQeVqw4-MCmoY2Zy_p65E/pages/_app.js"></script><script src="/_next/static/runtime/webpack-3df6523e264ff2ac6548.js" async=""></script><script src="/_next/static/chunks/commons.ebbfd942159f83091516.js" async=""></script><script src="/_next/static/runtime/main-c1620565ee9f1f33603c.js" async=""></script><script type="text/javascript" async="" src="https://krawaller.disqus.com/embed.js"></script></body></html>