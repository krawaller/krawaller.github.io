<!DOCTYPE html><html><head><link rel="stylesheet" type="text/css" href="/static/styles/nprogress.css"/><link rel="stylesheet" href="/static/styles/code.css"/><link rel="stylesheet" href="/static/styles/site.css"/><link href="https://fonts.googleapis.com/css?family=Open+Sans&amp;display=swap" rel="stylesheet"/><link href="https://fonts.googleapis.com/css?family=Lexend+Zetta&amp;display=swap" rel="stylesheet"/><script async="" src="https://www.google-analytics.com/analytics.js"></script><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-11433118-1', 'auto');
  ga("send", "pageview");</script><meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"/><meta charSet="utf-8"/><title>Using master templates with Metalsmith</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/wQeVqw4-MCmoY2Zy_p65E/pages/posts/using-master-templates-with-metalsmith.js" as="script"/><link rel="preload" href="/_next/static/wQeVqw4-MCmoY2Zy_p65E/pages/_app.js" as="script"/><link rel="preload" href="/_next/static/runtime/webpack-3df6523e264ff2ac6548.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.ebbfd942159f83091516.js" as="script"/><link rel="preload" href="/_next/static/runtime/main-c1620565ee9f1f33603c.js" as="script"/></head><body><div id="__next"><div style="margin-bottom:20px"></div><div class="master"><h1><a href="/"><span>k</span><span>r</span><span>a</span><span>w</span><span>a</span><span>l</span><span>l</span><span>e</span><span>r</span></a></h1><hr/><div class="summary">How we used our hack of the metalsmith templates plugin to allow master templates</div><hr/><h2>Using master templates with Metalsmith</h2><p class="taglist">Tags:<!-- --> <a href="/tags/metalsmith/">metalsmith</a><a href="/tags/handlebars/">handlebars</a></p><div class="page-content"><div class="post" data-postid="mastertemplate"><h3 id="master-template">Master template</h3><p>Recently I <a href="https://github.com/segmentio/metalsmith-templates/pull/21/files">hacked the metalsmith-templates plugin</a> to support master templates. The idea is that you pass in a <code>master</code> option, naming a master template file in the templates directory. This template will be applied to all files <em>after</em> an eventual file-specific template and/or a default template.</p><p>Here&#x27;s what our call to the templates plugin looks like:</p><pre><code class="hljs language-javascript">.use(templates({<br/>  <span class="hljs-attr">engine</span>: <span class="hljs-string">&#x27;handlebars&#x27;</span>,<br/>  <span class="hljs-attr">directory</span>: <span class="hljs-string">&#x27;./templates&#x27;</span>,<br/>  <span class="hljs-attr">master</span>:<span class="hljs-string">&#x27;master.hbt&#x27;</span>,<br/>  <span class="hljs-attr">pattern</span>: [<span class="hljs-string">&quot;*/*/*html&quot;</span>,<span class="hljs-string">&quot;*html&quot;</span>]<br/>}))</code></pre><p>The <code>contents</code> variable in the master template file will contain the full result of the previous template, or the raw file contents if no previous template has been run. This enabled us to really clean up our page-specific templates (index, post, author, tag, etc), as they no longer needed to deal with headers and footers and the like.</p><h3 id="the-power-of-partials">The power of partials</h3><p>We have a subdirectory in the <code>templates</code> directory named <code>partials</code>. Any file put here will automatically be added as a Handlebars partial through the following loop:</p><pre><code class="hljs language-javascript">_.each(fs.readdirSync(<span class="hljs-string">&#x27;templates/partials&#x27;</span>),<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">file</span>)</span>{<br/>  <span class="hljs-keyword">var</span> name = file.split(<span class="hljs-string">&quot;.&quot;</span>)[<span class="hljs-number">0</span>],<br/>      contents = fs.readFileSync(__dirname+<span class="hljs-string">&quot;/templates/partials/&quot;</span>+file).toString();<br/>  Handlebars.registerPartial(name,contents);<br/>});</code></pre><p>Combined with using a master template, this makes for really skinny page templates! Here&#x27;s the full code for the index page template:</p><pre><code class="hljs language-html">{{#posts}}<br/><br/>{{&gt; listedpost root=true}}<br/><br/>{{/posts}}</code></pre><p>It loops through the <code>posts</code> array, and prints each post using the <code>listedpost</code> partial. Note that we&#x27;re also passing a hash with extra variables which will extend the context, a syntax available since Handlebars 2.</p><p>Here&#x27;s what <code>listedpost</code> looks like:</p><pre><code class="hljs language-html"><span class="hljs-tag">&lt;<span class="hljs-name">article</span>&gt;</span><br/>  {{&gt; posthead root=root}}<br/>  <span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;post-excerpt&quot;</span>&gt;</span><br/>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{excerpt}}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br/>  <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span><br/><span class="hljs-tag">&lt;/<span class="hljs-name">article</span>&gt;</span></code></pre><p>Each markdown post file on our blog contains an <code>excerpt</code> in the YAML front matter, which is what we use when we show a post in a list.</p><p>Here&#x27;s the <code>posthead</code> partial, where we finally have use for the <code>root</code> variable.:</p><pre><code class="hljs language-html"><span class="hljs-tag">&lt;<span class="hljs-name">header</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;post-header&quot;</span>&gt;</span><br/>  <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;post-title&quot;</span>&gt;</span><br/>    <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;{{#unless root}}../../{{/unless}}{{path}}&quot;</span>&gt;</span>{{{title}}}<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br/>    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;post-meta&quot;</span>&gt;</span><br/>      <span class="hljs-tag">&lt;<span class="hljs-name">time</span> <span class="hljs-attr">datetime</span>=<span class="hljs-string">&quot;{{date}}&quot;</span>&gt;</span>{{moment date &#x27;MMM Do YYYY&#x27;}}<span class="hljs-tag">&lt;/<span class="hljs-name">time</span>&gt;</span> <br/>    <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br/>  <span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span><br/>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;tags&#x27;</span>&gt;</span><br/>      By: <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&#x27;{{#unless root}}../../{{/unless}}about/{{toLowerCase author}}&#x27;</span>&gt;</span>{{author}}<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br/>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br/>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;tags&quot;</span>&gt;</span><br/>      Tags:<br/>      {{#tags}}<br/>        <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&#x27;{{#unless ../root}}../../{{/unless}}tags/{{this}}/&#x27;</span>&gt;</span>{{this}}<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br/>      {{/tags}}<br/>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br/><span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span></code></pre><p>This partial is also used in the <code>post.hbt</code> template, hence the need for the <code>root</code> flag as a post-specific file is two levels deeper. Here&#x27;s the <code>post.hbt</code> code, with some boring Disqus stuff removed:</p><pre><code class="hljs language-html"><br/><span class="hljs-tag">&lt;<span class="hljs-name">article</span>&gt;</span><br/><br/>  {{&gt; posthead}}<br/><br/>  <span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;post-content&#x27;</span>&gt;</span><br/>  {{{contents}}}<br/>  <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span><br/><br/>  <span class="hljs-comment">&lt;!-- Disqus code redacted ---&gt;</span><br/><br/><span class="hljs-tag">&lt;/<span class="hljs-name">article</span>&gt;</span>  </code></pre><h3 id="page-types">Page types</h3><p>To centralize control over template usage, and allow for some further shortcuts in the templates, we invented the notion of page types. In all markdown files to be processed, instead of naming templates, we have a <code>type</code> variable in the YAML front matter. So far, type can be <code>post</code>, <code>author</code>, <code>index</code>, <code>tag</code> or <code>taglist</code>. For example, here&#x27;s the YAML for this very post:</p><pre><code class="hljs language-yaml"><span class="hljs-attr">title:</span> <span class="hljs-string">Using</span> <span class="hljs-string">master</span> <span class="hljs-string">templates</span> <span class="hljs-string">with</span> <span class="hljs-string">Metalsmith</span><br/><span class="hljs-attr">author:</span> <span class="hljs-string">David</span><br/><span class="hljs-attr">tags:</span> [<span class="hljs-string">metalsmith</span>,<span class="hljs-string">handlebars</span>]<br/><span class="hljs-attr">date:</span> <span class="hljs-number">2014-08-21</span><br/><span class="hljs-attr">excerpt:</span> <span class="hljs-string">How</span> <span class="hljs-string">we</span> <span class="hljs-string">used</span> <span class="hljs-string">our</span> <span class="hljs-string">hack</span> <span class="hljs-string">of</span> <span class="hljs-string">the</span> <span class="hljs-string">metalsmith</span> <span class="hljs-string">templates</span> <span class="hljs-string">plugin</span> <span class="hljs-string">to</span> <span class="hljs-string">allow</span> <span class="hljs-string">master</span> <span class="hljs-string">templates</span><br/><span class="hljs-attr">type:</span> <span class="hljs-string">post</span></code></pre><p>We use the <code>type</code> variable through a mini Metalsmith plugin running all files through the following <code>map</code>:</p><pre><code class="hljs language-javascript">.use(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">files,metalsmith,done</span>)</span>{<br/>  _.map(files,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">file</span>)</span>{<br/>    <span class="hljs-keyword">return</span> file.type ? _.extend(file,{<span class="hljs-attr">template</span>:file.type+<span class="hljs-string">&quot;.hbt&quot;</span>},_.object([<span class="hljs-string">&quot;is&quot;</span>+file.type],[<span class="hljs-literal">true</span>])) : file;<br/>  });<br/>  done();<br/>})</code></pre><p>Now a file with <code>type</code> set to <code>post</code> will have a <code>template</code> and <code>ispost</code> variable added like thus:</p><pre><code class="hljs language-yaml"><span class="hljs-attr">type:</span> <span class="hljs-string">post</span><br/><span class="hljs-attr">template:</span> <span class="hljs-string">post.hbt</span><br/><span class="hljs-attr">ispost:</span> <span class="hljs-literal">true</span></code></pre><p>This means that should we change templating tactics, we don&#x27;t need to update all individual files, instead we can simply add some logic to our mini plugin loop.</p><p>The last thing added in the example above, <code>ispost: true</code>, allows us to simplify doing post-specific stuff in the Handlebars templates. Testing for equality in Handlebars is <a href="http://stackoverflow.com/questions/8853396/logical-operator-in-a-handlebars-js-if-conditional">complicated</a>, but testing truthiness is easy, which is why the <code>ispost</code> type variables are useful. As an example, here&#x27;s a snippet from the master template:</p><pre><code class="hljs language-html">{{#if isindex}}<br/>  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;stylesheet&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;css/theme.css&quot;</span>/&gt;</span><br/>{{else}}<br/>  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;stylesheet&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;../../css/highlight.css&quot;</span>&gt;</span><br/>  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;stylesheet&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;../../css/theme.css&quot;</span>/&gt;</span><br/>{{/if}}</code></pre></div><hr/></div><div id="disqus_thread" style="display:none"></div></div></div><script id="__NEXT_DATA__" type="application/json">{"dataManager":"[]","props":{"pageProps":{}},"page":"/posts/using-master-templates-with-metalsmith","query":{},"buildId":"wQeVqw4-MCmoY2Zy_p65E","dynamicBuildId":false,"nextExport":true}</script><script async="" id="__NEXT_PAGE__/posts/using-master-templates-with-metalsmith" src="/_next/static/wQeVqw4-MCmoY2Zy_p65E/pages/posts/using-master-templates-with-metalsmith.js"></script><script async="" id="__NEXT_PAGE__/_app" src="/_next/static/wQeVqw4-MCmoY2Zy_p65E/pages/_app.js"></script><script src="/_next/static/runtime/webpack-3df6523e264ff2ac6548.js" async=""></script><script src="/_next/static/chunks/commons.ebbfd942159f83091516.js" async=""></script><script src="/_next/static/runtime/main-c1620565ee9f1f33603c.js" async=""></script><script type="text/javascript" async="" src="https://krawaller.disqus.com/embed.js"></script></body></html>