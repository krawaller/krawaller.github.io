<!DOCTYPE html><html><head><link rel="stylesheet" type="text/css" href="/static/styles/nprogress.css"/><link rel="stylesheet" href="/static/styles/code.css"/><link rel="stylesheet" href="/static/styles/site.css"/><link href="https://fonts.googleapis.com/css?family=Open+Sans&amp;display=swap" rel="stylesheet"/><link href="https://fonts.googleapis.com/css?family=Lexend+Zetta&amp;display=swap" rel="stylesheet"/><script async="" src="https://www.google-analytics.com/analytics.js"></script><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-11433118-1', 'auto');
  ga("send", "pageview");</script><meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"/><meta charSet="utf-8"/><title>A Redux-TypeScript setup</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/wQeVqw4-MCmoY2Zy_p65E/pages/posts/a-redux-typescript-setup.js" as="script"/><link rel="preload" href="/_next/static/wQeVqw4-MCmoY2Zy_p65E/pages/_app.js" as="script"/><link rel="preload" href="/_next/static/runtime/webpack-3df6523e264ff2ac6548.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.ebbfd942159f83091516.js" as="script"/><link rel="preload" href="/_next/static/runtime/main-c1620565ee9f1f33603c.js" as="script"/></head><body><div id="__next"><div style="margin-bottom:20px"></div><div class="master"><h1><a href="/"><span>k</span><span>r</span><span>a</span><span>w</span><span>a</span><span>l</span><span>l</span><span>e</span><span>r</span></a></h1><hr/><div class="summary">Walking through a Redux-TypeScript scaffold, set up for maximal in-editor help from minimal typing</div><hr/><h2>A Redux-TypeScript setup</h2><p class="taglist">Tags:<!-- --> <a href="/tags/redux/">redux</a><a href="/tags/typescript/">typescript</a></p><div class="page-content"><div class="post" data-postid="reduxtypescript"><h3 id="the-premise">The premise</h3><p>This post will explore a Redux TypeScript setup, using a tiny project as an example. My intention was to use this as a starting point whenever I start a new project, which so far has worked very well.</p><p>Apart from Redux we&#x27;ll also use <code>redux-actions</code> and <code>redux-thunk</code>.</p><p>There&#x27;s also a React part to this project, but I&#x27;ll leave exploring that to an upcoming post. This one will revolve solely around TypeScript and Redux.</p><h3 id="the-scaffold-state">The scaffold state</h3><p>Here&#x27;s the <code>AppState</code> for my little example project:</p><pre><code class="hljs language-typescript"><span class="hljs-keyword">type</span> AppState = {<br/>  messaging: MessagingState;<br/>  <span class="hljs-comment">/* ...imagine other domains here... */</span><br/>};</code></pre><p>Normally an app state would of course contain lots of top-level keys, but here I just have <code>messaging</code>, meant to deal with app-wide feedback to the user. While skinny, this will still be enough to get the TypeScript setup points across.</p><p><code>MessagingState</code> looks like this:</p><pre><code class="hljs language-typescript"><span class="hljs-keyword">type</span> MessagingState = {<br/>  lastMessage: <span class="hljs-built_in">number</span>;<br/>  messages: UIMessage[];<br/>};</code></pre><p>In other words, <code>appState.messaging.messages</code> is an array of <code>UIMessage</code> feedback items. They look like this...</p><pre><code class="hljs language-typescript"><span class="hljs-keyword">type</span> UIMessage = {<br/>  id: <span class="hljs-built_in">number</span>;<br/>  text: <span class="hljs-built_in">string</span>;<br/>  <span class="hljs-keyword">type</span>: UIMessageType;<br/>};</code></pre><p>...and <code>UIMessageType</code> is simply an enum:</p><pre><code class="hljs language-typescript"><span class="hljs-keyword">type</span> UIMessageType = <span class="hljs-string">&#x27;info&#x27;</span> | <span class="hljs-string">&#x27;success&#x27;</span> | <span class="hljs-string">&#x27;error&#x27;</span>;</code></pre><p>The <code>lastMessage</code> part of <code>MessagingState</code> is used to create the ID for new messages, as well as fetching a reference to the last one. Normally I&#x27;d do that as a computed property with <a href="https://github.com/reactjs/reselect">Reselect</a>, but I didn&#x27;t want to muddy the waters too much here.</p><p>Finally we make an <code>initialState</code> to seed our store with, containing a welcoming UI message:</p><pre><code class="hljs language-typescript"><span class="hljs-keyword">const</span> initialState: AppState = {<br/>  messaging: {<br/>    messages: [{<span class="hljs-keyword">type</span>: <span class="hljs-string">&#x27;info&#x27;</span>, text: <span class="hljs-string">&#x27;Welcome!&#x27;</span>, id: <span class="hljs-number">1</span>}],<br/>    lastMessage: <span class="hljs-number">1</span><br/>  }<br/>};</code></pre><h3 id="action-creators">Action creators</h3><p>I wanted to use <a href="https://github.com/acdlite/redux-actions">Redux-Actions</a>, a pretty neat helper library to reduce boilerplate. Make sure to also get the <a href="https://github.com/DefinitelyTyped/DefinitelyTyped/blob/master/types/redux-actions/index.d.ts">typings</a> (<code>@types/redux-actions</code>).</p><p><code>ReduxActions</code> uses the <a href="https://github.com/acdlite/flux-standard-action">Flux Standard Action</a> format, meaning an action looks like this:</p><pre><code class="hljs language-typescript"><span class="hljs-keyword">interface</span> Action&lt;Payload&gt; {<br/>  <span class="hljs-keyword">type</span>: <span class="hljs-built_in">string</span>;<br/>  payload?: Payload;<br/>  error?: <span class="hljs-built_in">boolean</span>;<br/>}</code></pre><p>In other words, eventual data passed with the action should go in the <code>payload</code> prop. The advantage of that is that we can simplify the API of action creators, as has been done in <code>ReduxActions</code> with the <code>createAction</code> helper.</p><p>In my simple scaffolding app there are only two possible actions; <strong>adding a message</strong> and <strong>removing a message</strong>.</p><p>Here&#x27;s <code>addUIMessage(text, type)</code>:</p><pre><code class="hljs language-typescript"><span class="hljs-keyword">type</span> addUIMessagePayload = {<br/>  text: <span class="hljs-built_in">string</span>;<br/>  <span class="hljs-keyword">type</span>: UIMessageType;<br/>};<br/><span class="hljs-keyword">const</span> addUIMessage = createAction&lt;addUIMessagePayload, <span class="hljs-built_in">string</span>, UIMessageType&gt;(<br/>  ADD_UI_MESSAGE, <span class="hljs-function">(<span class="hljs-params">text, <span class="hljs-keyword">type</span></span>) =&gt;</span> ({text, <span class="hljs-keyword">type</span>})<br/>);</code></pre><p>The <code>ADD_UI_MESSAGE</code> variable is merely a constant with the string, presumably imported from a <code>constants</code> file.</p><p>The signature of <code>createAction</code> looks like this:</p><pre><code class="hljs language-typescript">createAction&lt;TPayload, TArg1, TArg2, ...&gt;<span class="hljs-function">(<span class="hljs-params"><br/>  STRINGCONSTANT, arg1, arg2, ...<br/></span>) =&gt;</span> TPayload</code></pre><p>Note how the creator just needs to return the payload, not the full action object.</p><p>We <code>dismissUIMessage(id)</code> like this:</p><pre><code class="hljs language-typescript"><span class="hljs-keyword">type</span> dismissUIMessagePayload = <span class="hljs-built_in">number</span>;<br/><span class="hljs-keyword">const</span> dismissUIMessage = createAction&lt;dismissUIMessagePayload, <span class="hljs-built_in">number</span>&gt;(<br/>  DISMISS_UI_MESSAGE, <span class="hljs-function"><span class="hljs-params">id</span> =&gt;</span> id<br/>);</code></pre><p>Here the payload is just the id of the message to dismiss.</p><p>The <code>createAction</code> helper also does another clever thing - it sets up the <code>.toString</code> method on the creator to return the action string type. In other words:</p><pre><code class="hljs language-typescript">dismissUIMessage.toString() <span class="hljs-comment">// DISMISS_UI_MESSAGE</span></code></pre><p>We&#x27;ll utilise this fact later on.</p><h3 id="thunk-actions">Thunk actions</h3><p>What about creating thunks to work with the <a href="https://github.com/gaearon/redux-thunk">ReduxThunk</a> middleware? Say we want to add a third action creator, <code>addTempUIMessage(text, type)</code>, which adds a message that dismisses itself after a few seconds. Implementing it is easy enough, but how do we get type support?</p><p>Here&#x27;s what it looks like with the official <a href="https://github.com/gaearon/redux-thunk/blob/master/index.d.ts">ReduxThunk typings</a> (bundled with the library so no <code>@types</code> required):</p><pre><code class="hljs"><span class="hljs-keyword">import</span> { ThunkAction } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;redux-thunk&#x27;</span>;<br/><br/><span class="hljs-keyword">const</span> addTempUIMessage = <br/>  (text: <span class="hljs-built_in">string</span>, <span class="hljs-keyword">type</span>: UIMessageType): ThunkAction&lt;<span class="hljs-literal">null</span>, IState, <span class="hljs-literal">null</span>&gt; =&gt;<br/>    <span class="hljs-function">(<span class="hljs-params">dispatch, getState</span>) =&gt;</span> {<br/>      dispatch(addUIMessage(text, <span class="hljs-keyword">type</span>));<br/>      <span class="hljs-keyword">let</span> id = getState().messaging.lastMessage;<br/>      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> dispatch(dismissUIMessage(id)), <span class="hljs-number">2000</span>);<br/>    };</code></pre><p>Under the hood <code>ThunkAction</code> uses the <a href="https://github.com/reactjs/redux/blob/master/index.d.ts">official Redux typings</a>, which also comes bundled.</p><p>The <code>ThunkAction</code> gets <code>&lt;ReturnVal, AppState, ExtraAPI&gt;</code> passed in. Some like to have <code>ReturnVal</code> be a promise, and <code>ExtraAPI</code> deals with the <a href="https://twitter.com/dan_abramov/status/730053481919303685">new <code>thunk.withExtraArgument(api)</code> feature</a> added last year.</p><p>The main win from using <code>ThunkAction</code> is that it will correctly type <code>dispatch</code>, <code>getState</code> and the return value of <code>getState</code>:</p><p><img src="/static/posts/a-redux-typescript-setup/img/rearedtyp_thunk.png" alt=""/></p><p>I had good help of the discussion in <a href="https://github.com/gaearon/redux-thunk/issues/103">this <code>redux-thunk</code> issue</a> when wrapping my brain around this.</p><p>Since it is likely my thunk creators will all look the same, I set up an app-specific helper type...</p><pre><code class="hljs"><span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">Thunk</span> </span>= ThunkAction&lt;<span class="hljs-keyword">void</span>, AppState, <span class="hljs-keyword">void</span>&gt;;</code></pre><p>...which makes the code prettier still:</p><pre><code class="hljs"><span class="hljs-keyword">const</span> addTempUIMessage = <br/>  (text: <span class="hljs-built_in">string</span>, <span class="hljs-keyword">type</span>: UIMessageType): <span class="hljs-function"><span class="hljs-params">Thunk</span> =&gt;</span><br/>    <span class="hljs-comment">// ...rest same as before</span></code></pre><h3 id="reducer">Reducer</h3><p>We build our top-level reducer by combining subreducers for each domain as usual:</p><pre><code class="hljs language-typescript"><span class="hljs-keyword">import</span> { combineReducers } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;redux&#x27;</span>;<br/><span class="hljs-keyword">const</span> reducer = combineReducers&lt;AppState&gt;({<br/>  messaging: messagingReducer,<br/>  <span class="hljs-comment">// ...imagine lots more reducers here...</span><br/>});</code></pre><p>Note how the Redux typings let us pass our <code>AppState</code> type to <code>combineReducers</code>.</p><p>So how are the individual reducers constructed? In bare-bones Redux we simply make a pure function with a big <code>switch</code> statement. <code>ReduxActions</code> however has a <code>handleActions</code> helper that makes for less cruft. Here&#x27;s how we can use that to make a reducer dealing with the two message-related actions:</p><pre><code class="hljs language-typescript"><span class="hljs-keyword">const</span> messagingReducer = handleActions&lt;MessagingState&gt;(<br/>  {<br/>    [addUIMessage.toString()]: (state, action: Action&lt;addUIMessagePayload&gt;): <span class="hljs-function"><span class="hljs-params">MessagingState</span> =&gt;</span> ({<br/>      nextId: state.nextId + <span class="hljs-number">1</span>,<br/>      messages: [{...action.payload, id: state.nextId}].concat(state.messages)<br/>    }),<br/>    [dismissUIMessage.toString()]: (state, action: Action&lt;dismissUIMessagePayload&gt;): <span class="hljs-function"><span class="hljs-params">MessagingState</span> =&gt;</span> ({<br/>      ...state,<br/>      messages: state.messages.filter(<span class="hljs-function"><span class="hljs-params">m</span> =&gt;</span> m.id !== action.payload)<br/>    })<br/>  },<br/>  initialState.messaging<br/>);</code></pre><p>Note how we use the <code>.toString</code> of the action creators, saving us from having to import the constants.</p><p>And through the <code>Action&lt;actionCreatorPayload&gt;</code> typing we get the correct type for <code>action.payload</code> inside the handler:</p><p><img src="/static/posts/a-redux-typescript-setup/img/rearedtyp_reducer1.png" alt=""/></p><p>This is kind of neat, but there are still two drawbacks here:</p><ul><li>The typings don&#x27;t cascade, we have to add <code>MessagingState</code> at the top and at every individual handler</li><li>We have to reference the action creators in both the key and the value, leaving room for mismatches.</li></ul><p>The first point is discussed in <a href="https://github.com/acdlite/redux-actions/issues/84">this ReduxActions PR</a>, where <a href="https://github.com/leonyu">Leon Yu</a> explains that the dictionary form prevents type cascade. He then suggests a builder-like solution, which also happens to solve the second point!</p><p>Here&#x27;s how my implementation of his idea is used:</p><pre><code class="hljs language-typescript"><span class="hljs-keyword">const</span> messagingReducer = buildReducer&lt;MessagingState&gt;()<br/>  .handle(addUIMessage, <span class="hljs-function">(<span class="hljs-params">state, action</span>) =&gt;</span> ({<br/>    lastMessage: state.lastMessage + <span class="hljs-number">1</span>,<br/>    messages: [{...action.payload, id: state.lastMessage + <span class="hljs-number">1</span>}].concat(state.messages)<br/>  }))<br/>  .handle(dismissUIMessage, <span class="hljs-function">(<span class="hljs-params">state, action</span>) =&gt;</span> ({<br/>    ...state,<br/>    messages: state.messages.filter(<span class="hljs-function"><span class="hljs-params">m</span> =&gt;</span> m.id !== action.payload)<br/>  }))<br/>  .done();</code></pre><p>Far fewer typings (we don&#x27;t even need to import the action payload types!), no room to connect the wrong handler with the wrong type, and still full support for state, payload and return type:</p><p><img src="/static/posts/a-redux-typescript-setup/img/rearedtyp_reducer2.png" alt=""/></p><p>Granted, having to call <code>.done()</code> at the end might feel a bit boilerplaty, but I still much prefer this helper to the <code>handleActions</code> one from <code>ReduxActions</code> shown earlier.</p><p>Here&#x27;s the source code for the <code>buildReducer</code> helper:</p><pre><code class="hljs language-typescript"><span class="hljs-keyword">import</span> { Reducer, Action } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;redux-actions&#x27;</span>;<br/><span class="hljs-keyword">import</span> { ActionCreator } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;redux&#x27;</span>;<br/><br/><span class="hljs-keyword">type</span> builderObject&lt;TState&gt; = {<br/>  handle: &lt;TPayload&gt;<span class="hljs-function">(<span class="hljs-params"><br/>    creator: ActionCreator&lt;Action&lt;TPayload&gt;&gt;,<br/>    reducer: Reducer&lt;TState, TPayload&gt;<br/>  </span>) =&gt;</span> builderObject&lt;TState&gt;,<br/>  done: <span class="hljs-function">() =&gt;</span> Reducer&lt;TState, Action&lt;<span class="hljs-built_in">any</span>&gt;&gt;<br/>};<br/><br/><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">buildReducer</span>&lt;<span class="hljs-title">TState</span>&gt;(<span class="hljs-params"></span>): <span class="hljs-title">builderObject</span>&lt;<span class="hljs-title">TState</span>&gt; </span>{<br/>  <span class="hljs-keyword">let</span> map: { [action: <span class="hljs-built_in">string</span>]: Reducer&lt;TState, <span class="hljs-built_in">any</span>&gt;; } = {};<br/>  <span class="hljs-keyword">return</span> {<br/>    handle(creator, reducer) {<br/>      <span class="hljs-keyword">const</span> <span class="hljs-keyword">type</span> = creator.toString();<br/>      <span class="hljs-keyword">if</span> (map[<span class="hljs-keyword">type</span>]) {<br/>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span> (<span class="hljs-string">`Already handling an action with type <span class="hljs-subst">${<span class="hljs-keyword">type</span>}</span>`</span>);<br/>      }<br/>      map[<span class="hljs-keyword">type</span>] = reducer;<br/>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br/>    },<br/>    done() {<br/>      <span class="hljs-keyword">const</span> mapClone = <span class="hljs-built_in">Object</span>.assign({}, map);<br/>      <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">state: TState = {} <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>, action: Action&lt;<span class="hljs-built_in">any</span>&gt;</span>) =&gt;</span> {<br/>        <span class="hljs-keyword">let</span> handler = mapClone[action.type];<br/>        <span class="hljs-keyword">return</span> handler ? handler(state, action) : state;<br/>      };<br/>    }<br/>  };<br/>}</code></pre><h3 id="the-store">The store</h3><p>If we just create the store directly with <code>createStore</code>, the type will be inferred from the reducer (even if we didn&#x27;t have initial state):</p><p><img src="/static/posts/a-redux-typescript-setup/img/rearedtyp_store.png" alt=""/></p><p>When using an enhancer such as created by <code>applyMiddleware</code>, we must type the variable ourselves:</p><pre><code class="hljs">const store: Store&lt;AppState&gt; = apply<span class="hljs-constructor">Middleware(<span class="hljs-params">thunk</span>, <span class="hljs-params">logger</span>)</span>(createStore)(reducer, initialState);</code></pre><p>But since that&#x27;s only ever done once, that isn&#x27;t really an issue.</p><p>As for the middlewares themselves, Redux has a <code>MiddlewareAPI&lt;S&gt;</code> typing. So with a tiny app-specific helper type...</p><pre><code class="hljs"><span class="hljs-keyword">type</span> <span class="hljs-type">API </span>= MiddlewareAPI&lt;AppState&gt;;</code></pre><p>...we can type the middlewares:</p><pre><code class="hljs"><span class="hljs-keyword">import</span> {  }<br/><span class="hljs-keyword">const</span> logger = <span class="hljs-function">(<span class="hljs-params">api: API</span>) =&gt;</span> <span class="hljs-function"><span class="hljs-params">next</span> =&gt;</span> <span class="hljs-function"><span class="hljs-params">action</span> =&gt;</span> {<br/>  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;dispatching&#x27;</span>, action.type, action);<br/>  <span class="hljs-keyword">let</span> result = next(action);<br/>  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;next state&#x27;</span>, api.getState());<br/>  <span class="hljs-keyword">return</span> result;<br/>};</code></pre><h3 id="wrapping-up">Wrapping up</h3><p>I&#x27;m pretty happy with this setup - not much typings necessary, but I still get full TypeScript support throughout.</p><p>There are some itches I&#x27;d like to scratch further. For example, having to feed the action creator argument types up top to <code>createAction</code> is a bit iffy:</p><pre><code class="hljs language-typescript"><span class="hljs-keyword">const</span> addUIMessage = createAction&lt;addUIMessagePayload, <span class="hljs-built_in">string</span>, UIMessageType&gt;(<br/>  ADD_UI_MESSAGE, <span class="hljs-function">(<span class="hljs-params">text, <span class="hljs-keyword">type</span></span>) =&gt;</span> ({text, <span class="hljs-keyword">type</span>})<br/>);</code></pre><p>I would much prefer to do this:</p><pre><code class="hljs language-typescript"><span class="hljs-keyword">const</span> addUIMessage = createAction&lt;addUIMessagePayload&gt;(<br/>  ADD_UI_MESSAGE, <span class="hljs-function">(<span class="hljs-params">text: <span class="hljs-built_in">string</span>, <span class="hljs-keyword">type</span>: UIMessageType</span>) =&gt;</span> ({text, <span class="hljs-keyword">type</span>})<br/>);</code></pre><p>This should be doable, I need to explore further.</p><p>Also I&#x27;m looking at exposing the actions on the store instance instead of having a <code>dispatch</code> function and a separate <code>action</code> object. Why let the user ever dispatch anything except what is born from an action creator?</p><p>Finally the <code>Middleware</code> typings are lacking. I&#x27;d like to do something like this up top:</p><pre><code class="hljs"><span class="hljs-keyword">const</span> logger: Middleware&lt;AppState&gt; = <span class="hljs-comment">// ...</span></code></pre><p>...and just have everything below it, including <code>next</code> and <code>action</code>, be correctly inferred. But as middlewares are few and one-off, setting that up isn&#x27;t really a priority.</p><p>Anyhow - I hope this setup is of use to you too, and if you have any feedback, please do comment or reach out! </p><p>And as initially stated, I&#x27;ll detail the React parts of my setup in an upcoming post.</p></div><hr/></div><div id="disqus_thread" style="display:none"></div></div></div><script id="__NEXT_DATA__" type="application/json">{"dataManager":"[]","props":{"pageProps":{}},"page":"/posts/a-redux-typescript-setup","query":{},"buildId":"wQeVqw4-MCmoY2Zy_p65E","dynamicBuildId":false,"nextExport":true}</script><script async="" id="__NEXT_PAGE__/posts/a-redux-typescript-setup" src="/_next/static/wQeVqw4-MCmoY2Zy_p65E/pages/posts/a-redux-typescript-setup.js"></script><script async="" id="__NEXT_PAGE__/_app" src="/_next/static/wQeVqw4-MCmoY2Zy_p65E/pages/_app.js"></script><script src="/_next/static/runtime/webpack-3df6523e264ff2ac6548.js" async=""></script><script src="/_next/static/chunks/commons.ebbfd942159f83091516.js" async=""></script><script src="/_next/static/runtime/main-c1620565ee9f1f33603c.js" async=""></script><script type="text/javascript" async="" src="https://krawaller.disqus.com/embed.js"></script></body></html>